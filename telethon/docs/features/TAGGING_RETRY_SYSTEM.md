# üîÑ –°–∏—Å—Ç–µ–º–∞ Retry –¥–ª—è –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–∫—Ç–∏–≤–Ω–æ

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–≥–æ–≤ –¥–ª—è –ø–æ—Å—Ç–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏. –í–∫–ª—é—á–∞–µ—Ç:
- **Retry –º–µ—Ö–∞–Ω–∏–∑–º** —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **Fallback –º–æ–¥–µ–ª–∏** OpenRouter
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞** —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **API endpoints** –¥–ª—è —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞** –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

OpenRouter API –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ (502, 503, 504) –∏–∑-–∑–∞:
- –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∏ upstream –º–æ–¥–µ–ª–∏
- –°–µ—Ç–µ–≤—ã—Ö –ø—Ä–æ–±–ª–µ–º
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏
- Rate limiting

–ë–µ–∑ retry —Å–∏—Å—Ç–µ–º—ã —Ç–∞–∫–∏–µ –ø–æ—Å—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ —Ç–µ–≥–æ–≤ –Ω–∞–≤—Å–µ–≥–¥–∞.

## ‚ú® –†–µ—à–µ–Ω–∏–µ

### 1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤ –ë–î

–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è –≤ –º–æ–¥–µ–ª—å `Post`:

```python
tagging_status = "pending"        # pending, success, failed, retrying, skipped
tagging_attempts = 0              # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
last_tagging_attempt = None       # –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏
tagging_error = None              # –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏
```

**–°—Ç–∞—Ç—É—Å—ã:**
- `pending` - –æ–∂–∏–¥–∞–µ—Ç —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (–ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞)
- `success` - —Ç–µ–≥–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
- `failed` - –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫
- `retrying` - –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞, –±—É–¥–µ—Ç retry
- `skipped` - –ø–æ—Å—Ç –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è

### 2. Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π

```python
# –ü—Ä–∏ –æ—à–∏–±–∫–µ API:
if retry_count < max_retries:
    delay = retry_delay * (2 ** retry_count)  # 2s, 4s, 8s...
    await asyncio.sleep(delay)
    return await generate_tags_for_text(text, retry_count + 1)
```

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
```env
TAGGING_MAX_RETRIES=3         # Retry –ø—Ä–∏ 5xx –æ—à–∏–±–∫–∞—Ö
TAGGING_RETRY_DELAY=2.0       # –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
TAGGING_MAX_ATTEMPTS=5        # –û–±—â–∏–π –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –ø–æ—Å—Ç–∞
```

### 3. Fallback –º–æ–¥–µ–ª–∏

–ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ retry –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥–µ–ª–∏, —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–±—É–µ—Ç fallback –º–æ–¥–µ–ª–∏:

```python
fallback_models = [
    "google/gemini-2.0-flash-exp:free",      # –û—Å–Ω–æ–≤–Ω–∞—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    "meta-llama/llama-3.2-3b-instruct:free", # Fallback #1
    "qwen/qwen-2-7b-instruct:free",          # Fallback #2
    "google/gemma-2-9b-it:free"              # Fallback #3
]
```

**–õ–æ–≥–∏–∫–∞:**
1. –ü–æ–ø—ã—Ç–∫–∞ 1-3: –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å (`OPENROUTER_MODEL`)
2. –ü–æ–ø—ã—Ç–∫–∞ 4: Fallback –º–æ–¥–µ–ª—å #1
3. –ü–æ–ø—ã—Ç–∫–∞ 5: Fallback –º–æ–¥–µ–ª—å #2
4. –ü–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫: —Å—Ç–∞—Ç—É—Å `failed`

### 4. API Endpoints

#### GET `/users/{user_id}/posts/tagging_stats`

–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:

```bash
curl http://localhost:8010/users/1/posts/tagging_stats
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "user_id": 1,
  "total_posts": 150,
  "posts_with_tags": 140,
  "posts_without_tags": 10,
  "posts_need_retry": 5,
  "stats_by_status": {
    "pending": 3,
    "success": 140,
    "failed": 2,
    "retrying": 5,
    "skipped": 0
  },
  "tagging_enabled": true,
  "max_retry_attempts": 5
}
```

#### POST `/users/{user_id}/posts/retry_tagging`

–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ –¥–ª—è –ø–æ—Å—Ç–æ–≤ —Å –æ—à–∏–±–∫–∞–º–∏:

```bash
# –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–≤—à–∏–µ –ª–∏–º–∏—Ç)
curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?limit=50"

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (–¥–∞–∂–µ –¥–ª—è –ø—Ä–µ–≤—ã—Å–∏–≤—à–∏—Ö –ª–∏–º–∏—Ç)
curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?force=true&limit=50"
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `force` (bool, default=false) - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π retry –¥–∞–∂–µ –¥–ª—è `failed` –ø–æ—Å—Ç–æ–≤
- `limit` (int, default=50) - –º–∞–∫—Å–∏–º—É–º –ø–æ—Å—Ç–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–û—Ç–≤–µ—Ç:**
```json
{
  "user_id": 1,
  "status": "completed",
  "force_mode": false,
  "processed_limit": 50,
  "stats_after_retry": {
    "pending": 0,
    "success": 145,
    "failed": 2,
    "retrying": 3
  },
  "message": "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
}
```

#### POST `/posts/{post_id}/regenerate_tags`

–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞:

```bash
curl -X POST http://localhost:8010/posts/391/regenerate_tags
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "post_id": 391,
  "success": true,
  "tags": ["–∑–æ–ª–æ—Ç–æ", "–∏–Ω—Ñ–ª—è—Ü–∏—è", "—ç–∫–æ–Ω–æ–º–∏–∫–∞"],
  "tagging_status": "success",
  "tagging_attempts": 2,
  "last_tagging_attempt": "2025-10-11T10:30:00Z",
  "tagging_error": null
}
```

### ‚ö° Background Processing

**–í—Å–µ retry endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ —á–µ—Ä–µ–∑ FastAPI BackgroundTasks:**

- POST `/users/{user_id}/posts/retry_tagging` - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ
- POST `/posts/{post_id}/regenerate_tags` - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ —Ñ–æ–Ω–µ

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ API endpoint –æ—Ç–≤–µ—á–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (< 100ms)
- ‚úÖ Retry –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (Celery, Redis)

**–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:**
```json
{
  "status": "queued",
  "message": "–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ –∑–∞–ø—É—â–µ–Ω–∞ –≤ —Ñ–æ–Ω–µ"
}
```

**–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ retry
curl http://localhost:8010/users/{user_id}/posts/tagging_stats
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏** –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å –≤:
- –õ–æ–≥–∞—Ö: `docker logs -f telethon | grep TaggingService`
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ: `GET /users/{user_id}/posts/tagging_stats`
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø–æ—Å—Ç–µ: `GET /posts/{post_id}`

## üîÑ Workflow

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å

```
–ù–æ–≤—ã–π –ø–æ—Å—Ç –ø–∞—Ä—Å–∏—Ç—Å—è
    ‚Üì
tagging_status = "pending"
tagging_attempts = 0
    ‚Üì
–ü–æ–ø—ã—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–≥–æ–≤
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –£—Å–ø–µ—Ö ‚úÖ      ‚îÇ   –û—à–∏–±–∫–∞ ‚ùå        ‚îÇ
‚îÇ                 ‚îÇ                    ‚îÇ
‚îÇ status=success  ‚îÇ attempts++         ‚îÇ
‚îÇ tags=[...]      ‚îÇ status=retrying    ‚îÇ
‚îÇ                 ‚îÇ                    ‚îÇ
‚îÇ                 ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ                 ‚îÇ ‚îÇ Retry —á–µ—Ä–µ–∑ ‚îÇ   ‚îÇ
‚îÇ                 ‚îÇ ‚îÇ 2s, 4s, 8s  ‚îÇ   ‚îÇ
‚îÇ                 ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                 ‚îÇ                    ‚îÇ
‚îÇ                 ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ                 ‚îÇ ‚îÇ Fallback    ‚îÇ   ‚îÇ
‚îÇ                 ‚îÇ ‚îÇ –º–æ–¥–µ–ª–∏      ‚îÇ   ‚îÇ
‚îÇ                 ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ                 ‚îÇ                    ‚îÇ
‚îÇ                 ‚îÇ –ï—Å–ª–∏ attempts‚â•5:  ‚îÇ
‚îÇ                 ‚îÇ status=failed     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –†—É—á–Ω–∞—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
curl http://localhost:8010/users/1/posts/tagging_stats

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å retry –¥–ª—è failed –ø–æ—Å—Ç–æ–≤
curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?limit=50"

# 3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π retry (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?force=true&limit=10"

# 4. –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ—Å—Ç
curl -X POST http://localhost:8010/posts/391/regenerate_tags
```

## üìä –õ–æ–≥–∏

### –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```
INFO:tagging_service:üè∑Ô∏è TaggingService: –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É 2 –ø–æ—Å—Ç–æ–≤
INFO:httpx:HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
INFO:tagging_service:‚úÖ TaggingService: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ 5 —Ç–µ–≥–æ–≤
INFO:tagging_service:‚úÖ TaggingService: –ü–æ—Å—Ç 390 –æ–±–Ω–æ–≤–ª–µ–Ω —Å —Ç–µ–≥–∞–º–∏: ['–∑–æ–ª–æ—Ç–æ', '–∏–Ω—Ñ–ª—è—Ü–∏—è', '—ç–∫–æ–Ω–æ–º–∏–∫–∞', '–±–ª–∞–≥–æ—Å–æ—Å—Ç–æ—è–Ω–∏–µ', '—Å–ø—Ä–æ—Å']
```

### –û—à–∏–±–∫–∞ —Å retry
```
INFO:httpx:HTTP Request: POST https://openrouter.ai/api/v1/chat/completions "HTTP/1.1 200 OK"
ERROR:tagging_service:‚ùå TaggingService: API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
ERROR:tagging_service:–ü–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç API: {"error": {"message": "Upstream error from OpenInference: Error from model endpoint", "code": 502, "metadata": {"provider_name": "OpenInference"}}, "user_id": "..."}
INFO:tagging_service:‚è≥ TaggingService: Retry —á–µ—Ä–µ–∑ 2.0—Å...
INFO:tagging_service:üîÑ TaggingService: –ü–æ–ø—ã—Ç–∫–∞ 2, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –º–æ–¥–µ–ª—å: meta-llama/llama-3.2-3b-instruct:free
INFO:tagging_service:‚úÖ TaggingService: –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ 4 —Ç–µ–≥–æ–≤
```

### –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫
```
WARNING:tagging_service:‚ö†Ô∏è TaggingService: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥–∏ –¥–ª—è –ø–æ—Å—Ç–∞ 391 (–ø–æ–ø—ã—Ç–∫–∞ 5)
WARNING:tagging_service:‚ö†Ô∏è TaggingService: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –£—Å–ø–µ—à–Ω–æ: 1, –û—à–∏–±–æ–∫: 1
```

## üõ†Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env`:

```env
# –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∞–º–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è)
OPENROUTER_MODEL=google/gemini-2.0-flash-exp:free

# Retry –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
TAGGING_MAX_RETRIES=3          # 3 retry –ø—Ä–∏ 5xx –æ—à–∏–±–∫–∞—Ö
TAGGING_RETRY_DELAY=2.0        # –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 2—Å
TAGGING_MAX_ATTEMPTS=5         # –ú–∞–∫—Å–∏–º—É–º 5 –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –ø–æ—Å—Ç

# Batch size
TAGGING_BATCH_SIZE=10          # –ü–æ—Å—Ç–æ–≤ –≤ –±–∞—Ç—á–µ
```

### 2. Fallback –º–æ–¥–µ–ª–∏

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `tagging_service.py`:

```python
self.fallback_models = [
    "google/gemini-2.0-flash-exp:free",      # –û—Å–Ω–æ–≤–Ω–∞—è
    "meta-llama/llama-3.2-3b-instruct:free", # Backup #1
    "qwen/qwen-2-7b-instruct:free",          # Backup #2
    "google/gemma-2-9b-it:free"              # Backup #3
]
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏ (Gemini, Llama)
- –ò–∑–±–µ–≥–∞–π—Ç–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (DeepSeek, GPT-OSS)
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ fallback –º–æ–¥–µ–ª–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º

### 3. –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π:

```bash
cd /home/ilyasni/n8n-server/n8n-installer/telethon
python scripts/migrations/add_tagging_status_fields.py
```

–ú–∏–≥—Ä–∞—Ü–∏—è:
- ‚úÖ –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü—É `posts`
- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ—Å—Ç–æ–≤
- ‚úÖ –°–æ–≤–º–µ—Å—Ç–∏–º–∞ —Å SQLite –∏ PostgreSQL

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl http://localhost:8010/users/1/posts/tagging_stats

# –ü–æ—Å—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏
curl http://localhost:8010/users/1/posts | jq '.posts[] | select(.tagging_status == "failed")'
```

### –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤

```bash
# –û—à–∏–±–∫–∏ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
docker logs telethon 2>&1 | grep "TaggingService.*ERROR"

# Retry —Å–æ–±—ã—Ç–∏—è
docker logs telethon 2>&1 | grep "Retry —á–µ—Ä–µ–∑"

# –£—Å–ø–µ—à–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
docker logs telethon 2>&1 | grep "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ.*—Ç–µ–≥–æ–≤"
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç retry –º–µ—Ö–∞–Ω–∏–∑–º–∞

1. –í—Ä–µ–º–µ–Ω–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—É—é –º–æ–¥–µ–ª—å:
   ```env
   OPENROUTER_MODEL=deepseek/deepseek-r1-distill-qwen-32b:free
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥:
   ```bash
   curl -X POST http://localhost:8010/users/1/channels/parse
   ```

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
   ```bash
   docker logs -f telethon | grep -E "(Retry|fallback)"
   ```

4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
   ```bash
   curl http://localhost:8010/users/1/posts/tagging_stats
   ```

### –¢–µ—Å—Ç —Ä—É—á–Ω–æ–π –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```bash
# 1. –ù–∞–π—Ç–∏ –ø–æ—Å—Ç—ã —Å –æ—à–∏–±–∫–∞–º–∏
curl http://localhost:8010/users/1/posts/tagging_stats

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å retry
curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?limit=10"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
curl http://localhost:8010/users/1/posts/tagging_stats
```

## üîß Troubleshooting

### –í—Å–µ –ø–æ—Å—Ç—ã —Å —Å—Ç–∞—Ç—É—Å–æ–º "failed"

**–ü—Ä–∏—á–∏–Ω–∞:** –ú–æ–¥–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –∏–ª–∏ API –∫–ª—é—á –Ω–µ–≤–∞–ª–∏–¥–µ–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á: `echo $OPENROUTER_API_KEY`
2. –°–º–µ–Ω–∏—Ç–µ –º–æ–¥–µ–ª—å –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω—É—é: `OPENROUTER_MODEL=google/gemini-2.0-flash-exp:free`
3. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π retry: `curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?force=true"`

### Retry –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –Ω–µ 5xx (–Ω–∞–ø—Ä–∏–º–µ—Ä, 401, 429).

**–†–µ—à–µ–Ω–∏–µ:**
- –î–ª—è 401: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á
- –î–ª—è 429 (rate limit): —É–≤–µ–ª–∏—á—å—Ç–µ `TAGGING_BATCH_SIZE` –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

### Fallback –º–æ–¥–µ–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–µ–≤—ã—à–µ–Ω `TAGGING_MAX_RETRIES` –¥–æ fallback.

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `TAGGING_MAX_RETRIES=5`
- –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç–µ delay: `TAGGING_RETRY_DELAY=1.0`

### –ü–æ—Å—Ç—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ retry

**–ü—Ä–∏—á–∏–Ω–∞:** –î–æ—Å—Ç–∏–≥–Ω—É—Ç `TAGGING_MAX_ATTEMPTS`.

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π retry (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –ª–∏–º–∏—Ç)
curl -X POST "http://localhost:8010/users/1/posts/retry_tagging?force=true"
```

## üìù Best Practices

1. **–í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏:**
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `google/gemini-2.0-flash-exp:free` (–Ω–∞–∏–±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è)
   - –ò–∑–±–µ–≥–∞–π—Ç–µ `deepseek` –∏ `openai/gpt-oss` –º–æ–¥–µ–ª–µ–π

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏ retry:**
   - `TAGGING_MAX_RETRIES=3` - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
   - `TAGGING_MAX_ATTEMPTS=5` - –¥–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å fallback –º–æ–¥–µ–ª–∏

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç `failed` –ø–æ—Å—Ç–æ–≤

4. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π retry:**
   - –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ä—É—á–Ω–æ–π retry —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è `failed` –ø–æ—Å—Ç–æ–≤
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `force=true` —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [AI –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](AI_TAGGING.md)
- [API Documentation](../API.md)
- [–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î](../migrations/README.md)
- [Troubleshooting](../troubleshooting/README.md)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `docker logs telethon 2>&1 | grep "TaggingService"`
2. –ü–æ–ª—É—á–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: `GET /users/{user_id}/posts/tagging_stats`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è: `.env`
4. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º

---

**–ê–≤—Ç–æ—Ä:** Telegram Channel Parser Team  
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 11 –æ–∫—Ç—è–±—Ä—è 2025

