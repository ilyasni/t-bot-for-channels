# Устранение проблем с подключением к Telegram API

## Проблема
Ошибки подключения к Telegram API:
```
INFO:telethon.network.mtprotosender:Failed reconnection attempt 5 with ConnectionError
ERROR:telethon.network.mtprotosender:Automatic reconnection failed 5 time(s)
ConnectionError: Connection to Telegram failed 5 time(s)
```

## Решения

### 1. Проверьте конфигурацию .env файла

Создайте файл `.env` на основе `.env.example`:

```bash
cp .env.example .env
```

Заполните обязательные переменные:
```env
# Telegram API credentials (получите на https://my.telegram.org/apps)
API_ID=ваш_api_id
API_HASH=ваш_api_hash
PHONE=+7XXXXXXXXXX  # в международном формате
AUTH_CODE=код_из_telegram  # код подтверждения
BOT_TOKEN=токен_от_botfather
```

### 2. Проверьте интернет-соединение

Убедитесь, что:
- Интернет работает стабильно
- Нет блокировки Telegram в вашей сети
- Файрвол не блокирует исходящие соединения на порты 80/443

### 3. Очистите сессию (если проблема с авторизацией)

```bash
# Удалите файл сессии
rm sessions/session.session

# Перезапустите аутентификацию
python auth.py
```

### 4. Проверьте API ключи

- Перейдите на https://my.telegram.org/apps
- Убедитесь, что API_ID и API_HASH корректны
- Проверьте, что приложение активно

### 5. Проверьте номер телефона

- Номер должен быть в международном формате (+7XXXXXXXXXX)
- Номер должен быть привязан к аккаунту Telegram
- Убедитесь, что можете получать SMS

### 6. Обработка FloodWaitError

Если получаете ошибку "Flood wait":
- Дождитесь указанного времени
- Уменьшите частоту запросов
- Используйте разные аккаунты для разных задач

### 7. Тестирование подключения

Запустите тест подключения:
```bash
cd telethon
python auth.py
```

### 8. Запуск системы

После успешной аутентификации:
```bash
# Запуск всей системы
python run_system.py

# Или запуск отдельных компонентов
python main.py      # API сервер
python bot.py       # Telegram бот
python parser_service.py  # Парсер
```

## Улучшения в коде

Внесены следующие улучшения:

1. **Повторные попытки подключения** с экспоненциальной задержкой
2. **Улучшенная обработка ошибок** с детальным логированием
3. **Проверка конфигурации** перед подключением
4. **Корректное управление сессиями** и отключение
5. **Настраиваемые параметры** подключения (таймауты, количество попыток)

## Мониторинг

Для мониторинга состояния подключения проверяйте логи:
```bash
# В Docker
docker logs telethon

# Локально
tail -f logs/telethon.log
```

## Поддержка

Если проблема не решается:
1. Проверьте статус Telegram API
2. Обратитесь к документации Telethon
3. Проверьте актуальность версий библиотек
