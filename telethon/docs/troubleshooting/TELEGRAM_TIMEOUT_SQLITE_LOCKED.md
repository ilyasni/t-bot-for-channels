# Telegram Timeout & Database Locked - Troubleshooting

**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** `Timed out` –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞, –Ω–æ –∫–∞–Ω–∞–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ë–î  
**–ü—Ä–∏—á–∏–Ω–∞:** –ö–æ–Ω—Ñ–ª–∏–∫—Ç session —Ñ–∞–π–ª–æ–≤ –º–µ–∂–¥—É telethon –∏ telethon-bot –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

---

## üêõ –°–∏–º–ø—Ç–æ–º—ã

**–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç:**
```
‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞: Timed out
```

**–í –ë–î:**
```sql
‚úÖ –ö–∞–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–∞–Ω–∞–ª—É
‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
```

**–í –ª–æ–≥–∞—Ö:**
```
INFO:models:üì¢ –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫–∞–Ω–∞–ª: @techno_yandex
INFO:models:‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–∞–Ω–∞–ª—É
ERROR:telegram.ext.Application: telegram.error.TimedOut
sqlite3.OperationalError: database is locked
```

---

## üîç –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –¥–≤—É–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏

```
Docker Volumes:
./telethon/sessions ‚Üí /app/sessions

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –û–ë–û–ò–ú–ò –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏:
    ‚Üì                          ‚Üì
telethon (FastAPI)    telethon-bot (Bot)
    ‚Üì                          ‚Üì
user_139883458.session (SQLite)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- Telethon –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SQLite –¥–ª—è session —Ñ–∞–π–ª–æ–≤
- SQLite **–ù–ï –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π write access –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
- –ö–æ–≥–¥–∞ `telethon-bot` –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç ‚Üí **database is locked**
- –ó–∞–¥–µ—Ä–∂–∫–∞ ‚Üí timeout –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ Telegram —Å–æ–æ–±—â–µ–Ω–∏—è

---

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

**–ü–ª—é—Å—ã:**
- –ö–∞–Ω–∞–ª –≤—Å–µ —Ä–∞–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ `/my_channels`
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞

**–ú–∏–Ω—É—Å—ã:**
- –ü–ª–æ—Ö–æ–π UX (–æ—à–∏–±–∫–∞ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–Ω–∞–µ—Ç —á—Ç–æ –∫–∞–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```
–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Timed out" - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–º–∞–Ω–¥–æ–π:
/my_channels

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∫–∞–Ω–∞–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–≤–µ–ª–∏—á–∏—Ç—å timeout (–ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

**–§–∞–π–ª:** `bot_standalone.py`

```python
from telegram.ext import Application
from telegram.request import HTTPXRequest

# –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º timeout
request = HTTPXRequest(
    connect_timeout=30.0,
    read_timeout=30.0,
    write_timeout=30.0
)

application = Application.builder().token(BOT_TOKEN).request(request).build()
```

**–ü–ª—é—Å—ã:**
- –ü—Ä–æ—Å—Ç–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- –î–∞–µ–º –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞

**–ú–∏–Ω—É—Å—ã:**
- –ù–µ —Ä–µ—à–∞–µ—Ç –∫–æ—Ä–Ω–µ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É (database locked)

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ StringSession (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**–ü—Ä–æ–±–ª–µ–º–∞:** SQLite session —Ñ–∞–π–ª—ã –Ω–µ thread-safe

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å StringSession (—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ PostgreSQL)

**–§–∞–π–ª:** `shared_auth_manager.py`

```python
from telethon.sessions import StringSession

class SharedAuthManager:
    async def _create_client(self, telegram_id: int) -> TelegramClient:
        # –ü–æ–ª—É—á–∞–µ–º session string –∏–∑ –ë–î
        db = SessionLocal()
        try:
            user = db.query(User).filter(User.telegram_id == telegram_id).first()
            session_string = user.telethon_session_string  # –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤ –ë–î
        finally:
            db.close()
        
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Å StringSession
        client = TelegramClient(
            StringSession(session_string),  # –í–º–µ—Å—Ç–æ file path
            self.master_api_id,
            self.master_api_hash
        )
        
        return client
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ models.py:**
```python
class User(Base):
    __tablename__ = "users"
    # ... existing fields ...
    telethon_session_string = Column(Text, nullable=True)  # –ù–û–í–û–ï –ü–û–õ–ï
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
- ‚úÖ Session –≤ PostgreSQL (–Ω–∞–¥–µ–∂–Ω–µ–µ)
- ‚úÖ Backup —Å–µ—Å—Å–∏–π –≤–º–µ—Å—Ç–µ —Å –ë–î
- ‚úÖ –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ session –Ω–∞ –¥–∏—Å–∫–µ

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
- –¢—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ shared_auth_manager –∏ qr_auth_manager

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ó–∞—á–µ–º –¥–≤–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –µ—Å–ª–∏ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ session —Ñ–∞–π–ª—ã?

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ `telethon`

**–§–∞–π–ª:** `run_system.py` (—É–∂–µ —Ç–∞–∫ –¥–µ–ª–∞–µ—Ç!)

```python
# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ –≤ —Ç–æ–º –∂–µ –ø—Ä–æ—Ü–µ—Å—Å–µ —á—Ç–æ –∏ FastAPI
async def main():
    # 1. –ó–∞–ø—É—Å–∫ FastAPI
    # 2. –ó–∞–ø—É—Å–∫ Bot (python-telegram-bot)
    # 3. –ó–∞–ø—É—Å–∫ Parser Service
    # –í—Å–µ –≤ –æ–¥–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
```

**Docker Compose:** –£–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π `telethon-bot` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

**–ü–ª—é—Å—ã:**
- ‚úÖ –ù–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ session —Ñ–∞–π–ª–æ–≤
- ‚úÖ –ú–µ–Ω—å—à–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- ‚úÖ –ï–¥–∏–Ω–∞—è –ø–∞–º—è—Ç—å –¥–ª—è active_clients

**–ú–∏–Ω—É—Å—ã:**
- –ï—Å–ª–∏ FastAPI –ø–∞–¥–∞–µ—Ç ‚Üí –±–æ—Ç —Ç–æ–∂–µ –ø–∞–¥–∞–µ—Ç

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):

1. **–ö–∞–Ω–∞–ª —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω!** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   ```
   /my_channels
   ```

2. **–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –∫–∞–Ω–∞–ª—ã:**
   - –ü—Ä–æ—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É
   - –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Timed out" - –ø–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫—É–Ω–¥ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ `/my_channels`
   - –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –∫–∞–Ω–∞–ª –±—É–¥–µ—Ç –≤ —Å–ø–∏—Å–∫–µ

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ (—Å–ª–µ–¥—É—é—â–∏–µ 1-2 –¥–Ω—è):

**–£–≤–µ–ª–∏—á–∏—Ç—å timeout –≤ bot_standalone.py:**

```python
request = HTTPXRequest(
    connect_timeout=30.0,  # –ë—ã–ª–æ: 10.0
    read_timeout=30.0,     # –ë—ã–ª–æ: 10.0
    write_timeout=30.0     # –ë—ã–ª–æ: 10.0
)
```

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ (–Ω–µ–¥–µ–ª—è):

**–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ StringSession:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `telethon_session_string` –≤ —Ç–∞–±–ª–∏—Ü—É `users`
2. –ú–∏–≥—Ä–∞—Ü–∏—è: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ session —Ñ–∞–π–ª—ã ‚Üí StringSession
3. –û–±–Ω–æ–≤–∏—Ç—å `shared_auth_manager` –∏ `qr_auth_manager`
4. –£–¥–∞–ª–∏—Ç—å session —Ñ–∞–π–ª—ã

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ (–º–µ—Å—è—Ü):

**–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `telethon`
- –ó–∞–ø—É—Å–∫–∞—Ç—å –±–æ—Ç–∞ —á–µ—Ä–µ–∑ `run_system.py`
- –£–¥–∞–ª–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π `telethon-bot` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏–π

| –†–µ—à–µ–Ω–∏–µ | –°–ª–æ–∂–Ω–æ—Å—Ç—å | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å | –í—Ä–µ–º—è |
|---------|-----------|---------------|-------|
| **–ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å** | ‚≠ê | ‚≠ê | 0 –º–∏–Ω—É—Ç |
| **–£–≤–µ–ª–∏—á–∏—Ç—å timeout** | ‚≠ê‚≠ê | ‚≠ê‚≠ê | 5 –º–∏–Ω—É—Ç |
| **StringSession** | ‚≠ê‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | 2-3 —á–∞—Å–∞ |
| **–û–¥–∏–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä** | ‚≠ê‚≠ê‚≠ê | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê | 1 —á–∞—Å |

---

## üîó –ü–æ—Ö–æ–∂–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

- SQLite session locks –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- Telegram API rate limiting
- Network timeouts

---

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç)  
**Workaround:** –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `/my_channels` –µ—Å–ª–∏ –≤–∏–¥–∏—Ç–µ "Timed out"  
**–í–µ—Ä—Å–∏—è:** 3.2.0  
**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025

