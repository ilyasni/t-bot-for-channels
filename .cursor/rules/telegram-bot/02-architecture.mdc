---
title: "Telegram Bot Architecture"
description: "ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¸ Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ¾Ğ²"
tags: ["architecture", "microservices", "docker"]
version: "3.1"
---

# Microservices Architecture

## ğŸ—ï¸ High-Level Overview

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑĞ¾ÑÑ‚Ğ¾Ğ¸Ñ‚ Ğ¸Ğ· 4 Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ telethon-botâ”‚â”€â”€â”€â”€â–¶â”‚   telethon   â”‚â”€â”€â”€â”€â–¶â”‚ rag-serviceâ”‚
â”‚   (bot)     â”‚     â”‚ (API+Parser) â”‚     â”‚  (AI/RAG)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ gpt2giga-proxyâ”‚
                    â”‚   (GigaChat)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ ĞœĞ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑÑ‹

### 1. telethon-bot (standalone)

**Ğ Ğ¾Ğ»ÑŒ:** Telegram Ğ±Ğ¾Ñ‚ Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ

```yaml
# docker-compose.override.yml
telethon-bot:
  build: ./telethon
  command: python bot.py
  environment:
    - BOT_TOKEN=${BOT_TOKEN}
    - TELEGRAM_DATABASE_URL=${TELEGRAM_DATABASE_URL}
    - REDIS_HOST=redis
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸:**
- `/login` â€” QR-Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- `/add_channel` â€” Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²
- `/ask`, `/search`, `/recommend` â€” RAG ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
- `/admin` â€” Admin Panel (Mini App)

### 2. telethon (API + Parser)

**Ğ Ğ¾Ğ»ÑŒ:** FastAPI ÑĞµÑ€Ğ²ĞµÑ€ + Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³

```yaml
telethon:
  build: ./telethon
  ports:
    - "8010:8010"  # API
    - "8001:8001"  # Auth web (legacy)
  command: python main.py
```

**Endpoints:**
```python
# API ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ°
@app.get("/posts")                    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ñ‹
@app.get("/channels")                 # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²
@app.get("/qr-auth")                  # QR-auth Mini App
@app.get("/admin-panel")              # Admin Panel Mini App
@app.get("/api/admin/users")          # Admin API
```

### 3. rag-service

**Ğ Ğ¾Ğ»ÑŒ:** Ğ’ĞµĞºÑ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¸ AI

```yaml
rag-service:
  build: ./telethon/rag_service
  ports:
    - "8020:8020"
  environment:
    - QDRANT_URL=http://qdrant:6333
    - REDIS_HOST=redis
```

**Endpoints:**
```python
@app.post("/rag/query")               # RAG-Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
@app.post("/rag/index/post/{id}")     # Ğ˜Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
@app.get("/rag/recommend/{user_id}")  # Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸
@app.post("/rag/digest/generate")     # AI-Ğ´Ğ°Ğ¹Ğ´Ğ¶ĞµÑÑ‚Ñ‹
```

### 4. gpt2giga-proxy

**Ğ Ğ¾Ğ»ÑŒ:** OpenAI-ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ñ‹Ğ¹ API Ğ´Ğ»Ñ GigaChat

```yaml
gpt2giga-proxy:
  image: produman/gpt2giga:latest
  ports:
    - "8090:8090"
  environment:
    - GIGACHAT_CREDENTIALS=${GIGACHAT_CREDENTIALS}
```

**Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:**
```python
# Embeddings Ñ‡ĞµÑ€ĞµĞ· GigaChat
async with httpx.AsyncClient() as client:
    response = await client.post(
        "http://gpt2giga-proxy:8090/v1/embeddings",
        json={
            "model": "EmbeddingsGigaR",
            "input": text
        }
    )
```

## ğŸ”„ Event-Driven Architecture

```python
# ĞŸĞ¾Ñ‚Ğ¾Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
Telegram â†’ Parser â†’ New Post Event
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“          â†“          â†“
         Tagging    Indexer     n8n Webhook
         Service    (RAG)       (optional)
              â†“          â†“          
         AI Tags    Qdrant     Flowise
                    Vector      Workflow
                         â†“
                    RAG Ready
                         â†“
              User Query â†’ Answer
```

### Event Handlers

```python
# parser_service.py
async def parse_channel(channel_id: int, user_id: int):
    # 1. ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
    posts = await fetch_posts(channel_id)
    
    # 2. Event: new_post
    for post in posts:
        await notify_webhooks("new_post", post.dict())
        
        # 3. Tagging (background)
        background_tasks.add_task(
            tagging_service.tag_post, post.id
        )
        
        # 4. Indexing (background)
        background_tasks.add_task(
            rag_indexer.index_post, post.id
        )
```

## ğŸ³ Docker Integration

### Ğ—Ğ°Ğ¿ÑƒÑĞº ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

```bash
# Ğ˜Ğ· ĞºĞ¾Ñ€Ğ½Ñ n8n-installer:
python start_services.py

# ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:
# 1. ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸ telethon/
# 2. ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ .env Ğ´Ğ»Ñ telethon
# 3. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ docker-compose.override.yml
# 4. Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ Ğ² ÑĞµÑ‚ÑŒ localai_default
```

### Dockerfile Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½

```dockerfile
# Dockerfile.telethon
FROM python:3.11-slim

WORKDIR /app

# Dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Code
COPY . .

# Sessions volume
VOLUME /app/sessions

CMD ["python", "main.py"]
```

### Volumes

```yaml
volumes:
  - ./telethon/sessions:/app/sessions  # Telegram sessions
  - ./telethon/data:/app/data          # PostgreSQL data
  - ./telethon/logs:/app/logs          # Logs
```

## ğŸŒ Networking

### Ğ•Ğ´Ğ¸Ğ½Ğ°Ñ ÑĞµÑ‚ÑŒ

```yaml
networks:
  default:
    name: localai_default
    external: true
```

**Internal communication:**
```python
# telethon-bot â†’ telethon
TELETHON_API_URL = "http://telethon:8010"

# telethon â†’ rag-service
RAG_SERVICE_URL = "http://rag-service:8020"

# rag-service â†’ gpt2giga-proxy
GIGACHAT_PROXY_URL = "http://gpt2giga-proxy:8090"

# All â†’ PostgreSQL
DATABASE_URL = "postgresql://postgres:pwd@db:5432/postgres"

# All â†’ Redis
REDIS_HOST = "redis"
```

## ğŸ”§ Service Communication

### Shared State Ñ‡ĞµÑ€ĞµĞ· Redis

```python
# QR Sessions (telethon-bot â†” telethon)
redis_client.setex(
    f"qr_session:{session_id}",
    600,  # 10 Ğ¼Ğ¸Ğ½ÑƒÑ‚
    json.dumps({
        "telegram_id": 123,
        "invite_code": "ABC123",
        "token": "...",
        "status": "waiting"
    })
)

# Admin Sessions (telethon-bot â†” telethon)
redis_client.setex(
    f"admin_session:{token}",
    3600,  # 1 Ñ‡Ğ°Ñ
    json.dumps({
        "telegram_id": 123,
        "expires": datetime.now(timezone.utc).isoformat()
    })
)
```

### Background Tasks

```python
from fastapi import BackgroundTasks

@app.post("/parse")
async def parse_endpoint(
    channel_id: int,
    background_tasks: BackgroundTasks
):
    # ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚
    background_tasks.add_task(
        parser_service.parse_channel,
        channel_id
    )
    return {"status": "queued"}
```

## âœ… Verification Steps

1. **Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹:**
```bash
docker ps | grep -E "(telethon|rag-service|gpt2giga)"
# Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ 3-4 ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€Ğ°
```

2. **Ğ¡ĞµÑ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ°:**
```bash
docker network inspect localai_default
# Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑĞµÑ‚Ğ¸
```

3. **Inter-service communication:**
```bash
# Ğ˜Ğ· telethon â†’ rag-service
docker exec telethon curl http://rag-service:8020/health
# {"status": "healthy"}
```

4. **Redis shared state:**
```bash
# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° QR sessions
docker exec redis redis-cli KEYS "qr_session:*"
docker exec redis redis-cli KEYS "admin_session:*"
```

## ğŸš¨ ĞŸĞ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ

**Ğ Ğ°Ğ·Ğ½Ñ‹Ğµ ÑĞµÑ‚Ğ¸ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²:**
- âŒ Ğ¡ĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¾Ğ±Ñ‰Ğ°Ñ‚ÑŒÑÑ
- âŒ telethon-bot Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ QR session
- âŒ RAG indexing Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½

**ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Redis:**
- âŒ QR Login Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- âŒ Admin Panel sessions Ñ‚ĞµÑ€ÑÑÑ‚ÑÑ
- âŒ ĞĞµÑ‚ ĞºĞµÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ embeddings

**Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‰Ğ¸Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸:**
- âŒ Event loop Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ
- âŒ ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ñ‚Ğ¾Ñ€Ğ¼Ğ¾Ğ·Ğ¸Ñ‚ API
- âŒ Timeout Ğ½Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°Ñ…

## ğŸ“š Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°

- `01-core.mdc` â€” ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°
- `03-database.mdc` â€” PostgreSQL, Redis
- `08-api.mdc` â€” FastAPI endpoints
