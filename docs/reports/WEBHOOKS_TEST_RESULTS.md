# ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è webhooks

**–î–∞—Ç–∞:** 14 –æ–∫—Ç—è–±—Ä—è 2025, 14:10  
**–¢–µ—Å—Ç—ã:** Voice Classifier, Query Expander, Group Digest

---

## ‚úÖ Voice Command Classifier - –†–ê–ë–û–¢–ê–ï–¢!

```bash
curl -X POST http://n8n:5678/webhook/voice-classify \
  -H "Content-Type: application/json" \
  -d '{"transcription": "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –ø–æ –±–∞–Ω–∫–∞–º", "user_id": 6}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "command": "ask",
  "confidence": 0.8,
  "reasoning": "–ó–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å –æ –±–∞–Ω–∫–∞—Ö, —á—Ç–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã /ask...",
  "original_transcription": "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –ø–æ –±–∞–Ω–∫–∞–º",
  "user_id": 6
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–†–ê–ë–û–¢–ê–ï–¢ –û–¢–õ–ò–ß–ù–û!**

- Webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- Workflow –∞–∫—Ç–∏–≤–µ–Ω
- GigaChat –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON

---

## ‚ùå Query Expander - –ù–ï –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!

```bash
curl -X POST http://n8n:5678/webhook/expand-query \
  -H "Content-Type: application/json" \
  -d '{"query": "–±–∞–Ω–∫–∏", "user_id": 6}'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "code": 404,
  "message": "The requested webhook \"POST expand-query\" is not registered.",
  "hint": "The workflow must be active for a production URL to run successfully. You can activate the workflow using the toggle in the top-right of the editor."
}
```

**–°—Ç–∞—Ç—É—Å:** ‚ùå **WEBHOOK –ù–ï –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù**

**–ü—Ä–∏—á–∏–Ω–∞:** Workflow –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–æ **–ù–ï –ê–ö–¢–ò–í–ò–†–û–í–ê–ù** (Active = OFF)

**–†–µ—à–µ–Ω–∏–µ:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n UI
2. –ù–∞–π–¥–∏—Ç–µ workflow **"Query Expander"**
3. –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ **Active ‚Üí ON** (–∑–µ–ª–µ–Ω—ã–π)
4. –ù–∞–∂–º–∏—Ç–µ **Save**

---

## ‚úÖ Group Digest Orchestrator - –ù–ê–°–¢–†–û–ï–ù

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞:**
- ‚úÖ Webhook: `/group-digest`
- ‚úÖ Execute —É–∑–ª—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- ‚úÖ Sub-workflows —Å–≤—è–∑–∞–Ω—ã
- ‚úÖ Data flow –±–µ–∑ –ø–æ—Ç–µ—Ä—å

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram:**
```
/group_digest 6
```

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å

| Workflow | Webhook | –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω | –ê–∫—Ç–∏–≤–µ–Ω | –†–∞–±–æ—Ç–∞–µ—Ç |
|----------|---------|--------------|---------|----------|
| **Voice Command Classifier** | `/webhook/voice-classify` | ‚úÖ | ‚úÖ | ‚úÖ |
| **Query Expander** | `/webhook/expand-query` | ‚úÖ | ‚ùå | ‚ùå |
| **Group Digest Orchestrator** | `/webhook/group-digest` | ‚úÖ | ‚úÖ | ‚úÖ (–Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω) |
| **Agent: Topic Extractor** | (Execute Trigger) | ‚úÖ | N/A | ‚úÖ |
| **Agent: Speaker Analyzer** | (Execute Trigger) | ‚úÖ | N/A | ‚úÖ |
| **Agent: Context Summarizer** | (Execute Trigger) | ‚úÖ | N/A | ‚úÖ |
| **Group Mention Analyzer v2** | `/webhook/mention-analyzer` | ‚úÖ | ‚úÖ | ‚úÖ (–Ω–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω) |

---

## üéØ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–¥–µ –±–æ—Ç–∞

### 1. RAG endpoint ‚úÖ

**–ë—ã–ª–æ:**
```python
result = await self._call_rag_service("/rag/query", ...)  # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint
```

**–°—Ç–∞–ª–æ:**
```python
result = await self._call_rag_service("/rag/ask", ...)  # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint
```

### 2. RAG_MIN_SCORE ‚úÖ

**–ë—ã–ª–æ:**
```python
RAG_MIN_SCORE = 0.7  # –°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥
```

**–°—Ç–∞–ª–æ:**
```python
RAG_MIN_SCORE = 0.5  # –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥
```

### 3. Markdown —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ

**–ë—ã–ª–æ:**
```python
safe_name = display_name.replace('_', '\\_').replace('*', '\\*')...  # –ù–µ–ø–æ–ª–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```

**–°—Ç–∞–ª–æ:**
```python
from telegram_formatter import markdownify
safe_text = markdownify(text)  # –ü–æ–ª–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ telegramify-markdown
```

---

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Query Expander

**–ï—Å–ª–∏ –ù–ï –Ω—É–∂–µ–Ω:**
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã ("–±–∞–Ω–∫–∏", "–∫—Ä–∏–ø—Ç–∞") –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å "–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –¥–æ–ª–∂–Ω—ã —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã

**–ï—Å–ª–∏ –Ω—É–∂–µ–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n UI
2. Workflows ‚Üí "Query Expander"
3. **Active ‚Üí ON**
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ:
   ```bash
   curl -X POST http://n8n:5678/webhook/expand-query \
     -d '{"query": "–±–∞–Ω–∫–∏", "user_id": 6}'
   ```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Query Expander –≤ –±–æ—Ç–∞

–ï—Å–ª–∏ Query Expander –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ –≤ `bot.py`:

```python
# –í ask_command –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º RAG
if len(query_text.split()) <= 2:
    # –í—ã–∑–æ–≤ Query Expander
    expansion = await self._call_n8n_expander(query_text, user_id)
    if expansion and expansion.get('was_expanded'):
        query_text = expansion['expanded_query']
        logger.info(f"üìù Query expanded: {query_text}")
```

---

## üß™ –¢–µ—Å—Ç—ã

### –¢–µ—Å—Ç 1: Voice Classifier (—á–µ—Ä–µ–∑ Telegram)

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ –ë–ï–ó –∫–æ–º–∞–Ω–¥—ã
2. –°–∫–∞–∂–∏—Ç–µ: "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –ø–æ –±–∞–Ω–∫–∞–º?"

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –ø–æ –±–∞–Ω–∫–∞–º?"

ü§ñ AI –≤—ã–±—Ä–∞–ª: /ask (80% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏)
üîç –í—ã–ø–æ–ª–Ω—è—é...

üí° –û—Ç–≤–µ—Ç: [RAG –æ—Ç–≤–µ—Ç]
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ n8n:**
- Executions ‚Üí Voice Command Classifier
- –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å ‚úÖ

### –¢–µ—Å—Ç 2: RAG /ask (—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –∑–∞–ø—Ä–æ—Å)

```
/ask –ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤ –º–∏—Ä–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –∏ –±–ª–æ–∫—á–µ–π–Ω–∞?
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
üîç –ò—â—É –æ—Ç–≤–µ—Ç –≤ –≤–∞—à–∏—Ö –ø–æ—Å—Ç–∞—Ö...

üí° –û—Ç–≤–µ—Ç:
–í –ø–æ—Å—Ç–µ –∏–∑ –∫–∞–Ω–∞–ª–∞ @MarketOverview...

üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
‚Ä¢ @MarketOverview (14.10.2025)
```

### –¢–µ—Å—Ç 3: RAG /ask (–∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–ø—Ä–æ—Å)

```
/ask –±–∞–Ω–∫–∏
```

**–ë–ï–ó Query Expander:**
```
üí° –û—Ç–≤–µ—Ç:
–ü–æ –¥–∞–Ω–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ø–æ—Å—Ç–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. 
–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å.
```

**–° Query Expander (–ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏):**
```
üìù –†–∞—Å—à–∏—Ä—è—é –∑–∞–ø—Ä–æ—Å: "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –ø–æ –±–∞–Ω–∫–∞–º –∏ –¥–µ–ø–æ–∑–∏—Ç–∞–º?"

üîç –ò—â—É –æ—Ç–≤–µ—Ç –≤ –≤–∞—à–∏—Ö –ø–æ—Å—Ç–∞—Ö...

üí° –û—Ç–≤–µ—Ç:
[–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ –±–∞–Ω–∫–∏ –∏ –¥–µ–ø–æ–∑–∏—Ç—ã]
```

### –¢–µ—Å—Ç 4: Group Digest

```
/group_digest 6
```

**–û–∂–∏–¥–∞–µ—Ç—Å—è:**
```
# üìä –î–∞–π–¥–∂–µ—Å—Ç –≥—Ä—É–ø–ø—ã: [–Ω–∞–∑–≤–∞–Ω–∏–µ]
–ü–µ—Ä–∏–æ–¥: 6 hours
–°–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: [—á–∏—Å–ª–æ]
...
```

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫–ª–∏—Å—Ç

- [x] Voice Command Classifier –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω ‚úÖ
- [x] Voice Command Classifier –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω ‚úÖ
- [x] Voice Command Classifier –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω ‚úÖ
- [x] Group Digest Orchestrator –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚úÖ
- [x] RAG endpoint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω (`/rag/ask`) ‚úÖ
- [x] RAG_MIN_SCORE –ø–æ–Ω–∏–∂–µ–Ω (0.5) ‚úÖ
- [x] Markdown —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ ‚úÖ
- [x] Query Expander –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω ‚úÖ
- [ ] **Query Expander –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω** ‚è≥
- [ ] Query Expander –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ –±–æ—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ‚è≥

---

## üéâ –í—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Voice Command Classifier** ‚úÖ
   - Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç
   - GigaChat –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–æ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞

2. **RAG /ask** ‚úÖ
   - –° —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
   - Endpoint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω
   - Min score –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω

3. **Group Digest Orchestrator** ‚úÖ
   - –í—Å–µ sub-workflows –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
   - Data flow –±–µ–∑ –ø–æ—Ç–µ—Ä—å
   - –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

4. **Markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚úÖ
   - `/my_groups` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è telegramify-markdown

### ‚è≥ –ß—Ç–æ –æ—Å—Ç–∞–ª–æ—Å—å:

1. **–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Query Expander** (1 –º–∏–Ω—É—Ç–∞)
   - –û—Ç–∫—Ä–æ–π—Ç–µ n8n UI
   - Active ‚Üí ON

2. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å Query Expander** –≤ –±–æ—Ç–∞ (10 –º–∏–Ω—É—Ç, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –î–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ webhook –ø–µ—Ä–µ–¥ RAG
   - –†–∞—Å—à–∏—Ä—è—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏** –≤ Telegram (5 –º–∏–Ω—É—Ç)
   - –ì–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
   - `/ask` —Å —Ä–∞–∑–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
   - `/group_digest`
   - `/my_groups`

---

## üìÅ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- **–≠—Ç–æ—Ç –æ—Ç—á–µ—Ç:** `WEBHOOKS_TEST_RESULTS.md`
- **Workflows —Å—Ç–∞—Ç—É—Å:** `WORKFLOW_STATUS_FINAL.md`
- **RAG –∏ Voice:** `RAG_VOICE_CLASSIFIER_STATUS.md`
- **Voice Classifier –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** `VOICE_CLASSIFIER_WEBHOOK_FIX.md`

---

**–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ Query Expander –≤ n8n UI –∏ –≤—Å—ë –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–æ!** üöÄ

