# ðŸŽ¯ Voice Command Classifier - Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð• WEBHOOK

**Ð”Ð°Ñ‚Ð°:** 13 Ð¾ÐºÑ‚ÑÐ±Ñ€Ñ 2025  
**Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:** âœ… ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ€ÐµÑˆÐµÐ½Ð°!

---

## ðŸ› ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°:

```
ERROR:bot:âŒ n8n classifier returned invalid response: {'message': 'Workflow was started'}
```

**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°:** Webhook Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð» Ð² **Production mode** Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°Ð» ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð²Ð¼ÐµÑÑ‚Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°.

---

## âœ… Ð ÐµÑˆÐµÐ½Ð¸Ðµ:

Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ `"responseMode": "lastNode"` Ð² Webhook ÑƒÐ·ÐµÐ»:

```json
{
  "parameters": {
    "httpMethod": "POST",
    "path": "voice-classify",
    "responseMode": "lastNode",  // â† Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐž!
    ...
  }
}
```

**Ð¢ÐµÐ¿ÐµÑ€ÑŒ webhook:**
- âœ… Ð–Ð´ÐµÑ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ workflow
- âœ… Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð¾Ñ‚ "Respond to Webhook"
- âœ… ÐÐµ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð·Ð°Ð¿ÑƒÑÐºÐ°

---

## ðŸš€ Ð§Ð¢Ðž Ð”Ð•Ð›ÐÐ¢Ð¬:

### 1. Ð£Ð´Ð°Ð»Ð¸ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ workflow Ð² n8n:

```
1. http://localhost:5678 â†’ Workflows
2. Voice Command Classifier â†’ ... (Ñ‚Ñ€Ð¸ Ñ‚Ð¾Ñ‡ÐºÐ¸) â†’ Delete
3. Confirm
```

### 2. Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹:

```
1. "+" â†’ "Import from File"
2. n8n/workflows/voice_command_classifier.json
3. "Import"
4. "Active" âœ…
```

### 3. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹ Ð² Telegram:

```
1. /reset
2. ÐÐ°Ð¶Ð¼Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ: "ðŸ¤– AI Ñ€ÐµÐ¶Ð¸Ð¼"
3. ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ Ð³Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ: "Ð§Ñ‚Ð¾ Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð¿Ñ€Ð¾ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸?"
```

**ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ:**
```
âœ… Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð½Ð¾: "Ð§Ñ‚Ð¾ Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð¿Ñ€Ð¾ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸?"

ðŸ¤– AI Ð²Ñ‹Ð±Ñ€Ð°Ð»: /ask (95% ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸)
ðŸ” Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽ...

ðŸ’¡ ÐžÑ‚Ð²ÐµÑ‚: [RAG Ð¾Ñ‚Ð²ÐµÑ‚]
```

---

## ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð² Ð»Ð¾Ð³Ð°Ñ…:

```bash
docker logs telethon 2>&1 | grep "AI classif" | tail -5

# ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ:
INFO:bot:ðŸ¤– AI classification: ask (95%)
```

**Ð‘Ð•Ð— Ð¾ÑˆÐ¸Ð±ÐºÐ¸:**
```
ERROR:bot:âŒ n8n classifier returned invalid response: {'message': 'Workflow was started'}
```

---

## ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð² n8n:

```
http://localhost:5678 â†’ Executions â†’ Voice Command Classifier
```

**Ð”Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ:**
- **Status:** âœ… Success
- **Output:**
  ```json
  {
    "command": "ask",
    "confidence": 0.95,
    "reasoning": "...",
    "original_transcription": "Ð§Ñ‚Ð¾ Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð¿Ñ€Ð¾ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸?",
    "user_id": 1
  }
  ```

---

## ðŸŽ¯ Ð§Ñ‚Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾:

| ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð° | Ð‘Ñ‹Ð»Ð¾ | Ð¡Ñ‚Ð°Ð»Ð¾ |
|----------|------|-------|
| **Webhook mode** | Production (async) | lastNode (wait) |
| **ÐžÑ‚Ð²ÐµÑ‚** | `{"message": "Workflow was started"}` | `{"command": "ask", "confidence": 0.95, ...}` |
| **JSON Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ** | Template string (Ð»Ð¾Ð¼Ð°Ð»ÑÑ) | Code ÑƒÐ·ÐµÐ» (Ð½Ð°Ð´ÐµÐ¶Ð½Ð¾) |
| **Fallback** | ÐÐµ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ð» ÐºÐ½Ð¾Ð¿ÐºÐ¸ | ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Inline ÐºÐ½Ð¾Ð¿ÐºÐ¸ âœ… |

---

## âœ… Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° workflow (Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ):

```
Webhook (responseMode: lastNode) â† Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐž!
  â†“
Extract Input (transcription, user_id)
  â†“
Prepare Request (Code - ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ JSON Ð´Ð»Ñ GigaChat) â† Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐž!
  â†“
GigaChat Classify (HTTP POST Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¼ JSON)
  â†“
Parse & Validate (Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³ + ÑÐ²Ñ€Ð¸ÑÑ‚Ð¸ÐºÐ° fallback)
  â†“
Respond to Webhook (Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚) â† Ð–Ð”Ð•Ð¢ WEBHOOK!
```

**Ð£Ð·Ð»Ð¾Ð²:** 6  
**Credentials:** ÐÐ• Ñ‚Ñ€ÐµÐ±ÑƒÑŽÑ‚ÑÑ âœ…  
**Wait for result:** âœ… Ð”Ð!

---

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### Ð¢ÐµÑÑ‚ 1: Ð§ÐµÑ€ÐµÐ· curl

```bash
curl -X POST http://n8n:5678/webhook/voice-classify \
  -H "Content-Type: application/json" \
  -d '{"transcription":"ÐÐ°Ð¹Ð´Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ","user_id":1}'
```

**Ð”Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (Ð‘Ð«Ð›Ðž):**
```json
{"message": "Workflow was started"}
```

**ÐŸÐ¾ÑÐ»Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ (ÐžÐ–Ð˜Ð”ÐÐ•Ð¢Ð¡Ð¯):**
```json
{
  "command": "search",
  "confidence": 0.9,
  "reasoning": "ÐšÐ»ÑŽÑ‡ÐµÐ²Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ 'Ð½Ð°Ð¹Ð´Ð¸' ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð° Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº",
  "original_transcription": "ÐÐ°Ð¹Ð´Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ",
  "user_id": 1
}
```

### Ð¢ÐµÑÑ‚ 2: Ð’ Telegram

**ÐžÑ‚Ð¿Ñ€Ð°Ð²ÑŒ:**
1. `/reset`
2. ÐÐ°Ð¶Ð¼Ð¸ "ðŸ¤– AI Ñ€ÐµÐ¶Ð¸Ð¼"
3. Ð“Ð¾Ð»Ð¾ÑÐ¾Ð²Ð¾Ðµ: "Ð§Ñ‚Ð¾ Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð¿Ñ€Ð¾ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸?"

**Ð”Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:**
```
âœ… Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð½Ð¾: "..."
ðŸ¤” Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ: [ðŸ’¡ /ask] [ðŸ” /search]
```

**ÐŸÐ¾ÑÐ»Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:**
```
âœ… Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð½Ð¾: "Ð§Ñ‚Ð¾ Ð¿Ð¸ÑÐ°Ð»Ð¸ Ð¿Ñ€Ð¾ Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸?"

ðŸ¤– AI Ð²Ñ‹Ð±Ñ€Ð°Ð»: /ask (95% ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸)
ðŸ” Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽ...

ðŸ’¡ ÐžÑ‚Ð²ÐµÑ‚: [RAG Ð¾Ñ‚Ð²ÐµÑ‚]
```

---

## ðŸŽ‰ Ð“ÐžÐ¢ÐžÐ’Ðž!

**ÐŸÐµÑ€ÐµÐ¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐ¹ workflow Ð¸ Ð¿Ñ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€ÑƒÐ¹!** ðŸš€

Ð¢ÐµÐ¿ÐµÑ€ÑŒ AI ÐºÐ»Ð°ÑÑÐ¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ! âœ…

---

**ÐŸÐ¾ÐºÐ°Ð¶Ð¸ Ð»Ð¾Ð³Ð¸ Ð¿Ð¾ÑÐ»Ðµ Ñ‚ÐµÑÑ‚Ð°:**
```bash
docker logs telethon 2>&1 | grep "AI classif" | tail -5
```

Ð˜ Ñ‡Ñ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð¸Ð» Ð±Ð¾Ñ‚! ðŸ‘€
