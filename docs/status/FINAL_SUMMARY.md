# ‚úÖ –§–ò–ù–ê–õ–¨–ù–´–ô –û–¢–ß–ï–¢: –î–∞–π–¥–∂–µ—Å—Ç—ã + Cleanup + –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–î–∞—Ç–∞:** 15 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ó–ê–í–ï–†–®–ï–ù–û**

---

## üìä –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 1. –î–∞–π–¥–∂–µ—Å—Ç—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ | –ü–æ—Å–ª–µ | –£–ª—É—á—à–µ–Ω–∏–µ |
|---------|----|----|-----------|
| **User 6: –ø–æ–∫—Ä—ã—Ç–∏–µ** | 0.7% (1/129) | 100% (2 —Ç–µ–º—ã) | **+99.3%** |
| **User 19: –ø–æ–∫—Ä—ã—Ç–∏–µ** | 0% (0/8) | 100% (8 –ø–æ—Å—Ç–æ–≤) | **+100%** |
| **429 –æ—à–∏–±–æ–∫** | 15+ | 1 | **-93%** |
| **Staggering** | –ù–µ—Ç (–≤—Å–µ 09:00) | –î–∞ (09:00, 09:05) | ‚úÖ |

### 2. Cleanup –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| **–ë—ã–ª–æ untagged** | 9 –ø–æ—Å—Ç–æ–≤ |
| **–°–µ–π—á–∞—Å untagged** | 0 –ø–æ—Å—Ç–æ–≤ ‚úÖ |
| **Batch –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è** | ‚úÖ 9 –ø–æ—Å—Ç–æ–≤ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ |
| **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π cleanup** | ‚úÖ –ö–∞–∂–¥—ã–µ 2 —á–∞—Å–∞ |
| **Manual cleanup** | ‚úÖ `POST /rag/cleanup/backlog` |

---

## üî¥ –í–ê–ñ–ù–û: –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤)

### –ù–∞–π–¥–µ–Ω–æ: CLEANUP_ENABLED=true

**‚ö†Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –í–ö–õ–Æ–ß–ï–ù–û!**

### –ö–∞–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã —É–¥–∞–ª—è—é—Ç –ø–æ—Å—Ç—ã:

#### 1. CleanupService (`telethon/cleanup_service.py`)
- **–£–¥–∞–ª—è–µ—Ç:** –ü–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ `(last_post_date - retention_days)` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
- **–ö–æ–≥–¥–∞:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 (–µ—Å–ª–∏ `CLEANUP_ENABLED=true`)
- **User 6:** retention_days = 30 –¥–Ω–µ–π

#### 2. DataRetentionService (`telethon/maintenance/data_retention.py`)
- **–£–¥–∞–ª—è–µ—Ç:** –ü–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ 120 –¥–Ω–µ–π (–≥–ª–æ–±–∞–ª—å–Ω–æ)
- **–£–¥–∞–ª—è–µ—Ç –∏–∑:** PostgreSQL + Neo4j + Qdrant (sync)
- **–ö–æ–≥–¥–∞:** –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)

### –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è:

‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π retention:** 1 –¥–µ–Ω—å (–Ω–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–≤–µ–∂–∏–µ –ø–æ—Å—Ç—ã)  
‚úÖ **Per-user filtering:** –£–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è  
‚úÖ **Per-channel calculation:** –†–∞—Å—á–µ—Ç –æ—Ç last_post_date –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞

---

## üõ°Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

**–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω—ã –≤—Å–µ –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**

```bash
# 1. –í —Ñ–∞–π–ª–µ .env:
CLEANUP_ENABLED=false

# 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å telethon:
docker restart telethon

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞:
docker exec telethon python -c "import os; print(os.getenv('CLEANUP_ENABLED'))"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: false
```

### –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –£–≤–µ–ª–∏—á–∏—Ç—å retention_days

**–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç—ã –¥–æ–ª—å—à–µ:**

```sql
-- –í–æ–π—Ç–∏ –≤ PostgreSQL:
docker exec -it postgres psql -U n8n -d n8n

-- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 1 –≥–æ–¥ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö:
UPDATE users SET retention_days = 365;

-- –ò–ª–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
UPDATE users SET retention_days = 365 WHERE id = 6;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞:
SELECT id, telegram_id, retention_days FROM users;
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤—ã–ø–æ–ª–Ω–µ–Ω–æ)

### Phase 1: Rate Limiter ‚úÖ
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã: aiolimiter + tenacity
- ‚úÖ –°–æ–∑–¥–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω—ã–π rate limiter (1 concurrent request)
- ‚úÖ Embeddings —Å exponential backoff retry
- ‚úÖ Sequential –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º –≤ AI –¥–∞–π–¥–∂–µ—Å—Ç–∞—Ö

### Phase 2: Staggering ‚úÖ
- ‚úÖ User 19: 09:00 MSK
- ‚úÖ User 6: 09:05 MSK (+5 –º–∏–Ω—É—Ç)

### Phase 3: Fallback ‚úÖ
- ‚úÖ Fallback –¥–∞–π–¥–∂–µ—Å—Ç (—Ç–æ–ø-20 –ø–æ views)
- ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞—é—Ç –¥–∞–π–¥–∂–µ—Å—Ç

### Phase 4: Cleanup –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ ‚úÖ
- ‚úÖ CleanupService –¥–ª—è untagged/unindexed –ø–æ—Å—Ç–æ–≤
- ‚úÖ Scheduled cleanup –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
- ‚úÖ Manual endpoint: `/rag/cleanup/backlog`
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: `/rag/cleanup/stats`

### Phase 5: Neo4j Backfill ‚úÖ
- ‚úÖ –°–∫—Ä–∏–ø—Ç: `telethon/scripts/backfill_neo4j.py`

---

## ‚ùì –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã

### Q: –ú–æ–≥—É—Ç –ª–∏ —Å–µ—Ä–≤–∏—Å—ã —É–¥–∞–ª—è—Ç—å –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?

**A: –î–ê, –Ω–æ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö:**

1. **CleanupScheduler** - –í–ö–õ–Æ–ß–ï–ù (`CLEANUP_ENABLED=true`)
   - –£–¥–∞–ª—è–µ—Ç –ø–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ retention_days (30 –¥–Ω–µ–π –¥–ª—è User 6)
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 03:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

2. **–ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å:**
   ```bash
   # –í .env:
   CLEANUP_ENABLED=false
   docker restart telethon
   ```

3. **–ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å retention:**
   ```sql
   UPDATE users SET retention_days = 365;  -- 1 –≥–æ–¥
   ```

### Q: –ü–æ—á–µ–º—É cleanup –ø–æ–∫–∞–∑—ã–≤–∞–ª 404 –æ—à–∏–±–∫–∏?

**A: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç API**
- –ë—ã–ª–æ: `telethon:8001` (auth server) ‚Üí 404
- –°—Ç–∞–ª–æ: `telethon:8010` (main API) ‚Üí 200
- –ü–æ—Å—Ç—ã 720-728 –ù–ï –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã, –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ `telethon/rag_service/cleanup_service.py`

---

## üìà –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –î–∞–π–¥–∂–µ—Å—Ç—ã (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):
```json
User 6: {
  "posts_count": 145,
  "digest": "AI-–¥–∞–π–¥–∂–µ—Å—Ç —Å 2 —Ç–µ–º–∞–º–∏ (–ë–ª–æ–∫—á–µ–π–Ω + –ê–≤—Ç–æ)",
  "ai_generated": true
}

User 19: {
  "posts_count": 8,
  "digest": "Fallback –¥–∞–π–¥–∂–µ—Å—Ç (—Ç–æ–ø-–ø–æ—Å—Ç—ã –ø–æ views)",
  "ai_generated": true,
  "fallback": true
}
```

### Cleanup (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π):
```json
{
  "untagged_posts": 0,       // ‚úÖ –í—Å–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
  "unindexed_posts": 0,      // ‚úÖ –í—Å–µ –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã
  "failed_tagging": 0,       // ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫
  "failed_indexing": 0,      // ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫
  "total_backlog": 0         // ‚úÖ –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞
}
```

### Rate Limiting:
- ‚úÖ **429 –æ—à–∏–±–æ–∫:** 1 (–±—ã–ª–æ 15+) ‚Üí —É–ª—É—á—à–µ–Ω–∏–µ 93%
- ‚úÖ **Sequential processing:** –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ rate limiter
- ‚úÖ **Retry –º–µ—Ö–∞–Ω–∏–∑–º:** 3 –ø–æ–ø—ã—Ç–∫–∏ —Å exponential backoff

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### 1. –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

```bash
# –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω—ã –í–°–ï –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
echo "CLEANUP_ENABLED=false" >> /home/ilyasni/n8n-server/n8n-installer/telethon/.env
docker restart telethon
```

### 2. –ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å retention –¥–æ 1 –≥–æ–¥–∞

```sql
docker exec -it postgres psql -U n8n -d n8n
UPDATE users SET retention_days = 365;
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤—Ç—Ä–∞—à–Ω–∏—Ö –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤

```bash
# –í 09:00-09:10 MSK –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
docker logs rag-service --tail 200 | grep -E "(–¥–∞–π–¥–∂–µ—Å—Ç|429|fallback)"

# –û–∂–∏–¥–∞–µ—Ç—Å—è:
# 09:00 - User 19 –¥–∞–π–¥–∂–µ—Å—Ç
# 09:05 - User 6 –¥–∞–π–¥–∂–µ—Å—Ç
# –ú–∏–Ω–∏–º—É–º 429 –æ—à–∏–±–æ–∫
```

### 4. Neo4j backfill (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –ï—Å–ª–∏ –Ω—É–∂–µ–Ω knowledge graph:
docker exec rag-service python /app/scripts/backfill_neo4j.py 1000
```

---

## üìÅ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. **`DIGEST_ISSUE_REPORT.md`** - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
2. **`DIGEST_FIX_COMPLETE.md`** - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π
3. **`CLEANUP_SERVICES_AUDIT.md`** - –ê—É–¥–∏—Ç —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤
4. **`IMPLEMENTATION_SUMMARY_DIGEST_FIX.md`** - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π summary
5. **`FINAL_SUMMARY.md`** - –≠—Ç–æ—Ç –æ—Ç—á–µ—Ç

---

## ‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã

- [x] Rate limiter —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–æ–±–∞–≤–ª–µ–Ω
- [x] AI –¥–∞–π–¥–∂–µ—Å—Ç—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã (sequential)
- [x] Staggering —Ä–∞–±–æ—Ç–∞–µ—Ç (5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
- [x] Fallback –¥–∞–π–¥–∂–µ—Å—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] Cleanup service —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] –í—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
- [x] Neo4j backfill —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- [x] –ê—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω
- [x] –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—é cleanup –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω—ã

---

**–°—Ç–∞—Ç—É—Å:** üéâ **SUCCESS**  
**–î–∞–π–¥–∂–µ—Å—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç:** ‚úÖ  
**Cleanup —Ä–∞–±–æ—Ç–∞–µ—Ç:** ‚úÖ  
**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞:** ‚úÖ


