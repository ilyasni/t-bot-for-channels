# üîç –ê—É–¥–∏—Ç —Å–µ—Ä–≤–∏—Å–æ–≤ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤

**–î–∞—Ç–∞:** 15 –æ–∫—Ç—è–±—Ä—è 2025  
**–ö—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç—å:** üî¥ –í–´–°–û–ö–ê–Ø  
**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## ‚ö†Ô∏è –ù–ê–ô–î–ï–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –í–ö–õ–Æ–ß–ï–ù–û!

```bash
CLEANUP_ENABLED=true  # ‚Üê –í–ö–õ–Æ–ß–ï–ù!
```

---

## üî¥ –°–µ—Ä–≤–∏—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–∞–ª—è—é—Ç –ø–æ—Å—Ç—ã

### 1. CleanupService (`telethon/cleanup_service.py`)

**–ß—Ç–æ —É–¥–∞–ª—è–µ—Ç:**
- –ü–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ `(last_post_date - retention_days)` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
- –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `retention_days = 30` –¥–Ω–µ–π

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:** –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 03:00 (–µ—Å–ª–∏ `CLEANUP_ENABLED=true`)
- **–í—Ä—É—á–Ω—É—é:** –ß–µ—Ä–µ–∑ API endpoints

**–õ–æ–≥–∏–∫–∞:**
```python
# –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞:
last_post_date = max(Post.posted_at)  # –ù–∞–ø—Ä–∏–º–µ—Ä, 2025-10-14
cutoff_date = last_post_date - timedelta(days=retention_days)  # 2025-09-14
# –£–¥–∞–ª—è–µ—Ç: Post.posted_at < 2025-09-14
```

**–§–∞–π–ª—ã:**
- `telethon/cleanup_service.py` - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
- `telethon/maintenance/cleanup_scheduler.py` - Scheduler (3:00 AM)

---

### 2. DataRetentionService (`telethon/maintenance/data_retention.py`)

**–ß—Ç–æ —É–¥–∞–ª—è–µ—Ç:**
- –ü–æ—Å—Ç—ã —Å—Ç–∞—Ä—à–µ `retention_days` (–≥–ª–æ–±–∞–ª—å–Ω–æ, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 120 –¥–Ω–µ–π)
- –¢–∞–∫–∂–µ —É–¥–∞–ª—è–µ—Ç –∏–∑ Neo4j –∏ Qdrant

**–ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:** –ï—Å–ª–∏ `CLEANUP_ENABLED=true` (—á–µ—Ä–µ–∑ cleanup_scheduler)
- **–í—Ä—É—á–Ω—É—é:** –ß–µ—Ä–µ–∑ maintenance —Å–∫—Ä–∏–ø—Ç—ã

**–õ–æ–≥–∏–∫–∞:**
```python
cutoff_date = datetime.now(timezone.utc) - timedelta(days=retention_days)
# –£–¥–∞–ª—è–µ—Ç: Post.posted_at < cutoff_date
```

**Sync cleanup:**
1. PostgreSQL ‚Üí —É–¥–∞–ª—è–µ—Ç –ø–æ—Å—Ç—ã
2. Neo4j ‚Üí —É–¥–∞–ª—è–µ—Ç Post nodes
3. Qdrant ‚Üí —É–¥–∞–ª—è–µ—Ç vectors

---

## üîé –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### User 6:
- **retention_days:** 30 –¥–Ω–µ–π
- **–ü–æ—Å—Ç—ã 720-728:** posted 2025-10-14 (1 –¥–µ–Ω—å –Ω–∞–∑–∞–¥)
- **–°—Ç–∞—Ç—É—Å:** –ù–ï –î–û–õ–ñ–ù–´ —É–¥–∞–ª—è—Ç—å—Å—è (—Å–≤–µ–∂–∏–µ)
- **–°–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ë–î:** ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—Ç, status=pending

### Cleanup Schedule:
- **–í–∫–ª—é—á–µ–Ω:** ‚úÖ CLEANUP_ENABLED=true
- **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ:** 03:00 –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
- **–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

---

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å 404 –æ—à–∏–±–∫–∞–º–∏

### –ü—Ä–∏—á–∏–Ω–∞ 404:

**Cleanup –≤—ã–∑—ã–≤–∞–ª –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—Ç:**
```python
# –ë–´–õ–û:
telethon_api_url = "http://telethon:8001"  # ‚Üê Auth web server (QR login)

# –°–¢–ê–õ–û:
telethon_api_url = "http://telethon:8010"  # ‚Üê Main FastAPI app
```

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ port–æ–≤ telethon:**
- `8001` - auth_web_server (QR –ª–æ–≥–∏–Ω)
- `8010` - main.app (FastAPI —Å endpoints –¥–ª—è —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** `telethon/rag_service/cleanup_service.py` —Å—Ç—Ä–æ–∫–∞ 56

---

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

### –¢–µ–∫—É—â–∏–µ safeguards:

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π retention:**
   ```python
   self.min_retention_days = 1  # –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç—ã —Å–≤–µ–∂–µ–µ 1 –¥–Ω—è
   ```

2. **–í–∞–ª–∏–¥–∞—Ü–∏—è retention_days:**
   ```python
   if retention_days < self.min_retention_days:
       retention_days = self.min_retention_days
   ```

3. **Per-channel cleanup:**
   - –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
   - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç `last_post_date` –∫–∞–Ω–∞–ª–∞

4. **User_id filtering:**
   - –£–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ù–µ—Ç cross-user deletion

---

## üö® –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò

### –ö–†–ò–¢–ò–ß–ù–û: –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ

**–ï—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª—è—Ç—å –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**

```bash
# –í .env —Ñ–∞–π–ª–µ:
CLEANUP_ENABLED=false

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å telethon
docker restart telethon
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
docker exec telethon python -c "import os; print(f'CLEANUP_ENABLED={os.getenv(\"CLEANUP_ENABLED\")}')"
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: CLEANUP_ENABLED=false
```

---

### –í–ê–ñ–ù–û: –£–≤–µ–ª–∏—á–∏—Ç—å retention_days

**–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å—Ç—ã –¥–æ–ª—å—à–µ:**

```sql
-- –î–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:
UPDATE users SET retention_days = 365 WHERE id > 0;

-- –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
UPDATE users SET retention_days = 365 WHERE id = 6;
```

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:**
- 365 –¥–Ω–µ–π (1 –≥–æ–¥) - –¥–ª—è –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- 180 –¥–Ω–µ–π (6 –º–µ—Å—è—Ü–µ–≤) - –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∏ —Ä–∞–∑–º–µ—Ä–æ–º –ë–î
- 90 –¥–Ω–µ–π (3 –º–µ—Å—è—Ü–∞) - –º–∏–Ω–∏–º—É–º –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É–¥–∞–ª–µ–Ω–∏–π

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ:

```bash
# –õ–æ–≥–∏ cleanup
docker logs telethon | grep -E "(—É–¥–∞–ª–µ–Ω–æ.*–ø–æ—Å—Ç–æ–≤|posts deleted)" -i

# –ü–æ—Å–ª–µ–¥–Ω–∏–π cleanup
docker logs telethon | grep "üßπ –ó–∞–ø—É—Å–∫ –æ—á–∏—Å—Ç–∫–∏" -A10
```

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:

```sql
-- –ü–æ—Å—Ç—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
SELECT COUNT(*) FROM posts 
WHERE user_id = 6 
AND posted_at > NOW() - INTERVAL '30 days';

-- –°–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –ø–æ—Å—Ç
SELECT MIN(posted_at) FROM posts WHERE user_id = 6;

-- –°–∞–º—ã–π –Ω–æ–≤—ã–π –ø–æ—Å—Ç
SELECT MAX(posted_at) FROM posts WHERE user_id = 6;
```

---

## ‚úÖ –ò—Ç–æ–≥–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤:

1. **–û—Ç–∫–ª—é—á–∏—Ç—å cleanup (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–µ–Ω):**
   ```bash
   # –í .env:
   CLEANUP_ENABLED=false
   docker restart telethon
   ```

2. **–ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å retention:**
   ```sql
   UPDATE users SET retention_days = 365;  # 1 –≥–æ–¥
   ```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   ```bash
   # –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ª–æ–≥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–æ—Å–ª–µ 03:00:
   docker logs telethon | grep "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
   ```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ö—Ç–æ –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø–æ—Å—Ç—ã:

1. **CleanupScheduler** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (03:00 AM, –µ—Å–ª–∏ enabled)
2. **–ê–¥–º–∏–Ω—ã** - —á–µ—Ä–µ–∑ API `/api/admin/user/{user_id}/cleanup`
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** - –ù–ï –ú–û–ì–£–¢ —É–¥–∞–ª—è—Ç—å —Å–≤–æ–∏ –ø–æ—Å—Ç—ã (–∑–∞—â–∏—â–µ–Ω–æ)

### Cascade delete:

```python
# models.py
# –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–∞ ‚Üí –ø–æ—Å—Ç—ã –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
# –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Üí –ø–æ—Å—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è (CASCADE)
```

---

## ‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï

**404 –æ—à–∏–±–∫–∏ –≤ cleanup –ù–ï –æ–∑–Ω–∞—á–∞—é—Ç —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤!**

–≠—Ç–æ –±—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ API:
- ‚ùå telethon:8001 (auth server) - 404
- ‚úÖ telethon:8010 (main API) - 200

**–ü–æ—Å—Ç—ã 720-728:**
- ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ë–î
- ‚úÖ –ù–ï —É–¥–∞–ª–µ–Ω—ã
- ‚úÖ –ë—É–¥—É—Ç –ø—Ä–æ—Ç–µ–≥–∏—Ä–æ–≤–∞–Ω—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä—Ç–∞

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞:** 15 –æ–∫—Ç—è–±—Ä—è 2025

