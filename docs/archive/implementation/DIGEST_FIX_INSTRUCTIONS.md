# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º —Å –¥–∞–π–¥–∂–µ—Å—Ç–∞–º–∏

**–î–∞—Ç–∞:** 15 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–æ–±–ª–µ–º–∞:** AI-–¥–∞–π–¥–∂–µ—Å—Ç—ã –ø—É—Å—Ç—ã–µ –∏–∑-–∑–∞ GigaChat Rate Limit (429 Too Many Requests)

---

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç Rate Limit

**–§–∞–π–ª:** `telethon/rag_service/ai_digest_generator.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞ 500ms –º–µ–∂–¥—É –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Ç–µ–º
- ‚úÖ Retry —Å exponential backoff (1s ‚Üí 2s ‚Üí 3s) –¥–ª—è 429 –æ—à–∏–±–æ–∫
- ‚úÖ –ú–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã
- ‚úÖ Fallback –Ω–∞ –æ–±—ã—á–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –µ—Å–ª–∏ AI-–¥–∞–π–¥–∂–µ—Å—Ç –ø—É—Å—Ç–æ–π

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ GigaChat
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ Rate Limit
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç (AI –∏–ª–∏ –æ–±—ã—á–Ω—ã–π)

---

### 2. –î–æ–±–∞–≤–ª–µ–Ω Fallback –¥–∞–π–¥–∂–µ—Å—Ç

**–ú–µ—Ç–æ–¥:** `_generate_fallback_digest()`

**–õ–æ–≥–∏–∫–∞:**
1. –ï—Å–ª–∏ AI-–¥–∞–π–¥–∂–µ—Å—Ç –ø—É—Å—Ç–æ–π (–≤—Å–µ —Ç–µ–º—ã –≤–µ—Ä–Ω—É–ª–∏ 0 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ–±—ã—á–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç –∏–∑ –ë–î
3. –¢–æ–ø-20 –ø–æ—Å—Ç–æ–≤ –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥
4. –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞–Ω–∞–ª–∞–º
5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "AI-–¥–∞–π–¥–∂–µ—Å—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ø-–ø–æ—Å—Ç—ã"

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –í–°–ï–ì–î–ê –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç
- –î–∞–∂–µ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –æ—Ç–∫–∞–∑–µ GigaChat API
- –î–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å Qdrant –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–µ–π

---

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
docker exec telethon python /app/scripts/debug_digest.py

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
docker exec telethon python /app/scripts/check_qdrant.py
```

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–µ–π

**–§–∞–π–ª—ã —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:**

```bash
cd /home/ilyasni/n8n-server/n8n-installer

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å RAG Service
docker stop rag-service

# –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º
docker-compose up -d --build rag-service

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs -f rag-service
```

### –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–π–¥–∂–µ—Å—Ç–∞:**

```bash
# –î–ª—è user 6
curl -X POST http://localhost:8020/rag/digest/generate \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 6,
    "date_from": "2025-10-14T00:00:00Z",
    "date_to": "2025-10-15T23:59:59Z",
    "format": "markdown",
    "max_posts": 20
  }'

# –î–ª—è user 19
curl -X POST http://localhost:8020/rag/digest/generate \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 19,
    "date_from": "2025-10-14T00:00:00Z",
    "date_to": "2025-10-15T23:59:59Z",
    "format": "markdown",
    "max_posts": 20
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –î–∞–π–¥–∂–µ—Å—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞ 5-15 —Å–µ–∫—É–Ω–¥
- ‚úÖ –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º—ã 1/5", "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–º—ã 2/5", ...
- ‚úÖ –ü—Ä–∏ Rate Limit: "‚ö†Ô∏è Rate limit –¥–ª—è —Ç–µ–º—ã 'AI', –ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 1.0s..."
- ‚úÖ –ï—Å–ª–∏ –≤—Å–µ —Ç–µ–º—ã –ø—É—Å—Ç—ã–µ: "‚ö†Ô∏è AI-–¥–∞–π–¥–∂–µ—Å—Ç –ø—É—Å—Ç–æ–π, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º fallback"
- ‚úÖ –î–∞–π–¥–∂–µ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ—Å—Ç—ã (AI –∏–ª–∏ fallback)

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–∞–π–¥–∂–µ—Å—Ç–∞

**–î–∞–π–¥–∂–µ—Å—Ç—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ 09:00 MSK:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
docker exec rag-service python -c "
from rag_service.scheduler import digest_scheduler
jobs = digest_scheduler.scheduler.get_jobs()
for job in jobs:
    print(f'{job.id}: next run at {job.next_run_time}')
"

# –ó–∞–≤—Ç—Ä–∞ –≤ 09:00 –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker logs rag-service --tail 100 | grep -E "(–¥–∞–π–¥–∂–µ—Å—Ç|Rate limit|fallback)"
```

---

## üîß –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –¥–Ω—è)

#### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å sentence-transformers –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ fallback

```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ requirements.txt
echo "sentence-transformers>=2.2.0" >> telethon/rag_service/requirements.txt
echo "torch>=2.0.0" >> telethon/rag_service/requirements.txt

# –ü–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å
docker-compose up -d --build rag-service
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –ü—Ä–∏ 429 –æ—Ç GigaChat ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–µ embeddings
- –î–∞–π–¥–∂–µ—Å—Ç –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è (–¥–∞–∂–µ –±–µ–∑ GigaChat)

#### 2. –£–≤–µ–ª–∏—á–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏

**–ï—Å–ª–∏ 500ms –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ:**
```python
# –í ai_digest_generator.py —Å—Ç—Ä–æ–∫–∞ 79
await asyncio.sleep(1.0)  # –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 1 —Å–µ–∫—É–Ω–¥—ã
```

#### 3. –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–º

**–î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ç–µ–º:**
```python
# –í models.py –∏–∑–º–µ–Ω–∏—Ç—å default
topics_limit = Column(Integer, default=3)  # –ë—ã–ª–æ 5, —Å—Ç–∞–ª–æ 3
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ API:**
```bash
curl -X PUT http://localhost:8020/rag/digest/settings/6 \
  -H "Content-Type: application/json" \
  -d '{"topics_limit": 3}'
```

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (1-2 –Ω–µ–¥–µ–ª–∏)

#### 4. –°–º–µ—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤

**–ò–∑–±–µ–∂–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:**

```sql
-- User 6: 09:00
UPDATE digest_settings SET time = '09:00' WHERE user_id = 6;

-- User 19: 09:05 (—Å–¥–≤–∏–≥ –Ω–∞ 5 –º–∏–Ω—É—Ç)
UPDATE digest_settings SET time = '09:05' WHERE user_id = 19;
```

#### 5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ embeddings –¥–ª—è –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ–º

**–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É topic_embeddings:**
```sql
CREATE TABLE topic_embeddings (
    topic VARCHAR PRIMARY KEY,
    embedding VECTOR(768),
    created_at TIMESTAMP,
    expires_at TIMESTAMP
);
```

**–≠—Ñ—Ñ–µ–∫—Ç:**
- –¢–µ–º—ã "AI", "–∞–≤—Ç–æ", "—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" ‚Üí embeddings –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 7 –¥–Ω–µ–π
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ GigaChat –Ω–∞ 70-80%

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è

```bash
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ 429 –æ—à–∏–±–æ–∫ –∑–∞ –¥–µ–Ω—å
docker logs rag-service --since 24h | grep -c "429"

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
docker logs rag-service --since 24h | grep -c "‚úÖ –î–∞–π–¥–∂–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ fallback –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
docker logs rag-service --since 24h | grep -c "Fallback: –æ–±—ã—á–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç"
```

### –ê–ª–µ—Ä—Ç—ã

**–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø–æ–≤–µ—â–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
- üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ: > 50% –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç fallback
- üü° –í–Ω–∏–º–∞–Ω–∏–µ: > 10 –æ—à–∏–±–æ–∫ 429 –∑–∞ —á–∞—Å
- üü¢ –ù–æ—Ä–º–∞: < 5% fallback –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤

---

## ‚ùì FAQ

### Q: –ß—Ç–æ –µ—Å–ª–∏ –¥–∞–π–¥–∂–µ—Å—Ç –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ–π?

**A:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –ï—Å—Ç—å –ª–∏ –ø–æ—Å—Ç—ã –≤ –ë–î –∑–∞ –ø–µ—Ä–∏–æ–¥: `SELECT COUNT(*) FROM posts WHERE user_id=6 AND posted_at >= NOW() - INTERVAL '1 day'`
2. –†–∞–±–æ—Ç–∞–µ—Ç –ª–∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è: `docker exec telethon python /app/scripts/check_qdrant.py`
3. –ï—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö: `docker logs rag-service --tail 100`

### Q: –ö–∞–∫ –æ—Ç–∫–ª—é—á–∏—Ç—å AI-–¥–∞–π–¥–∂–µ—Å—Ç –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–π?

**A:** –ß–µ—Ä–µ–∑ API:
```bash
curl -X PUT http://localhost:8020/rag/digest/settings/6 \
  -H "Content-Type: application/json" \
  -d '{"ai_summarize": false}'
```

### Q: –ö–∞–∫ —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤ –≤ –¥–∞–π–¥–∂–µ—Å—Ç–µ?

**A:** –ß–µ—Ä–µ–∑ API:
```bash
curl -X PUT http://localhost:8020/rag/digest/settings/6 \
  -H "Content-Type: application/json" \
  -d '{"max_posts": 50}'
```

### Q: –ü–æ—á–µ–º—É User 18 –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–π–¥–∂–µ—Å—Ç—ã?

**A:** –£ –Ω–µ–≥–æ –Ω–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∞–π–¥–∂–µ—Å—Ç–∞. –°–æ–∑–¥–∞—Ç—å —á–µ—Ä–µ–∑ API:
```bash
curl -X PUT http://localhost:8020/rag/digest/settings/18 \
  -H "Content-Type: application/json" \
  -d '{
    "enabled": true,
    "frequency": "daily",
    "time": "09:00",
    "max_posts": 20
  }'
```

–ù–æ —É –Ω–µ–≥–æ —Ç–∞–∫–∂–µ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –∫–∞–Ω–∞–ª—ã –∏ –ø–æ—Å—Ç–æ–≤ –≤ –ë–î.

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

- [ ] RAG Service –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω —Å –Ω–æ–≤—ã–º –∫–æ–¥–æ–º
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π –¥–∞–π–¥–∂–µ—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∑–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É —Ç–µ–º–∞–º–∏
- [ ] –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç retry –ø—Ä–∏ 429 –æ—à–∏–±–∫–∞—Ö
- [ ] Fallback –¥–∞–π–¥–∂–µ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (—Ç–µ—Å—Ç —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º GigaChat)
- [ ] –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–∫—Ä–∏–ø—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ó–∞–≤—Ç—Ä–∞—à–Ω–∏–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–ö–æ–Ω—Ç–∞–∫—Ç—ã:** –°–º. DIGEST_ISSUE_REPORT.md –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–±–ª–µ–º—ã  
**–î–∞—Ç–∞:** 15 –æ–∫—Ç—è–±—Ä—è 2025

