# üñºÔ∏è Vision AI –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ Groups - Future Feature

**–°—Ç–∞—Ç—É—Å:** üìã Planned (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 13 –æ–∫—Ç—è–±—Ä—è 2025  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** Medium  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** Medium

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ –∏–¥–µ–∏

–†–∞—Å—à–∏—Ä–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Groups –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∞–Ω–∞–ª–∏–∑–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** —á–µ—Ä–µ–∑ Vision AI.

**–ß—Ç–æ –±—É–¥–µ—Ç:**
- üì∏ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–∞—Ö
- ü§ñ AI-–æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫
- üìä –í–∫–ª—é—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö –≤ –¥–∞–π–¥–∂–µ—Å—Ç—ã
- üîç –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (—Å–≤—è–∑—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–±—Å—É–∂–¥–µ–Ω–∏–µ–º)

**Use Case:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: /group_digest 6

–î–∞–π–¥–∂–µ—Å—Ç:
üìä –ì—Ä—É–ø–ø–∞: Design Team
–ü–µ—Ä–∏–æ–¥: 6 hours
–°–æ–æ–±—â–µ–Ω–∏–π: 45
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: 12 üì∏

–¢–µ–º—ã:
‚Ä¢ –†–µ–¥–∏–∑–∞–π–Ω –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
‚Ä¢ –ù–æ–≤–∞—è —Ü–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞

–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:
üì∏ @designer1: –ú–∞–∫–µ—Ç –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
üì∏ @designer2: –ü–∞–ª–∏—Ç—Ä–∞ –≤ —Å–∏–Ω–∏—Ö —Ç–æ–Ω–∞—Ö (#1E40AF, #3B82F6)
üì∏ @developer1: –°–∫—Ä–∏–Ω—à–æ—Ç –±–∞–≥–∞ —Å –∫—Ä–∞—Å–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π

–†–µ–∑—é–º–µ: –ö–æ–º–∞–Ω–¥–∞ —É—Ç–≤–µ—Ä–¥–∏–ª–∞ –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω...
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ

### ‚ùå GigaChat-Vision –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–û—à–∏–±–∫–∞ –≤ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏:**
```python
# ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û - —Ç–∞–∫–æ–π –º–æ–¥–µ–ª–∏ –Ω–µ—Ç!
"model": "GigaChat-Vision"  # NO! Doesn't exist!
```

**–§–∞–∫—Ç—ã:**
- GigaChat **—É–º–µ–µ—Ç** —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ–∫—Ç—è–±—Ä—è 2024 ([–∏—Å—Ç–æ—á–Ω–∏–∫](https://consult-cct.ru/gigachat-nauchilsya-raspoznavat-izobrazheniya))
- –†–∞—Å–ø–æ–∑–Ω–∞–µ—Ç: —Ç–µ–∫—Å—Ç (–ø–µ—á–∞—Ç–Ω—ã–π/—Ä—É–∫–æ–ø–∏—Å–Ω—ã–π), —Ñ–æ—Ä–º—É–ª—ã, –≥—Ä–∞—Ñ–∏–∫–∏, —Ç–∞–±–ª–∏—Ü—ã
- –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ **–æ–±—ã—á–Ω—É—é –º–æ–¥–µ–ª—å GigaChat** + API "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [developers.sber.ru/docs/ru/gigachat/guides](https://developers.sber.ru/docs/ru/gigachat/guides/main) ‚Üí "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"

---

## ‚úÖ –†–∞–±–æ—á–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã Vision AI

### –í–∞—Ä–∏–∞–Ω—Ç 1: Ollama LLaVA (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π (–Ω–µ—Ç –∑–∞—Ç—Ä–∞—Ç –Ω–∞ API)
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π
- ‚úÖ Ollama —É–∂–µ –µ—Å—Ç—å –≤ docker-compose
- ‚úÖ –•–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å (–¥–∞–Ω–Ω—ã–µ –Ω–µ —É—Ö–æ–¥—è—Ç –≤ –æ–±–ª–∞–∫–æ)

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç GPU –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã
- ‚ö†Ô∏è –ú–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±–ª–∞—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π (30-60 —Å–µ–∫)

**–ö–æ–¥:**
```python
async def _analyze_image_ollama(self, base64_image: str) -> str:
    """–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Ollama LLaVA (–ª–æ–∫–∞–ª—å–Ω—ã–π)"""
    
    async with httpx.AsyncClient(timeout=60.0) as client:
        response = await client.post(
            "http://ollama:11434/api/generate",
            json={
                "model": "llava",
                "prompt": "Describe this image briefly in Russian (1-2 sentences)",
                "images": [base64_image],
                "stream": False
            }
        )
        
        return response.json().get("response", "[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]")
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
# –°–∫–∞—á–∞—Ç—å –º–æ–¥–µ–ª—å LLaVA
docker exec ollama ollama pull llava

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å
docker exec ollama ollama list | grep llava
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: Google Gemini 2.0 Flash

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier (15 requests/min)
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π (2-5 —Å–µ–∫)
- ‚úÖ –•–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä—É—Å—Å–∫–∏–º
- ‚úÖ OpenRouter —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç
- ‚ö†Ô∏è Rate limits

**–ö–æ–¥:**
```python
async def _analyze_image_gemini(self, base64_image: str) -> str:
    """–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ Google Gemini (OpenRouter)"""
    
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {os.getenv('OPENROUTER_API_KEY')}",
                "Content-Type": "application/json"
            },
            json={
                "model": "google/gemini-2.0-flash-exp:free",
                "messages": [
                    {
                        "role": "user",
                        "content": [
                            {"type": "text", "text": "–û–ø–∏—à–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫—Ä–∞—Ç–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)"},
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{base64_image}"
                                }
                            }
                        ]
                    }
                ],
                "max_tokens": 150
            }
        )
        
        return response.json()["choices"][0]["message"]["content"]
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 3: OpenAI GPT-4o

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –õ—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ
- ‚úÖ –ë—ã—Å—Ç—Ä—ã–π
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω—ã–π

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- ‚ùå –ü–ª–∞—Ç–Ω—ã–π (~$0.01 –∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
- ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç

**–ö–æ–¥:**
```python
async def _analyze_image_openai(self, base64_image: str) -> str:
    """–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GPT-4o Vision (OpenRouter)"""
    
    async with httpx.AsyncClient(timeout=30.0) as client:
        response = await client.post(
            "https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {os.getenv('OPENROUTER_API_KEY')}",
                "Content-Type": "application/json"
            },
            json={
                "model": "openai/gpt-4o",
                "messages": [
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": "–û–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ —á—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º)"
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": f"data:image/jpeg;base64,{base64_image}"
                                }
                            }
                        ]
                    }
                ],
                "max_tokens": 150
            }
        )
        
        return response.json()["choices"][0]["message"]["content"]
```

---

### –í–∞—Ä–∏–∞–Ω—Ç 4: GigaChat (—á–µ—Ä–µ–∑ API "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤")

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ gpt2giga-proxy

**–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π –∫–æ–¥:**
```python
async def _analyze_image_gigachat(self, photo_bytes: bytes) -> str:
    """–ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ GigaChat API (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è proxy)"""
    
    # 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
    async with httpx.AsyncClient(timeout=30.0) as client:
        files = {'file': ('image.jpg', photo_bytes, 'image/jpeg')}
        
        upload_response = await client.post(
            "http://gpt2giga-proxy:8090/v1/files",
            files=files
        )
        
        file_id = upload_response.json()['id']
        
        # 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —á–∞—Ç–µ
        chat_response = await client.post(
            "http://gpt2giga-proxy:8090/v1/chat/completions",
            json={
                "model": "GigaChat",  # –û–±—ã—á–Ω–∞—è –º–æ–¥–µ–ª—å
                "messages": [
                    {
                        "role": "user",
                        "content": "–û–ø–∏—à–∏ —á—Ç–æ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∫—Ä–∞—Ç–∫–æ",
                        "attachments": [file_id]  # –§–∞–π–ª —á–µ—Ä–µ–∑ attachments
                    }
                ]
            }
        )
        
        return chat_response.json()["choices"][0]["message"]["content"]
```

**–¢—Ä–µ–±—É–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é gpt2giga-proxy
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `/v1/files` endpoint
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. Database Changes

```python
# models.py

class GroupMention(Base):
    # ... existing fields ...
    
    # üÜï Media fields
    has_media = Column(Boolean, default=False)
    media_type = Column(String, nullable=True)  # photo, video, document
    media_description = Column(String, nullable=True)  # AI description
    media_analyzed = Column(Boolean, default=False)

class Group(Base):
    # ... existing fields ...
    
    # üÜï Vision AI settings
    vision_ai_enabled = Column(Boolean, default=False)
    vision_ai_provider = Column(String, default="ollama")  # ollama, gemini, openai
```

### 2. Service Layer

```python
# group_digest_generator.py

class GroupDigestGenerator:
    
    async def generate_digest(
        self,
        user_id: int,
        group_id: int,
        messages: List[Message],
        hours: int = 24,
        analyze_images: bool = True  # üÜï –ü–∞—Ä–∞–º–µ—Ç—Ä
    ) -> Dict[str, Any]:
        
        formatted_messages = []
        images_analyzed = 0
        
        for msg in messages:
            message_data = {
                "username": username,
                "text": msg.text or "",
                "date": msg.date.isoformat(),
                "media": None  # üÜï –ü–æ–ª–µ –¥–ª—è –º–µ–¥–∏–∞
            }
            
            # üÜï –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            if analyze_images and msg.media:
                if isinstance(msg.media, MessageMediaPhoto):
                    try:
                        # Download image
                        photo_bytes = await msg.download_media(bytes)
                        
                        # Convert to base64
                        import base64
                        photo_base64 = base64.b64encode(photo_bytes).decode()
                        
                        # Check size limit
                        size_mb = len(photo_bytes) / (1024 * 1024)
                        max_size = float(os.getenv("VISION_MAX_SIZE_MB", "5"))
                        
                        if size_mb <= max_size:
                            # Analyze via Vision AI
                            description = await self._analyze_image(photo_base64)
                            
                            message_data["media"] = {
                                "type": "photo",
                                "description": description,
                                "size_mb": round(size_mb, 2)
                            }
                            
                            images_analyzed += 1
                        else:
                            message_data["media"] = {
                                "type": "photo",
                                "description": "[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ]"
                            }
                    
                    except Exception as e:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")
                        message_data["media"] = {
                            "type": "photo",
                            "description": "[–æ—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏]"
                        }
            
            formatted_messages.append(message_data)
        
        logger.info(f"üì∏ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {images_analyzed}")
        
        # Send to n8n...
    
    async def _analyze_image(self, base64_image: str) -> str:
        """
        –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥–æ—Å—Ç—É–ø–Ω—ã–µ Vision AI
        
        Cascading fallback:
        1. Ollama LLaVA (–ª–æ–∫–∞–ª—å–Ω—ã–π)
        2. Google Gemini (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
        3. GPT-4o (–ø–ª–∞—Ç–Ω—ã–π)
        """
        vision_provider = os.getenv("VISION_AI_PROVIDER", "ollama")
        
        try:
            if vision_provider == "ollama":
                return await self._analyze_image_ollama(base64_image)
            elif vision_provider == "gemini":
                return await self._analyze_image_gemini(base64_image)
            elif vision_provider == "openai":
                return await self._analyze_image_openai(base64_image)
            else:
                # Fallback to Ollama
                return await self._analyze_image_ollama(base64_image)
        
        except Exception as e:
            logger.error(f"‚ùå Vision AI error ({vision_provider}): {e}")
            
            # Cascading fallback
            if vision_provider != "gemini":
                try:
                    return await self._analyze_image_gemini(base64_image)
                except:
                    pass
            
            return "[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ]"  # Final fallback
```

### 3. n8n Workflow Updates

```javascript
// group_digest_orchestrator.json

// –í —É–∑–ª–µ "Prepare Prompts" –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –º–µ–¥–∏–∞
const messages = $json.messages;
const textMessages = [];
const imageMessages = [];

messages.forEach(msg => {
    if (msg.text) {
        textMessages.push(msg);
    }
    
    if (msg.media && msg.media.description) {
        imageMessages.push({
            sender: msg.username,
            description: msg.media.description,
            type: msg.media.type
        });
    }
});

// –í –ø—Ä–æ–º–ø—Ç –¥–ª—è Agent 1 (Topic Extractor)
const topicPrompt = `
–ò–∑–≤–ª–µ–∫–∏ —Ç–µ–º—ã –∏–∑ –¥–∏–∞–ª–æ–≥–∞.

–¢–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è: ${textMessages.length}
–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${imageMessages.length}

${imageMessages.length > 0 ? `
–û–ø–∏—Å–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
${imageMessages.map(img => `- @${img.sender}: ${img.description}`).join('\n')}
` : ''}

–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞:
${textMessages.map(m => `@${m.username}: ${m.text}`).join('\n')}
`;

// –í Agent 4 (Aggregator) –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é images
const finalDigest = {
    topics: topics,
    speakers_summary: speakers,
    overall_summary: summary,
    images_count: imageMessages.length,
    images_summary: imageMessages.length > 0 
        ? imageMessages.map(img => `üì∏ @${img.sender}: ${img.description}`).join('\n')
        : null,
    message_count: messages.length,
    period: `${hours} hours`
};
```

### 4. Bot Command Updates

```python
# bot.py

async def group_digest_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """/group_digest [hours] [--no-images]"""
    
    args = context.args
    hours = 24
    analyze_images = True  # Default
    
    if args:
        hours = int(args[0])
        
        # –û–ø—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        if "--no-images" in args:
            analyze_images = False
    
    # Generate digest with images
    digest = await group_digest_generator.generate_digest(
        user_id=user.id,
        group_id=group.id,
        messages=messages,
        hours=hours,
        analyze_images=analyze_images  # üÜï
    )
    
    # Format with images
    text = format_digest_with_images(digest)
    
    await update.message.reply_text(text, parse_mode="MarkdownV2")
```

---

## üîß Environment Variables

```bash
# .env

# Vision AI Configuration
VISION_AI_ENABLED=true
VISION_AI_PROVIDER=ollama  # ollama, gemini, openai, gigachat
VISION_MAX_SIZE_MB=5
VISION_TIMEOUT=60

# Caching
VISION_CACHE_TTL=604800  # 7 days (images don't change)

# Subscription limits
VISION_AI_FREE_TIER=false  # Only premium+
VISION_MAX_IMAGES_PER_DIGEST=20
```

---

## üìä Subscription Tiers Update

```python
# subscription_config.py

SUBSCRIPTION_TIERS = {
    "free": {
        # ... existing ...
        "vision_ai_enabled": False,
        "max_images_per_digest": 0
    },
    "trial": {
        # ... existing ...
        "vision_ai_enabled": True,
        "max_images_per_digest": 10
    },
    "basic": {
        # ... existing ...
        "vision_ai_enabled": True,
        "max_images_per_digest": 20
    },
    "premium": {
        # ... existing ...
        "vision_ai_enabled": True,
        "max_images_per_digest": 50
    },
    "enterprise": {
        # ... existing ...
        "vision_ai_enabled": True,
        "max_images_per_digest": 999
    }
}
```

---

## üéØ –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### Phase 1: Backend (Python)

1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `models.py`:
   - –î–æ–±–∞–≤–∏—Ç—å `has_media`, `media_description` –≤ GroupMention
   - –î–æ–±–∞–≤–∏—Ç—å `vision_ai_enabled` –≤ GroupSettings

2. ‚úÖ –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
   ```bash
   telethon/scripts/migrations/add_vision_ai_support.py
   ```

3. ‚úÖ –†–∞—Å—à–∏—Ä–∏—Ç—å `GroupDigestGenerator`:
   - –î–æ–±–∞–≤–∏—Ç—å `_analyze_image()` –º–µ—Ç–æ–¥
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É `MessageMediaPhoto`
   - –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π –≤ Redis

4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å subscription limits:
   - –î–æ–±–∞–≤–∏—Ç—å `vision_ai_enabled` –≤ —Ç–∞—Ä–∏—Ñ—ã
   - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏–º–∏—Ç–æ–≤

### Phase 2: n8n Workflows

1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `group_digest_orchestrator.json`:
   - –ü—Ä–∏–Ω–∏–º–∞—Ç—å `media` –≤ messages
   - –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å descriptions –≤ –∞–≥–µ–Ω—Ç–æ–≤

2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å Agent 1 (Topic Extractor):
   - –£—á–∏—Ç—ã–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–∏ —Ç–µ–º

3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å Agent 4 (Aggregator):
   - –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é `images_summary` –≤ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç

### Phase 3: Bot Commands

1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `/group_digest`:
   - –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `--no-images`
   - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `/group_settings`:
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É `vision_ai_enabled`

3. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –í–∫–ª—é—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö –≤ –¥–∞–π–¥–∂–µ—Å—Ç

### Phase 4: Testing

1. ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Ollama LLaVA:
   ```bash
   docker exec ollama ollama pull llava
   ```

2. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∞–ª–∏–∑:
   ```bash
   curl -X POST http://ollama:11434/api/generate \
     -d '{"model":"llava","prompt":"Describe","images":["base64..."]}'
   ```

3. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ç–µ—Å—Ç–æ–≤—É—é –≥—Ä—É–ø–ø—É
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å `/group_digest`
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ

---

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Ollama LLaVA (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0 (–ª–æ–∫–∞–ª—å–Ω—ã–π)
- **–°–∫–æ—Ä–æ—Å—Ç—å:** 30-60 —Å–µ–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (CPU), 2-5 —Å–µ–∫ (GPU)
- **–ö–∞—á–µ—Å—Ç–≤–æ:** 7/10
- **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å:** ‚úÖ –ü–æ–ª–Ω–∞—è (–¥–∞–Ω–Ω—ã–µ –Ω–µ —É—Ö–æ–¥—è—Ç)

### Google Gemini 2.0 Flash

- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0 (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier: 15 req/min)
- **–°–∫–æ—Ä–æ—Å—Ç—å:** 2-5 —Å–µ–∫
- **–ö–∞—á–µ—Å—Ç–≤–æ:** 9/10
- **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —É—Ö–æ–¥—è—Ç –≤ Google

### GPT-4o Vision

- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** ~$0.01 –∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- **–°–∫–æ—Ä–æ—Å—Ç—å:** 1-3 —Å–µ–∫
- **–ö–∞—á–µ—Å—Ç–≤–æ:** 10/10
- **–ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å:** ‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ —É—Ö–æ–¥—è—Ç –≤ OpenAI

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è

**–î–ª—è –Ω–∞—á–∞–ª–∞:** Ollama LLaVA (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, –ª–æ–∫–∞–ª—å–Ω—ã–π)  
**–î–ª—è production:** Google Gemini (–±—ã—Å—Ç—Ä—ã–π, –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π tier)  
**–î–ª—è –∫–∞—á–µ—Å—Ç–≤–∞:** GPT-4o (–ø–ª–∞—Ç–Ω—ã–π, –Ω–æ –ª—É—á—à–∏–π)

---

## üö® –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** Telegram –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ 20 –ú–ë

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä
max_size = float(os.getenv("VISION_MAX_SIZE_MB", "5"))
if size_mb > max_size:
    return "[–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ]"
```

### 2. –°–∫–æ—Ä–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–Ω–∞–ª–∏–∑ 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π = 30-60 —Å–µ–∫ –∑–∞–¥–µ—Ä–∂–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–µ
background_tasks.add_task(
    analyze_and_cache_images,
    messages
)

# –í –¥–∞–π–¥–∂–µ—Å—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è
```

### 3. Rate Limits (–¥–ª—è Gemini/GPT-4o)

**–ü—Ä–æ–±–ª–µ–º–∞:** Gemini free tier = 15 req/min

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –õ–∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
max_images = tier.get("max_images_per_digest", 10)
images_to_analyze = messages_with_photos[:max_images]
```

### 4. –°—Ç–æ–∏–º–æ—Å—Ç—å (–¥–ª—è GPT-4o)

**–ü—Ä–æ–±–ª–µ–º–∞:** 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π/–¥–µ–Ω—å = $1/–¥–µ–Ω—å = $30/–º–µ—Å—è—Ü

**–†–µ—à–µ–Ω–∏–µ:**
```python
# Vision AI —Ç–æ–ª—å–∫–æ –¥–ª—è premium/enterprise
if user.subscription_type not in ["premium", "enterprise"]:
    analyze_images = False
```

---

## üéì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è MVP (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **Ollama LLaVA** (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
2. ‚úÖ –õ–∏–º–∏—Ç–∏—Ä—É–π—Ç–µ –¥–æ **10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** –Ω–∞ –¥–∞–π–¥–∂–µ—Å—Ç
3. ‚úÖ **–ö–µ—à–∏—Ä—É–π—Ç–µ** –æ–ø–∏—Å–∞–Ω–∏—è –≤ Redis (7 –¥–Ω–µ–π TTL)
4. ‚úÖ –î–µ–ª–∞–π—Ç–µ **background processing** (–Ω–µ –±–ª–æ–∫–∏—Ä—É–π—Ç–µ –±–æ—Ç–∞)
5. ‚úÖ –î–æ–±–∞–≤—å—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `--no-images` –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è

### –î–ª—è Production

1. ‚úÖ **Google Gemini** –∫–∞–∫ primary (–±—ã—Å—Ç—Ä–æ + –±–µ—Å–ø–ª–∞—Ç–Ω–æ)
2. ‚úÖ **Ollama LLaVA** –∫–∞–∫ fallback (–µ—Å–ª–∏ Gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
3. ‚úÖ **GPT-4o** –¥–ª—è enterprise tier (–ª—É—á—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ)
4. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞—Ç—Ä–∞—Ç –∏ rate limits
5. ‚úÖ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

---

## üìö –°—Å—ã–ª–∫–∏

**GigaChat:**
- [–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ GigaChat API](https://developers.sber.ru/docs/ru/gigachat/guides/main)
- [–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤](https://developers.sber.ru/docs/ru/gigachat/guides/main) - —Å–µ–∫—Ü–∏—è "–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤"
- [GigaChat –Ω–∞—É—á–∏–ª—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è](https://consult-cct.ru/gigachat-nauchilsya-raspoznavat-izobrazheniya)

**Vision AI:**
- [Ollama LLaVA](https://ollama.com/library/llava)
- [Google Gemini Vision](https://ai.google.dev/gemini-api/docs/vision)
- [GPT-4 Vision](https://platform.openai.com/docs/guides/vision)
- [OpenRouter Pricing](https://openrouter.ai/models)

**Related:**
- [Telegram Bot API - Photos](https://core.telegram.org/bots/api#photosize)
- [Telethon - MessageMediaPhoto](https://docs.telethon.dev/en/stable/modules/types.html#telethon.tl.types.MessageMediaPhoto)

---

## ‚úÖ –ö–æ–≥–¥–∞ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å

**–¢—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –Ω–∞—á–∞–ª–∞:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –∞–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ì—Ä—É–ø–ø—ã –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (–¥–∏–∑–∞–π–Ω, –º–∞–∫–µ—Ç—ã)
- –ü–æ—è–≤–ª—è–µ—Ç—Å—è budget –¥–ª—è GPT-4o Vision
- Ollama LLaVA –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ö–æ—Ä–æ—à–æ

**–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞—Ç—å:**
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª Groups —Å—Ç–∞–±–∏–ª–µ–Ω
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Ollama LLaVA –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
- –û—Ü–µ–Ω–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ
- –ü–æ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

---

**–°—Ç–∞—Ç—É—Å:** üìã Documented for future implementation  
**Next Step:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Ollama LLaVA –Ω–∞ –æ–¥–Ω–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏  
**Estimated Effort:** 2-3 –¥–Ω—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ + 1 –¥–µ–Ω—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

