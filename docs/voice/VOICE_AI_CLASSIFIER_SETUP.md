# ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ (n8n)

**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–î–∞—Ç–∞:** 13 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

---

## üéØ –ß—Ç–æ —ç—Ç–æ?

**AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É (`/ask` –∏–ª–∏ `/search`) –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üöÄ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –Ω–µ –Ω—É–∂–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –∫–æ–º–∞–Ω–¥—É –≤—Ä—É—á–Ω—É—é
- üß† **AI-–∞–Ω–∞–ª–∏–∑** - GigaChat –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç intent –∑–∞–ø—Ä–æ—Å–∞
- üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
- üí™ **Fallback** - –µ—Å–ª–∏ AI –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏

---

## üìã –®–∞–≥ 1: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å n8n workflow

### 1.1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n

```bash
http://localhost:5678
```

### 1.2. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ workflow

1. –ù–∞–∂–º–∏—Ç–µ **"+"** ‚Üí **"Import from File"**
2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª: `n8n/workflows/voice_command_classifier.json`
3. –ù–∞–∂–º–∏—Ç–µ **"Import"**

### 1.3. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ workflow

1. –û—Ç–∫—Ä–æ–π—Ç–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π workflow **"Voice Command Classifier"**
2. –ù–∞–∂–º–∏—Ç–µ **"Active"** –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–µ–ª–µ–Ω—ã–π ‚úÖ

---

## üîó –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook URL

Workflow –∏—Å–ø–æ–ª—å–∑—É–µ—Ç endpoint:

```
http://n8n:5678/webhook/voice-classify
```

**–í Telegram –±–æ—Ç–µ** —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `.env`:

```bash
N8N_WEBHOOK_URL=http://n8n:5678
VOICE_AI_CLASSIFIER_ENABLED=true
```

---

## üß™ –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 3.1. –ß–µ—Ä–µ–∑ n8n Test Webhook

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow –≤ n8n
2. –ù–∞–∂–º–∏—Ç–µ **"Listen for Test Event"** –Ω–∞ —É–∑–ª–µ Webhook
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:

```bash
curl -X POST http://localhost:5678/webhook/voice-classify \
  -H "Content-Type: application/json" \
  -d '{
    "transcription": "–ß—Ç–æ –ø–∏—Å–∞–ª–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?",
    "user_id": 1
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**

```json
{
  "command": "ask",
  "confidence": 0.95,
  "reasoning": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, —Ç—Ä–µ–±—É—é—â–∏–π –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞",
  "original_transcription": "–ß—Ç–æ –ø–∏—Å–∞–ª–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?",
  "user_id": 1
}
```

### 3.2. –ß–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ **–ë–ï–ó** –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã `/ask` –∏–ª–∏ `/search`
2. –î–æ–∂–¥–∏—Ç–µ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è:

```
‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: "–ß—Ç–æ –ø–∏—Å–∞–ª–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏..."

ü§ñ AI –≤—ã–±—Ä–∞–ª: /ask (95% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏)
üîç –í—ã–ø–æ–ª–Ω—è—é...
```

---

## üéØ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è

### –ü—Ä–∏–º–µ—Ä—ã `/ask` (RAG –ø–æ–∏—Å–∫):

| –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è | –ö–æ–º–∞–Ω–¥–∞ | Reasoning |
|-------------|---------|-----------|
| "–ß—Ç–æ –ø–∏—Å–∞–ª–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏?" | `ask` | –í–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤ |
| "–†–∞—Å—Å–∫–∞–∂–∏ –æ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö" | `ask` | –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–∞ –∏–∑ –ø–æ—Å—Ç–æ–≤ |
| "–ö–∞–∫–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ Tesla?" | `ask` | –í–æ–ø—Ä–æ—Å –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ |

### –ü—Ä–∏–º–µ—Ä—ã `/search` (–≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫):

| –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è | –ö–æ–º–∞–Ω–¥–∞ | Reasoning |
|-------------|---------|-----------|
| "–ù–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫—á–µ–π–Ω–µ" | `search` | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ |
| "–ì–¥–µ –Ω–∞–π—Ç–∏ —Å—Ç–∞—Ç—å–∏ –ø—Ä–æ AI?" | `search` | –ü–æ–∏—Å–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ |
| "–ß—Ç–æ —Ç–∞–∫–æ–µ GPT-4?" | `search` | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–∞ |

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ prompt (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### –ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è prompt?

–£–∑–µ–ª **"Prepare Prompt"** –≤ workflow —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è GigaChat.

### –ö–∞–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å?

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow –≤ n8n
2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —É–∑–µ–ª **"Prepare Prompt"**
3. –ò–∑–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ **"prompt"**
4. –ù–∞–∂–º–∏—Ç–µ **"Save"**

### –ü—Ä–∏–º–µ—Ä –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏:

–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É `/recommend`:

```javascript
**–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
1. `/ask` ‚Äî –ø–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø–æ—Å—Ç–∞—Ö (RAG)
2. `/search` ‚Äî –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ (–ø–æ—Å—Ç—ã + –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)  
3. `/recommend` ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - –ó–∞–ø—Ä–æ—Å—ã: "–ß—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ?", "–ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π", "–ß—Ç–æ –ø–æ—á–∏—Ç–∞—Ç—å?"
```

---

## üêõ Troubleshooting

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: "AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏"

**–ü—Ä–∏—á–∏–Ω—ã:**
1. n8n workflow –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
2. Webhook URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
3. GigaChat proxy –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**

```bash
# 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å workflow
http://localhost:5678 ‚Üí Workflows ‚Üí Voice Command Classifier
# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å ‚úÖ Active

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å webhook
curl http://localhost:5678/webhook/voice-classify \
  -X POST -H "Content-Type: application/json" \
  -d '{"transcription": "test", "user_id": 1}'

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GigaChat proxy
docker logs gpt2giga-proxy --tail 50

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –±–æ—Ç–∞
docker logs telethon 2>&1 | grep "AI –∫–ª–∞—Å—Å–∏—Ñ"
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `/ask`, –¥–∞–∂–µ –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

**–ü—Ä–∏—á–∏–Ω—ã:**
- Prompt –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–Ω—ã–π
- GigaChat –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∑–∞–ø—Ä–æ—Å

**–†–µ—à–µ–Ω–∏–µ:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ workflow ‚Üí —É–∑–µ–ª **"Prepare Prompt"**
2. –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è `/search`:

```
**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã /search:**
- "–ù–∞–π–¥–∏ —Å—Ç–∞—Ç—å–∏ –æ...", "–ü–æ–∫–∞–∂–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–æ..."
- "–ì–¥–µ –Ω–∞–π—Ç–∏...", "–°—Å—ã–ª–∫–∏ –Ω–∞...", "–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ..."
```

3. –£–≤–µ–ª–∏—á—å—Ç–µ `temperature` –≤ —É–∑–ª–µ **"GigaChat Classify"**:

```json
"temperature": 0.2  // –ë—ã–ª–æ 0.1
```

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: Timeout –ø—Ä–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω—ã:**
- GigaChat –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç
- –°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**

–£–≤–µ–ª–∏—á—å—Ç–µ timeout –≤ `bot.py`:

```python
async with httpx.AsyncClient(timeout=15.0) as client:  # –ë—ã–ª–æ 10.0
```

–ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ AI –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä:

```bash
# –í telethon/.env
VOICE_AI_CLASSIFIER_ENABLED=false
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ –±–æ—Ç–∞

```bash
# –°–º–æ—Ç—Ä–∏–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
docker logs telethon 2>&1 | grep "AI classification"

# –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
# INFO: ü§ñ AI classification: ask (confidence: 95%, reason: Question requires RAG search)
```

### n8n Executions

1. –û—Ç–∫—Ä–æ–π—Ç–µ n8n ‚Üí **"Executions"**
2. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø—É—Å–∫–∏ **"Voice Command Classifier"**
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ Success/Error
   - ‚è±Ô∏è Execution time
   - üìã Input/Output data

---

## üöÄ –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥

**–®–∞–≥ 1:** –î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ prompt (—É–∑–µ–ª "Prepare Prompt"):

```
3. `/recommend` ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
   - –ó–∞–ø—Ä–æ—Å—ã: "–ß—Ç–æ –ø–æ—á–∏—Ç–∞—Ç—å?", "–ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π"
```

**–®–∞–≥ 2:** –û–±–Ω–æ–≤–∏—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ —É–∑–ª–µ "Parse & Validate":

```javascript
const validCommands = ['ask', 'search', 'recommend'];  // –î–æ–±–∞–≤–∏–ª–∏ recommend
```

**–®–∞–≥ 3:** –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ `bot.py`:

```python
elif command == 'recommend':
    await self._execute_recommend_with_text(update, context, transcription, db_user)
```

---

## üí° Best Practices

1. **–í—Å–µ–≥–¥–∞ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ** –∏–∑–º–µ–Ω–µ–Ω–∏—è prompt —á–µ—Ä–µ–∑ n8n Test Webhook
2. **–õ–æ–≥–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã** –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ fallback** –Ω–∞ –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
4. **–ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ confidence** - –µ—Å–ª–∏ < 0.5, –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
5. **–°–æ–±–∏—Ä–∞–π—Ç–µ –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å** –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è prompt

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [VOICE_COMMANDS.md](../../telethon/docs/features/voice/VOICE_COMMANDS.md) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –≥–æ–ª–æ—Å–æ–≤—ã–º –∫–æ–º–∞–Ω–¥–∞–º
- [VOICE_QUICK_START.md](../../telethon/docs/features/voice/VOICE_QUICK_START.md) - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- [voice_command_classifier.json](../../n8n/workflows/voice_command_classifier.json) - n8n workflow

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –¢–µ–ø–µ—Ä—å –≥–æ–ª–æ—Å–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ n8n!

