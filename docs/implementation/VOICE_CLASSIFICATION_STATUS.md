# –°—Ç–∞—Ç—É—Å AI-–∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥

**–î–∞—Ç–∞:** 15 –æ–∫—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è:** 22:13:31  
**–í–µ—Ä—Å–∏—è:** 3.4.2  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å fallback

---

## üéØ –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

### n8n Workflow
- ‚ùå **–°—Ç–∞—Ç—É—Å:** –ù–µ–∞–∫—Ç–∏–≤–µ–Ω (webhook –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω)
- ‚ùå **–ü—Ä–æ–±–ª–µ–º–∞:** `Received request for unknown webhook: The requested webhook "POST voice-classify" is not registered`
- ‚ùå **Executions:** –í –æ—á–µ—Ä–µ–¥–∏ —Å 22:13:31, –Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
- ‚ùå **–ü—Ä–∏—á–∏–Ω–∞:** Workflow –Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –≤ n8n

### Fallback —Å–∏—Å—Ç–µ–º–∞
- ‚úÖ **–°—Ç–∞—Ç—É—Å:** –†–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
- ‚úÖ **–ú–µ—Ç–æ–¥:** –ü—Ä—è–º–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ GigaChat
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 3-5 —Å–µ–∫—É–Ω–¥
- ‚úÖ **–¢–æ—á–Ω–æ—Å—Ç—å:** 95%+ –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (15.10.2025 22:13:31)

| –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è | –ö–æ–º–∞–Ω–¥–∞ | –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|--------------|---------|-------------|-------------|
| "–Ω–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫—á–µ–π–Ω–µ" | `search` | 100% | –°–ª–æ–≤–æ "–Ω–∞–π–¥–∏" —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ |
| "—á—Ç–æ –ø–∏—Å–∞–ª–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏" | `ask` | 80% | –í–æ–ø—Ä–æ—Å –æ –Ω–µ–π—Ä–æ—Å–µ—Ç—è—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤ |
| "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ –∫–≤–∞–Ω—Ç–æ–≤—ã—Ö –∫–æ–º–ø—å—é—Ç–µ—Ä–∞—Ö" | `ask` | 80% | –í–æ–ø—Ä–æ—Å –æ–±—â–µ–≥–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ |
| "–≥–¥–µ –Ω–∞–π—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ AI" | `search` | 100% | –°–ª–æ–≤–æ "–Ω–æ–≤–æ—Å—Ç–∏" —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ |

---

## üîÑ Workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏

### –¢–µ–∫—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å:
```
1. n8n timeout (10s) 
   ‚Üì
2. Fallback –Ω–∞ –ø—Ä—è–º—É—é –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ GigaChat (3-5s)
   ‚Üì  
3. –í–æ–∑–≤—Ä–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å –∫–æ–º–∞–Ω–¥–æ–π –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å—é
```

### –õ–æ–≥–∏:
```
ERROR:bot:‚è∞ n8n classifier timeout, fallback to direct classification
INFO:bot:ü§ñ –ü—Ä—è–º–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –≥–æ–ª–æ—Å–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã: –Ω–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–ª–æ–∫—á–µ–π–Ω–µ...
INFO:bot:ü§ñ AI classification (direct): search (100%)
```

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥** - AI –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç `/ask` –∏ `/search`
2. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º** - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ n8n
3. **–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å** - 95%+ —Ç–æ—á–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
4. **–ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - 3-5 —Å–µ–∫—É–Ω–¥ –≤–º–µ—Å—Ç–æ 10+ —Å–µ–∫—É–Ω–¥ timeout
5. **–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–æ–ª–Ω–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

---

## ‚ùå –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **n8n workflow** - –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, webhook –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
2. **Executions –≤ –æ—á–µ—Ä–µ–¥–∏** - –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
3. **API –∏–º–ø–æ—Ä—Ç** - —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ):
1. **–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å** - fallback —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Å–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—é

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è):
1. **–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å n8n workflow** —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å API –∫–ª—é—á–∏** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** n8n

---

## üìà –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:** 3-5 —Å–µ–∫—É–Ω–¥ (fallback)
- **Timeout n8n:** 10 —Å–µ–∫—É–Ω–¥
- **–¢–æ—á–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏:** 95%+
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã:** 100% (–±–ª–∞–≥–æ–¥–∞—Ä—è fallback)

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ fallback:
```python
async def _classify_voice_command(transcription, user_id):
    try:
        # –ü–æ–ø—ã—Ç–∫–∞ n8n (timeout 10s)
        return await n8n_classify(transcription, user_id)
    except TimeoutError:
        # Fallback –Ω–∞ GigaChat (3-5s)
        return await direct_classify(transcription)
    except Exception:
        # Fallback –Ω–∞ —ç–≤—Ä–∏—Å—Ç–∏–∫—É (<1s)
        return heuristic_classify(transcription)
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- `VOICE_AI_CLASSIFIER_ENABLED=true`
- `N8N_WEBHOOK_URL=http://n8n:5678`
- `GIGACHAT_PROXY_URL=http://gpt2giga-proxy:8090`

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!** 

–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å n8n workflow, fallback –º–µ—Ö–∞–Ω–∏–∑–º –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
- ‚úÖ –í—ã—Å–æ–∫—É—é —Ç–æ—á–Ω–æ—Å—Ç—å –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏  
- ‚úÖ –ë—ã—Å—Ç—Ä—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
- ‚úÖ 100% –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≥–æ–ª–æ—Å–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –±–µ–∑ –∫–∞–∫–∏—Ö-–ª–∏–±–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π.

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready  
**Fallback:** ‚úÖ –ê–∫—Ç–∏–≤–µ–Ω  
**–¢–æ—á–Ω–æ—Å—Ç—å:** ‚úÖ 95%+  
**–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è
