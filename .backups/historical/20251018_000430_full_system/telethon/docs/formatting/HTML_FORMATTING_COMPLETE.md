# HTML –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è Telegram - –ü–æ–ª–Ω–∞—è –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚úÖ

**–î–∞—Ç–∞:** 14 –æ–∫—Ç—è–±—Ä—è 2025  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

## üìã –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `markdown_to_html()`

**–§–∞–π–ª:** `telegram_formatter.py`

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- `<blockquote>` –¥–ª—è —Ü–∏—Ç–∞—Ç (> text)
- `<blockquote expandable>` –¥–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –±–ª–æ–∫–æ–≤
- `<tg-spoiler>` –¥–ª—è —Å–ø–æ–π–ª–µ—Ä–æ–≤ (||text||)
- `<pre><code class="language-X">` –¥–ª—è code blocks —Å —è–∑—ã–∫–æ–º
- `<u>` –¥–ª—è –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è (__text__)
- `<s>` –¥–ª—è –∑–∞—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è (~~text~~)

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `\x00` (null byte) –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ (–Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å Markdown)
- –†–µ–∫—É—Ä—Å–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ blockquote –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `html.escape()`

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**`format_rag_answer(answer, sources)`**
- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç RAG –æ—Ç–≤–µ—Ç—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ `<blockquote expandable>` (–º–∞–∫—Å 5)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ excerpt, –¥–∞—Ç, —Å—Å—ã–ª–æ–∫
- –ü—Ä–∏–º–µ—Ä:
  ```
  –û—Ç–≤–µ—Ç –æ—Ç AI...
  
  <blockquote expandable>
  üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
  1. @channel (15.01.2024)
  2. @another (10.01.2024)
  </blockquote>
  ```

**`format_long_digest(text, max_visible=500)`**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ expandable –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
- –£–º–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ –ø–æ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫ –∏–ª–∏ –ø—Ä–æ–±–µ–ª–∞–º
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏

### 3. ‚úÖ –û–±–Ω–æ–≤–ª—ë–Ω `bot.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò–º–ø–æ—Ä—Ç `format_rag_answer`
- RAG –æ—Ç–≤–µ—Ç—ã —Ç–µ–ø–µ—Ä—å —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –≤ expandable blockquote
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–°—Ç—Ä–æ–∫–∏:** 2437-2447

### 4. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `scheduler.py`

**–ë—ã–ª–æ:** `"parse_mode": "MarkdownV2" if settings.format == "markdown" else None`  
**–°—Ç–∞–ª–æ:** `"parse_mode": "HTML"`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ï–¥–∏–Ω—ã–π HTML —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤—Å–µ—Ö –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤

**–°—Ç—Ä–æ–∫–∞:** 225

### 5. ‚úÖ –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω `digest_generator.py`

**–§—É–Ω–∫—Ü–∏—è:** `_generate_markdown_digest()` (–Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–µ–Ω—è–ª–æ—Å—å –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

**–ù–æ–≤–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- HTML —Ç–µ–≥–∏ –≤–º–µ—Å—Ç–æ Markdown
- `<code>` –¥–ª—è —Ç–µ–≥–æ–≤ –ø–æ—Å—Ç–æ–≤
- `<blockquote expandable>` –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ (>300 —Å–∏–º–≤–æ–ª–æ–≤)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ usernames, —Ç–µ–∫—Å—Ç–∞

**–°—Ç—Ä–æ–∫–∏:** 168-214

### 6. ‚úÖ –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω `ai_digest_generator.py`

**–§—É–Ω–∫—Ü–∏—è:** `_format_ai_digest()`

**–£–ª—É—á—à–µ–Ω–∏—è:**
- HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ `<blockquote expandable>`
- –≠–º–æ–¥–∑–∏ –¥–ª—è —Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- –ü—É—Å—Ç–æ–π –¥–∞–π–¥–∂–µ—Å—Ç —Ç–æ–∂–µ –≤ HTML

**–°—Ç—Ä–æ–∫–∏:** 416-494

### 7. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã Group —Ñ—É–Ω–∫—Ü–∏–∏

**`format_digest_for_telegram()`**
- –†–µ–∑—é–º–µ –≤ `<blockquote>` –∏–ª–∏ `<blockquote expandable>` (>300 chars)
- –°–ø–∏–∫–µ—Ä—ã —Å `<code>@username</code>`
- –¢–µ–º—ã —Å `<b>–Ω–æ–º–µ—Ä.</b> –¢–µ–º–∞`

**`format_mention_for_telegram()`**
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ `<blockquote>`
- Key points —Å `<i>` –¥–ª—è –≤–∞–∂–Ω–æ—Å—Ç–∏
- Urgency emoji + HTML —Ç–µ–≥–∏

**–°—Ç—Ä–æ–∫–∏:** 25-148

### 8. ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω—ã —Ç–µ—Å—Ç—ã

**–§–∞–π–ª:** `tests/test_telegram_formatter.py`

**–ù–æ–≤—ã–µ —Ç–µ—Å—Ç-–∫–ª–∞—Å—Å—ã:**
- `TestAdvancedHTML` (7 —Ç–µ—Å—Ç–æ–≤)
  - blockquote, spoiler, code blocks —Å —è–∑—ã–∫–æ–º
  - underline, strikethrough, nested formatting
  
- `TestFormatRAGAnswer` (4 —Ç–µ—Å—Ç–∞)
  - –° –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –∏ –±–µ–∑
  - –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏
  - Excerpt –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–∞—Ö
  
- `TestFormatLongDigest` (4 —Ç–µ—Å—Ç–∞)
  - –ö–æ—Ä–æ—Ç–∫–∏–µ/–¥–ª–∏–Ω–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã
  - –£–º–Ω—ã–π —Ä–∞–∑—Ä—ã–≤ –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞—Ö
  
- `TestIntegration` (–æ–±–Ω–æ–≤–ª–µ–Ω—ã)
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ HTML –≤–º–µ—Å—Ç–æ Markdown
  - Blockquote –≤ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è—Ö

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 42/42 —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Ö–æ–¥—è—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

```bash
cd /home/ilyasni/n8n-server/n8n-installer/telethon
python3 -m pytest tests/test_telegram_formatter.py --no-cov -v
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ 42 passed, 1 warning (SQLAlchemy deprecation - –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)

### Linter –ø—Ä–æ–≤–µ—Ä–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ 5 –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
- telegram_formatter.py
- bot.py  
- rag_service/scheduler.py
- rag_service/digest_generator.py
- rag_service/ai_digest_generator.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ No linter errors found

## üìù –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. RAG –æ—Ç–≤–µ—Ç—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏

```bash
# –í Telegram –±–æ—Ç–µ
/ask –ß—Ç–æ —Ç–∞–∫–æ–µ Python?
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –û—Ç–≤–µ—Ç –æ—Ç AI
- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è –±–ª–æ–∫ "üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:" –≤–Ω–∏–∑—É
- –ö–ª–∏–∫ –Ω–∞ –±–ª–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –¥–∞—Ç–∞–º–∏ –∏ —Å—Å—ã–ª–∫–∞–º–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞ HTML —Ç–µ–≥–æ–≤:**
- –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ö—É—Ä—Å–∏–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –°—Å—ã–ª–∫–∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã

### 2. –î–ª–∏–Ω–Ω—ã–π –¥–∞–π–¥–∂–µ—Å—Ç

```bash
# –°–æ–∑–¥–∞—Ç—å –¥–∞–π–¥–∂–µ—Å—Ç —Å –¥–ª–∏–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞–º–∏
# –ß–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞ –∏–ª–∏ API
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –í–∏–¥–∏–º–∞—è —á–∞—Å—Ç—å –ø–æ—Å—Ç–∞ (~300 —Å–∏–º–≤–æ–ª–æ–≤)
- –¢–æ—á–∫–∏ "..."
- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è –±–ª–æ–∫ —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
- –¢–µ–≥–∏ –≤ `<code>` –≤–∏–¥–µ (—Å–µ—Ä—ã–π —Ñ–æ–Ω)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- Expandable –±–ª–æ–∫ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
- –†–∞–∑—Ä—ã–≤ –Ω–∞ —É–¥–∞—á–Ω–æ–º –º–µ—Å—Ç–µ (–ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –ø—Ä–æ–±–µ–ª)

### 3. Groups —É–ø–æ–º–∏–Ω–∞–Ω–∏—è

```bash
# –í –≥—Ä—É–ø–ø–µ –≥–¥–µ –±–æ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç
@–≤–∞—à_username –ø—Ä–∏–≤–µ—Ç, –Ω—É–∂–Ω–∞ –ø–æ–º–æ—â—å
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å urgency emoji (üü¢/üü°/üî¥)
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ blockquote (—Å–µ—Ä—ã–π —Ñ–æ–Ω —Å–ª–µ–≤–∞)
- –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –≤—ã–¥–µ–ª–µ–Ω—ã –∫—É—Ä—Å–∏–≤–æ–º
- –°—Å—ã–ª–∫–∞ "üì¨ –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é"

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- Blockquote –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ —Ü–∏—Ç–∞—Ç–∞
- Key points —á–∏—Ç–∞—é—Ç—Å—è —Å –∞–∫—Ü–µ–Ω—Ç–æ–º
- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 4. AI –¥–∞–π–¥–∂–µ—Å—Ç

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é AI –¥–∞–π–¥–∂–µ—Å—Ç–∞
# –ß–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —ç–º–æ–¥–∑–∏ ü§ñ
- –¢–µ–º—ã —Å —ç–º–æ–¥–∑–∏ (üí∞, üöó, üíµ –∏ —Ç.–¥.)
- –°–∞–º–º–∞—Ä–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã
- –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ expandable blockquote
- –§—É—Ç–µ—Ä —Å –≤—Ä–µ–º–µ–Ω–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- Expandable –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- –°—Å—ã–ª–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã
- –î–∞—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" –∫—Ä–∞—Å–∏–≤—ã–π

### 5. –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ Markdown —ç–ª–µ–º–µ–Ω—Ç—ã

–û—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É —á–µ—Ä–µ–∑ /ask –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç:

```markdown
## –ó–∞–≥–æ–ª–æ–≤–æ–∫
**–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç**
*–ö—É—Ä—Å–∏–≤*
__–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π__
~~–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π~~
||–°–ø–æ–π–ª–µ—Ä||

> –≠—Ç–æ —Ü–∏—Ç–∞—Ç–∞
> –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–∞—è

`–∫–æ–¥ –∏–Ω–ª–∞–π–Ω`

```python
def hello():
    print("world")
```
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∂–∏—Ä–Ω—ã–π (–±–µ–∑ ##)
- –í—Å–µ —Å—Ç–∏–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- –¶–∏—Ç–∞—Ç–∞ –≤ —Å–µ—Ä–æ–º –±–ª–æ–∫–µ
- –°–ø–æ–π–ª–µ—Ä —Å–∫—Ä—ã—Ç (–∫–ª–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç)
- Code block —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π Python

## üîç –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∏ —Å underline

**–ë—ã–ª–æ:** `__BLOCKQUOTE_0__` ‚Üí –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å `__—Ç–µ–∫—Å—Ç__`  
**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `\x00BLOCKQUOTE_0\x00` (null byte)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –†–µ–∫—É—Ä—Å–∏—è –≤ blockquote

**–ë—ã–ª–æ:** Blockquote –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª –≤–ª–æ–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ  
**–†–µ—à–µ–Ω–∏–µ:** –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ `markdown_to_html()` –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –í–ª–æ–∂–µ–Ω–Ω—ã–π **–∂–∏—Ä–Ω—ã–π** –∏ *–∫—É—Ä—Å–∏–≤* —Ä–∞–±–æ—Ç–∞—é—Ç –≤–Ω—É—Ç—Ä–∏ —Ü–∏—Ç–∞—Ç

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Code blocks –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

**–ë—ã–ª–æ:** HTML —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –ª–æ–º–∞–ª–∏ code blocks  
**–†–µ—à–µ–Ω–∏–µ:** `escape(code)` –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –≤ `<pre><code>`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ `<`, `>`, `&` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –∫–æ–¥–µ

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –§–∞–π–ª | –°—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ | –§—É–Ω–∫—Ü–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–æ |
|------|----------------|-------------------|
| telegram_formatter.py | ~150 | 2 (format_rag_answer, format_long_digest) |
| bot.py | ~5 | 0 |
| scheduler.py | 1 | 0 |
| digest_generator.py | ~45 | 0 |
| ai_digest_generator.py | ~55 | 0 |
| test_telegram_formatter.py | ~100 | 15 —Ç–µ—Å—Ç–æ–≤ |

**–í—Å–µ–≥–æ:** ~356 —Å—Ç—Ä–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–æ/–¥–æ–±–∞–≤–ª–µ–Ω–æ

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç (42/42)
- [x] –ù–µ—Ç linter –æ—à–∏–±–æ–∫
- [x] Blockquote —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Expandable blockquote —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Spoilers —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] Code blocks —Å —è–∑—ã–∫–æ–º —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] Underline —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] Strikethrough —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] RAG –æ—Ç–≤–µ—Ç—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- [x] –î–ª–∏–Ω–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã —Å expandable
- [x] Groups —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å blockquote
- [x] AI –¥–∞–π–¥–∂–µ—Å—Ç—ã —Å HTML
- [x] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (markdownify)

## üîÑ Rollback –ø–ª–∞–Ω

–ï—Å–ª–∏ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã:

```bash
# 1. –û—Ç–∫–∞—Ç telegram_formatter.py
git checkout HEAD~1 -- telethon/telegram_formatter.py

# 2. –û—Ç–∫–∞—Ç scheduler.py
git checkout HEAD~1 -- telethon/rag_service/scheduler.py

# 3. –û—Ç–∫–∞—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
git checkout HEAD~1 -- telethon/rag_service/digest_generator.py
git checkout HEAD~1 -- telethon/rag_service/ai_digest_generator.py
git checkout HEAD~1 -- telethon/bot.py

# 4. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose restart telethon
```

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ**
   - –õ–æ–≥–∏ Telegram API –æ—à–∏–±–æ–∫
   - Feedback –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

2. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**
   - Emoji —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ expandable –±–ª–æ–∫–∏
   - –ê–Ω–∏–º–∞—Ü–∏—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è (–Ω–µ—Ç API –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ Telegram)
   - –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ç–µ–º—ã –¥–ª—è blockquote (–Ω–µ—Ç API –ø–æ–¥–¥–µ—Ä–∂–∫–∏)

3. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é expandable
   - –ü—Ä–∏–º–µ—Ä—ã —Å–ø–æ–π–ª–µ—Ä–æ–≤
   - FAQ

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Telegram Bot API - HTML Formatting](https://core.telegram.org/bots/api#html-style)
- [Telegram Bot API - MarkdownV2](https://core.telegram.org/bots/api#markdownv2-style)
- [Context7 - Best Practices](https://developers.sber.ru/docs/)

---

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:** 14.10.2025  
**–¢–µ—Å—Ç—ã:** ‚úÖ 42/42 passed  
**Linter:** ‚úÖ No errors  
**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** ‚úÖ –î–∞

