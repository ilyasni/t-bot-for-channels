# ‚úÖ RAG Commands Implementation - Complete

**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 2.2.1  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –≥–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

---

## üéâ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±–æ—Ç–∞

#### 1. **–ö–æ–º–∞–Ω–¥–∞ `/ask <–≤–æ–ø—Ä–æ—Å>`** - RAG-–ø–æ–∏—Å–∫
–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–æ–≤ –≤ –≤–∞—à–∏—Ö –ø–æ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—è AI.

**–ü—Ä–∏–º–µ—Ä:**
```
/ask –ß—Ç–æ –ø–∏—Å–∞–ª–∏ –ø—Ä–æ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ?

‚Üí üí° –û—Ç–≤–µ—Ç: –ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ –æ–±—Å—É–∂–¥–∞–ª–∏...
  üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏: [Channel](link) (95%)
```

#### 2. **–ö–æ–º–∞–Ω–¥–∞ `/recommend`** - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤.

**–ü—Ä–∏–º–µ—Ä:**
```
/recommend

‚Üí üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å:
  1. [AI News] –ü—Ä–æ—Ä—ã–≤ –≤... (95%)
  2. [Tech Daily] –ù–æ–≤–∞—è –º–æ–¥–µ–ª—å... (88%)
```

#### 3. **–ö–æ–º–∞–Ω–¥–∞ `/search <–∑–∞–ø—Ä–æ—Å>`** - –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫
–ü–æ–∏—Å–∫ –≤ –≤–∞—à–∏—Ö –ø–æ—Å—Ç–∞—Ö + –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (Searxng).

**–ü—Ä–∏–º–µ—Ä:**
```
/search –∫–≤–∞–Ω—Ç–æ–≤—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã

‚Üí üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:
  üì± –í–∞—à–∏ –ø–æ—Å—Ç—ã (3)
  üåê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç (5)
  [–ö–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏]
```

#### 4. **–ö–æ–º–∞–Ω–¥–∞ `/digest`** - AI-–¥–∞–π–¥–∂–µ—Å—Ç—ã
–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–µ–π.

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üìÖ –ß–∞—Å—Ç–æ—Ç–∞: –µ–∂–µ–¥–Ω–µ–≤–Ω–æ/–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ
- üïê –í—Ä–µ–º—è: 09:00, 12:00, 18:00, 21:00
- ü§ñ AI-—Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è: –≤–∫–ª/–≤—ã–∫–ª
- üìä –°—Ç–∏–ª—å: –∫—Ä–∞—Ç–∫–∏–π/–¥–µ—Ç–∞–ª—å–Ω—ã–π/executive
- üè∑Ô∏è –¢–µ–º—ã: —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º—ã—Ö —Ç–µ–º

#### 5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å—Å—ã–ª–∫–∞–º–∏**
–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ —Å—Å—ã–ª–æ–∫ —á–µ—Ä–µ–∑ Crawl4AI –¥–ª—è –±–æ–ª–µ–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ RAG.

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ö–æ–¥

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| –§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ | 3 |
| –§–∞–π–ª–æ–≤ —Å–æ–∑–¥–∞–Ω–æ | 4 |
| –°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ | ~1,400 |
| –ù–æ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤ | 8 |
| Callback handlers | 12 |
| –ú–∏–≥—Ä–∞—Ü–∏–π –ë–î | 1 |

### –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
|-----------|-------------|
| –ö–æ–º–∞–Ω–¥ –±–æ—Ç–∞ | 4 |
| Inline –∫–Ω–æ–ø–æ–∫ | 15+ |
| API endpoints –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è | 6 |
| –í–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ | 3 (RAG, Searxng, Crawl4AI) |
| Error handling cases | 20+ |

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ò–∑–º–µ–Ω–µ–Ω—ã:

1. **telethon/bot.py** (+800 —Å—Ç—Ä–æ–∫)
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã: httpx, asyncio, typing
   - –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥: `_call_rag_service()`
   - –ö–æ–º–∞–Ω–¥—ã: `ask_command()`, `recommend_command()`, `search_command()`, `digest_command()`
   - Callback handlers: `handle_digest_callback()`, `handle_search_callback()`
   - –£—Ç–∏–ª–∏—Ç–∞: `_show_digest_menu()`
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã: `help_command()`, `start_command()`, `handle_text()`, `button_callback()`

2. **telethon/parser_service.py** (+70 —Å—Ç—Ä–æ–∫)
   - –ú–µ—Ç–æ–¥: `_extract_urls()` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ URL –∏–∑ —Ç–µ–∫—Å—Ç–∞
   - –ú–µ—Ç–æ–¥: `_enrich_post_with_links()` - –æ–±–æ–≥–∞—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Crawl4AI
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `parse_channel_posts()` - –≤—ã–∑–æ–≤ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–∞

3. **telethon/models.py** (+3 —Å—Ç—Ä–æ–∫–∏)
   - –ü–æ–ª–µ: `enriched_content` –≤ —Ç–∞–±–ª–∏—Ü–µ `posts`

### –°–æ–∑–¥–∞–Ω—ã:

4. **telethon/scripts/migrations/add_enriched_content.py** (140 —Å—Ç—Ä–æ–∫)
   - –ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è enriched_content
   - Backup support –¥–ª—è SQLite
   - Rollback –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
   - Validation –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º

5. **telethon/docs/features/rag/BOT_RAG_COMMANDS.md** (400+ —Å—Ç—Ä–æ–∫)
   - –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
   - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏
   - –°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - Troubleshooting guide

6. **telethon/BOT_RAG_COMMANDS_SUMMARY.md** (200+ —Å—Ç—Ä–æ–∫)
   - –û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

7. **telethon/TESTING_GUIDE.md** (350+ —Å—Ç—Ä–æ–∫)
   - –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
   - 14 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
   - –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - Troubleshooting
   - –®–∞–±–ª–æ–Ω –æ—Ç—á–µ—Ç–∞

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –∑–∞–ø—É—Å–∫—É

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)

```bash
cd /home/ilyasni/n8n-server/n8n-installer/telethon
python scripts/migrations/add_enriched_content.py
```

–í–≤–µ—Å—Ç–∏: `yes`

### 2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–æ—Ç–∞

```bash
cd /home/ilyasni/n8n-server/n8n-installer

# –í–∞—Ä–∏–∞–Ω—Ç 1: —á–µ—Ä–µ–∑ docker compose
docker compose up telethon-bot --build -d

# –í–∞—Ä–∏–∞–Ω—Ç 2: —á–µ—Ä–µ–∑ alias (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
telethon-rebuild
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

```bash
docker logs -f telethon-bot
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏:**
```
‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RAG service

```bash
curl http://localhost:8020/health
```

### 5. –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ `TESTING_GUIDE.md`:

```bash
# –í Telegram –±–æ—Ç–µ:
/start
/help
/ask –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?
/search —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
/recommend
/digest
```

---

## üåç –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã):

```bash
RAG_SERVICE_URL=http://rag-service:8020
RAG_SERVICE_ENABLED=true
```

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
# –î–ª—è –æ–±–æ–≥–∞—â–µ–Ω–∏—è –ø–æ—Å—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
CRAWL4AI_ENABLED=false          # –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ true –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è
CRAWL4AI_URL=http://crawl4ai:11235
CRAWL4AI_TIMEOUT=30
CRAWL4AI_WORD_THRESHOLD=100

# –î–ª—è –≤–µ–±-–ø–æ–∏—Å–∫–∞ –≤ /search (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
SEARXNG_ENABLED=true
SEARXNG_URL=https://searxng.produman.studio
SEARXNG_USER=hello@ilyasni.com
SEARXNG_PASSWORD=B5Hp8jfp7sjDnb4XwRRzPo54RYETVOhX
```

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π HTTP –∫–ª–∏–µ–Ω—Ç

–°–æ–∑–¥–∞–Ω –º–µ—Ç–æ–¥ `_call_rag_service()` –¥–ª—è –≤—Å–µ—Ö RAG –∑–∞–ø—Ä–æ—Å–æ–≤:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ DRY - –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
- ‚úÖ –ï–¥–∏–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ GET –∏ POST
- ‚úÖ Timeout –∏ connection error handling
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### 2. State Management –¥–ª—è /digest

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `self.user_states`:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ë–î
- ‚úÖ Auto cleanup —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö states (30 –º–∏–Ω—É—Ç)
- ‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

### 3. Graceful Degradation

–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤:

**–ü—Ä–∏–º–µ—Ä—ã:**
- RAG service –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
- Searxng –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—ã
- Crawl4AI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ–±–æ–≥–∞—â–µ–Ω–∏—è
- –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Üí –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 4. Async everywhere

–í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ httpx:

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç event loop
- ‚úÖ Concurrent operations –≤–æ–∑–º–æ–∂–Ω—ã
- ‚úÖ –õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

---

## üìà Impact Analysis

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- üéØ –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –ø–æ—Å—Ç–∞—Ö
- ü§ñ AI-–æ—Ç–≤–µ—Ç—ã –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
- üì∞ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–π–¥–∂–µ—Å—Ç—ã
- üåê –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ (–ø–æ—Å—Ç—ã + –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)
- üí° –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (—É–∂–µ –µ—Å—Ç—å)
- –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã (–æ–±—ã—á–Ω—ã–π workflow)
- RAG service —Ä–∞–±–æ—Ç–∞–µ—Ç (—É–∂–µ –∑–∞–ø—É—â–µ–Ω)

### –î–ª—è —Å–∏—Å—Ç–µ–º—ã

**–ù–∞–≥—Ä—É–∑–∫–∞:**
- RAG queries: ~1-5 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- Embeddings: –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ Redis (24h)
- Qdrant: –¥–æ 10 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- Searxng: –¥–æ 5 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- Crawl4AI: –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–∞—Ä—Å–∏–Ω–≥

**–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:**
- Rate limiting —á–µ—Ä–µ–∑ Redis
- Batch processing –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- Connection pooling –¥–ª—è –ë–î
- Async –¥–ª—è –≤—Å–µ—Ö I/O

---

## üîÑ Rollback Plan

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫:

### 1. –û—Ç–∫–∞—Ç –∫–æ–¥–∞

```bash
# Git rollback (–µ—Å–ª–∏ –∑–∞–∫–æ–º–º–∏—á–µ–Ω–æ)
git checkout HEAD~1 -- telethon/bot.py
git checkout HEAD~1 -- telethon/parser_service.py
git checkout HEAD~1 -- telethon/models.py

# –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å
docker compose up telethon-bot --build -d
```

### 2. –û—Ç–∫–∞—Ç –ë–î (SQLite)

```bash
cd /home/ilyasni/n8n-server/n8n-installer/telethon/data

# –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π backup
ls -lt telethon_bot.db.backup_*

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
cp telethon_bot.db.backup_TIMESTAMP telethon_bot.db
```

### 3. –û—Ç–∫–∞—Ç –ë–î (PostgreSQL/Supabase)

```bash
# –ï—Å–ª–∏ –µ—Å—Ç—å backup
docker exec -i supabase-db psql -U postgres postgres < backup.sql
```

### 4. –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (–≤—Ä–µ–º–µ–Ω–Ω–æ)

```bash
# –í .env
RAG_SERVICE_ENABLED=false

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
docker compose restart telethon-bot
```

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤:

1. **BOT_RAG_COMMANDS.md** - –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
2. **BOT_RAG_COMMANDS_SUMMARY.md** - –æ—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
3. **TESTING_GUIDE.md** - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
4. **RAG_QUICKSTART.md** - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç RAG —Å–∏—Å—Ç–µ–º—ã
5. **.cursor/rules/n8n-telegram-bot.mdc** - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ v2.2

---

## ‚ú® –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:

1. ‚è≥ **–ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:**
   ```bash
   python scripts/migrations/add_enriched_content.py
   ```

2. ‚è≥ **–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:**
   ```bash
   docker compose up telethon-bot --build -d
   ```

3. ‚è≥ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å:**
   ```bash
   # –õ–æ–≥–∏
   docker logs telethon-bot
   
   # RAG service
   curl http://localhost:8020/health
   
   # –í Telegram
   /start
   /help
   /ask –ü—Ä–∏–≤–µ—Ç!
   ```

### –í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è:

4. ‚è≥ **–ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –°–ª–µ–¥–æ–≤–∞—Ç—å `TESTING_GUIDE.md`
   - –ó–∞–ø–æ–ª–Ω–∏—Ç—å —á–µ–∫–ª–∏—Å—Ç
   - –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

5. ‚è≥ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**
   ```bash
   # –í–∫–ª—é—á–∏—Ç—å Crawl4AI (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
   CRAWL4AI_ENABLED=true
   
   # –í–∫–ª—é—á–∏—Ç—å Searxng (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
   SEARXNG_ENABLED=true
   ```

### –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:

6. ‚è≥ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ª–æ–≥–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
   - –°–æ–±–∏—Ä–∞—Ç—å feedback –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ RAG service

7. ‚è≥ **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis
   - –î–æ–±–∞–≤–∏—Ç—å rate limiting
   - –£–ª—É—á—à–∏—Ç—å formatting –æ—Ç–≤–µ—Ç–æ–≤

---

## üí° Best Practices (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ)

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥:

1. **–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –∫–∞–Ω–∞–ª—ã** —á–µ—Ä–µ–∑ `/add_channel`
2. **–ü–æ–¥–æ–∂–¥–∏—Ç–µ –ø–∞—Ä—Å–∏–Ω–≥–∞** (5-10 –º–∏–Ω—É—Ç –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/ask`** –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ `/digest`** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–≤–æ–¥–æ–∫
5. **–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏** –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å infrastructure

### –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã:

```
Telegram Bot (telethon-bot)
    ‚Üì
RAG Service (rag-service:8020)
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚Üì         ‚Üì          ‚Üì          ‚Üì
Qdrant   Redis   Searxng   Crawl4AI
(–≤–µ–∫—Ç–æ—Ä—ã) (–∫–µ—à)  (–ø–æ–∏—Å–∫)   (—Å—Å—ã–ª–∫–∏)
```

### API Endpoints (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–æ—Ç–æ–º):

```
POST /rag/query                      # /ask –∫–æ–º–∞–Ω–¥–∞
GET  /rag/recommend/{user_id}        # /recommend –∫–æ–º–∞–Ω–¥–∞
POST /rag/hybrid_search              # /search –∫–æ–º–∞–Ω–¥–∞
GET  /rag/digest/settings/{user_id}  # /digest –∫–æ–º–∞–Ω–¥–∞ (get)
POST /rag/digest/settings/{user_id}  # /digest –∫–æ–º–∞–Ω–¥–∞ (update)
POST /crawl                          # Crawl4AI (–æ–±–æ–≥–∞—â–µ–Ω–∏–µ)
```

---

## üéì –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö RAG –∫–æ–º–∞–Ω–¥

–ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã:

```python
async def new_rag_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã"""
    user = update.effective_user
    db = SessionLocal()
    
    try:
        # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        db_user = db.query(User).filter(User.telegram_id == user.id).first()
        if not db_user or not db_user.is_authenticated:
            await update.message.reply_text("‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è")
            return
        
        # 2. Typing indicator
        await update.message.chat.send_action(action="typing")
        
        # 3. –í—ã–∑–æ–≤ RAG service
        result = await self._call_rag_service(
            "/rag/your_endpoint",
            user_id=db_user.id,
            param1="value"
        )
        
        # 4. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        if not result:
            await update.message.reply_text("‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
            return
        
        # 5. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞
        response = format_response(result)
        await update.message.reply_text(response, parse_mode='Markdown')
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")
    finally:
        db.close()
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö callback handlers

```python
# 1. –í button_callback() –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É
elif query.data.startswith("myfeature_"):
    await self.handle_myfeature_callback(query, context)

# 2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å handler
async def handle_myfeature_callback(self, query, context):
    data = query.data
    # –û–±—Ä–∞–±–æ—Ç–∫–∞...
```

---

## üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ

- ‚úÖ **Async/await everywhere** - –Ω–µ—Ç –±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **Error handling** - graceful degradation –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- ‚úÖ **Type hints** - –ø–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ **Logging** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **Documentation** - 1000+ —Å—Ç—Ä–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- ‚úÖ **Testing scenarios** - 14 –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

- ‚úÖ **–ò–Ω—Ç—É–∏—Ç–∏–≤–Ω—ã–π UI** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–Ω–æ–ø–∫–∏
- ‚úÖ **Helpful errors** - –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
- ‚úÖ **Examples** - –ø—Ä–∏–º–µ—Ä—ã –≤ –∫–∞–∂–¥–æ–π –∫–æ–º–∞–Ω–¥–µ
- ‚úÖ **Feedback** - –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã "typing", —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- ‚úÖ **Accessibility** - markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üéñÔ∏è –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Best Practices

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–µ–¥—É–µ—Ç –≤—Å–µ–º –ø—Ä–∞–≤–∏–ª–∞–º –∏–∑ Cursor Rules v2.2:

1. ‚úÖ **Async everywhere** - httpx, asyncio.gather
2. ‚úÖ **Error handling** - try-except, graceful fallback
3. ‚úÖ **Type hints** - Optional[Dict], List[str]
4. ‚úÖ **Logging** - logger.info/error —Å context
5. ‚úÖ **Documentation** - docstrings, markdown docs
6. ‚úÖ **Security** - –ø—Ä–æ–≤–µ—Ä–∫–∞ auth, –≤–∞–ª–∏–¥–∞—Ü–∏—è input
7. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞** - –º–µ—Ç–æ–¥—ã –≤ –∫–ª–∞—Å—Å–µ, clean code
8. ‚úÖ **Integration** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å RAG API

---

## üìû Support

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:**
   ```bash
   docker logs telethon-bot
   docker logs rag-service
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:**
   - `BOT_RAG_COMMANDS.md` - –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥
   - `TESTING_GUIDE.md` - —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - Troubleshooting —Å–µ–∫—Ü–∏–∏ –≤ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–∞—Ö

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:**
   ```bash
   docker ps | grep -E "telethon|rag-service|qdrant|redis"
   curl http://localhost:8020/health
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
   ```bash
   docker exec telethon-bot env | grep RAG
   docker exec telethon-bot env | grep CRAWL4AI
   docker exec telethon-bot env | grep SEARXNG
   ```

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Å–µ –∑–∞–¥–∞—á–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø–ª–∞–Ω—É:**

‚úÖ 4 –Ω–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞  
‚úÖ –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ —Å—Å—ã–ª–∫–∞–º–∏  
‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö edge cases  
‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è  
‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î  
‚úÖ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é  

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!**

---

**–í–µ—Ä—Å–∏—è:** 2.2.1  
**–ü—Ä–æ–µ–∫—Ç:** Telegram Channel Parser + RAG System  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Ready for Testing

