# –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø–æ —É—Ä–æ–≤–Ω—é –ø–æ–¥–ø–∏—Å–∫–∏
- –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–¥–ø–∏—Å–æ–∫

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –¢–∞–±–ª–∏—Ü—ã –ë–î

#### 1. Users - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

**–ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫:**

```python
role = Column(String, default="user")  # admin, user
subscription_type = Column(String, default="free")  # free, trial, basic, premium, enterprise
subscription_expires = Column(DateTime, nullable=True)
subscription_started_at = Column(DateTime, nullable=True)
max_channels = Column(Integer, default=3)
invited_by = Column(Integer, ForeignKey("users.id"), nullable=True)
```

**–ú–µ—Ç–æ–¥—ã:**

```python
user.check_subscription_active() -> bool  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏
user.is_admin() -> bool                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
user.can_add_channel() -> bool             # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∫–∞–Ω–∞–ª–æ–≤
```

#### 2. InviteCode - –∏–Ω–≤–∞–π—Ç –∫–æ–¥—ã

```python
class InviteCode(Base):
    code = Column(String, primary_key=True)  # INVITE2024ABC
    created_by = Column(Integer, ForeignKey("users.id"))
    created_at = Column(DateTime)
    
    used_by = Column(Integer, ForeignKey("users.id"), nullable=True)
    used_at = Column(DateTime, nullable=True)
    
    expires_at = Column(DateTime)
    max_uses = Column(Integer, default=1)
    uses_count = Column(Integer, default=0)
    
    default_subscription = Column(String, default="free")
    default_trial_days = Column(Integer, default=0)
```

**–ú–µ—Ç–æ–¥—ã:**

```python
InviteCode.generate_code() -> str  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∫–æ–¥–∞
invite.is_valid() -> bool          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
invite.use(user_id) -> bool        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
```

#### 3. SubscriptionHistory - –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

```python
class SubscriptionHistory(Base):
    user_id = Column(Integer, ForeignKey("users.id"))
    action = Column(String)  # created, upgraded, downgraded, renewed, expired, revoked
    old_type = Column(String, nullable=True)
    new_type = Column(String)
    changed_by = Column(Integer, ForeignKey("users.id"), nullable=True)
    changed_at = Column(DateTime)
    notes = Column(Text, nullable=True)
```

## üíé –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (subscription_config.py)

```python
SUBSCRIPTION_TIERS = {
    "free": {
        "name": "Free",
        "max_channels": 3,
        "max_posts_per_day": 100,
        "rag_queries_per_day": 10,
        "ai_digest": False,
        "priority_parsing": False,
        "price_rub": 0
    },
    "trial": {
        "name": "Trial (7 –¥–Ω–µ–π)",
        "max_channels": 10,
        "max_posts_per_day": 500,
        "rag_queries_per_day": 50,
        "ai_digest": True,
        "priority_parsing": True,
        "duration_days": 7
    },
    # ... basic, premium, enterprise
}
```

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤

| –¢–∞—Ä–∏—Ñ | –ö–∞–Ω–∞–ª—ã | –ü–æ—Å—Ç—ã/–¥–µ–Ω—å | RAG/–¥–µ–Ω—å | AI-–¥–∞–π–¥–∂–µ—Å—Ç—ã | –¶–µ–Ω–∞ |
|-------|--------|------------|----------|--------------|------|
| **Free** | 3 | 100 | 10 | ‚ùå | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ |
| **Trial** | 10 | 500 | 50 | ‚úÖ | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ (7 –¥–Ω) |
| **Basic** | 10 | 500 | 50 | ‚úÖ | 500‚ÇΩ/–º–µ—Å |
| **Premium** | 50 | 2000 | 200 | ‚úÖ | 1500‚ÇΩ/–º–µ—Å |
| **Enterprise** | 999 | 99999 | 999 | ‚úÖ | 5000‚ÇΩ/–º–µ—Å |

## üé´ –†–∞–±–æ—Ç–∞ —Å –∏–Ω–≤–∞–π—Ç –∫–æ–¥–∞–º–∏

### –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–¥–∞ (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

```bash
# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é
/admin_invite

# –ü—Ä–æ—Ü–µ—Å—Å:
1. –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø –ø–æ–¥–ø–∏—Å–∫–∏: Trial, Basic, Premium, Enterprise, Free
2. –í—ã–±—Ä–∞—Ç—å —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞: 1 –¥–µ–Ω—å, 7 –¥–Ω–µ–π, 30 –¥–Ω–µ–π, –±–µ–∑ —Å—Ä–æ–∫–∞
3. –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥: TRIAL7ABC123
```

**–ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ:**

```python
from models import InviteCode
from datetime import datetime, timedelta, timezone

db = SessionLocal()

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞
code = InviteCode.generate_code()  # XYZABC123456

# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–∞–π—Ç–∞
invite = InviteCode(
    code=code,
    created_by=admin_user.id,
    created_at=datetime.now(timezone.utc),
    expires_at=datetime.now(timezone.utc) + timedelta(days=30),
    max_uses=1,
    default_subscription="trial",
    default_trial_days=7
)

db.add(invite)
db.commit()
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

```bash
/login TRIAL7ABC123
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
2. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–æ–º–µ—Ä + SMS)
3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
4. –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–¥–∞ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–≥–æ

## üë• –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### Admin (–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–∞–π—Ç –∫–æ–¥–æ–≤ (`/admin_invite`)
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (`/admin_users`)
- –ü—Ä–æ—Å–º–æ—Ç—Ä –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (`/admin_user`)
- –í—ã–¥–∞—á–∞/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ (`/admin_grant`)
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (`/admin_stats`)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (–ø–µ—Ä–≤—ã–π ID –∏–∑ `ADMIN_TELEGRAM_IDS`):

```bash
python scripts/migrations/add_roles_and_subscriptions.py
```

–í—Ä—É—á–Ω—É—é –≤ –ë–î:

```sql
UPDATE users SET role = 'admin' WHERE telegram_id = 123456789;
```

### User (–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –∏–Ω–≤–∞–π—Ç –∫–æ–¥
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–∞)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–¥–ø–∏—Å–∫–µ
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–µ–π –ø–æ–¥–ø–∏—Å–∫–∏ (`/subscription`)

## üîê –ü—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: Invite-only (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

`.env`:
```env
REGISTRATION_MODE=invite
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–µ—Ç –∏–Ω–≤–∞–π—Ç —á–µ—Ä–µ–∑ `/admin_invite`
2. –ê–¥–º–∏–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `/login INVITE_CODE`
4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

### –í–∞—Ä–∏–∞–Ω—Ç 2: Open (–æ—Ç–∫—Ä—ã—Ç–∞—è)

`.env`:
```env
REGISTRATION_MODE=open
DEFAULT_SUBSCRIPTION=free
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `/login` –±–µ–∑ –∫–æ–¥–∞
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É `free`

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤

### –í –∫–æ–¥–µ –±–æ—Ç–∞

–ü–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –ª–∏–º–∏—Ç:

```python
async def add_channel_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    db_user = get_user(update.effective_user.id)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –∫–∞–Ω–∞–ª–æ–≤
    if not db_user.can_add_channel():
        tier = get_subscription_info(db_user.subscription_type)
        await update.message.reply_text(
            f"‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∫–∞–Ω–∞–ª–æ–≤: {db_user.max_channels}\n"
            f"–¢–µ–∫—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞: {tier['name']}\n"
            f"–î–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"
        )
        return
    
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞...
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:

```python
if user.subscription_expires and user.subscription_expires < datetime.now(timezone.utc):
    # Downgrade –¥–æ free
    user.subscription_type = "free"
    user.max_channels = 3
    db.commit()
```

## üëë –ê–¥–º–∏–Ω –∫–æ–º–∞–Ω–¥—ã

### /admin_invite - –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–≤–∞–π—Ç –∫–æ–¥–∞

**–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é:**

1. –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ–¥–ø–∏—Å–∫–∏
2. –í—ã–±–æ—Ä —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∫–æ–¥–∞
3. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
‚úÖ –ò–Ω–≤–∞–π—Ç –∫–æ–¥ —Å–æ–∑–¥–∞–Ω!

üé´ –ö–æ–¥: TRIAL7ABC123

üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
‚Ä¢ –ü–æ–¥–ø–∏—Å–∫–∞: Trial (7 –¥–Ω–µ–π)
‚Ä¢ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: 19.10.2025 18:00
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: 0/1

üí° –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
/login TRIAL7ABC123
```

### /admin_users [filter] - –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

**–§–∏–ª—å—Ç—Ä—ã:**
- `all` - –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `active` - —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ
- `expired` - —Å –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π
- `free`, `premium` - –ø–æ —Ç–∏–ø—É –ø–æ–¥–ø–∏—Å–∫–∏

**–ü—Ä–∏–º–µ—Ä:**

```bash
/admin_users premium

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (premium)

üë§ ‚úÖ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (@ivan)
   ID: 123456789
   –ü–æ–¥–ø–∏—Å–∫–∞: premium
   –î–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è: 25 –¥–Ω.

üë§ ‚úÖ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤ (@petr)
   ID: 987654321
   –ü–æ–¥–ø–∏—Å–∫–∞: premium
   –î–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è: 10 –¥–Ω.
```

### /admin_user <telegram_id> - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∏–º—è, username, –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- –ü–æ–¥–ø–∏—Å–∫–∞ –∏ —Å—Ç–∞—Ç—É—Å
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (–∫–∞–Ω–∞–ª—ã, –ø–æ—Å—Ç—ã)
- –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- –ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–¥–ø–∏—Å–æ–∫

**–ü—Ä–∏–º–µ—Ä:**

```bash
/admin_user 123456789

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
üÜî Telegram ID: 123456789
üë§ Username: @ivan
üìÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è: 01.10.2025

üìä –ü–æ–¥–ø–∏—Å–∫–∞: Premium
üìç –°—Ç–∞—Ç—É—Å: ‚úÖ –ê–∫—Ç–∏–≤–Ω–∞
‚è∞ –î–æ: 01.11.2025

üìà –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
‚Ä¢ –ö–∞–Ω–∞–ª–æ–≤: 15/50
‚Ä¢ –ü–æ—Å—Ç–æ–≤: 1234

üîê –°—Ç–∞—Ç—É—Å:
‚Ä¢ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ‚úÖ
‚Ä¢ –†–æ–ª—å: user
‚Ä¢ –ü—Ä–∏–≥–ª–∞—à–µ–Ω: Admin (987654321)

üìú –ò—Å—Ç–æ—Ä–∏—è –ø–æ–¥–ø–∏—Å–æ–∫:
‚Ä¢ upgraded: free ‚Üí premium (15.10.2025)
‚Ä¢ created: free (01.10.2025)
```

### /admin_grant <telegram_id> <subscription> [days] - –í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
# Trial –Ω–∞ 7 –¥–Ω–µ–π
/admin_grant 123456789 trial 7

# Premium –Ω–∞ –º–µ—Å—è—Ü
/admin_grant 123456789 premium 30

# Enterprise –Ω–∞ –≥–æ–¥
/admin_grant 123456789 enterprise 365
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
1. –û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è `subscription_type`
2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `subscription_expires`
3. –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ª–∏–º–∏—Ç—ã (`max_channels`)
4. –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ `subscription_history`
5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (TODO: –¥–æ–±–∞–≤–∏—Ç—å)

### /admin_stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:**
- –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ø–æ–¥–ø–∏—Å–∫–∞–º
- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –∏–Ω–≤–∞–π—Ç–æ–≤

**–ü—Ä–∏–º–µ—Ä:**

```
üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞

üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
‚Ä¢ –í—Å–µ–≥–æ: 42
‚Ä¢ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ: 35

üíé –ü–æ–¥–ø–∏—Å–∫–∏:
‚Ä¢ Free: 20
‚Ä¢ Trial (7 –¥–Ω–µ–π): 5
‚Ä¢ Basic: 8
‚Ä¢ Premium: 7
‚Ä¢ Enterprise: 2

‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫: 22

üé´ –ò–Ω–≤–∞–π—Ç –∫–æ–¥—ã:
‚Ä¢ –í—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ: 50
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: 42
```

## üîÑ Lifecycle –ø–æ–¥–ø–∏—Å–∫–∏

### 1. –°–æ–∑–¥–∞–Ω–∏–µ (—á–µ—Ä–µ–∑ –∏–Ω–≤–∞–π—Ç)

```
–ê–¥–º–∏–Ω: /admin_invite
  ‚Üí –°–æ–∑–¥–∞–µ—Ç –∫–æ–¥ TRIAL7ABC123 (trial, 7 –¥–Ω–µ–π)
  
User: /login TRIAL7ABC123
  ‚Üí –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è trial –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ 7 –¥–Ω–µ–π
  ‚Üí subscription_type = "trial"
  ‚Üí subscription_expires = now + 7 days
  ‚Üí max_channels = 10
```

### 2. –ê–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

```
User: /add_channel @channel
  ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞: can_add_channel() ‚úÖ
  ‚Üí –ö–∞–Ω–∞–ª –¥–æ–±–∞–≤–ª–µ–Ω
```

### 3. –ò—Å—Ç–µ—á–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

```
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ:

if subscription_expires < now():
    subscription_type = "free"
    max_channels = 3
    # –ï—Å–ª–∏ –∫–∞–Ω–∞–ª–æ–≤ > 3, –æ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏
```

### 4. Upgrade –ø–æ–¥–ø–∏—Å–∫–∏

```
–ê–¥–º–∏–Ω: /admin_grant 123456789 premium 30

–ò—Å—Ç–æ—Ä–∏—è:
- action: "upgraded"
- old_type: "trial"
- new_type: "premium"
- changed_by: admin_id
- notes: "Granted by admin for 30 days"
```

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ:**

```python
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ
posts = db.query(Post).filter(Post.user_id == current_user.id).all()

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
posts = db.query(Post).all()  # –í–µ—Ä–Ω–µ—Ç –¥–∞–Ω–Ω—ã–µ –í–°–ï–•!
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ª–∏–º–∏—Ç–æ–≤

**–ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ –±–æ—Ç–∞:**

```python
if len(user.channels) >= user.max_channels:
    raise LimitExceededError("Channel limit reached")
```

**–ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ API:**

```python
@app.post("/channels")
async def add_channel(channel_id: int, user_id: int):
    user = db.query(User).filter(User.id == user_id).first()
    
    if not user.can_add_channel():
        raise HTTPException(403, "Channel limit exceeded")
    
    # ...
```

### –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:

```python
history = SubscriptionHistory(
    user_id=user.id,
    action="upgraded",
    old_type="free",
    new_type="premium",
    changed_by=admin.id,
    notes="Monthly payment"
)
db.add(history)
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫

```python
# –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
active = db.query(User).filter(
    User.subscription_expires > datetime.now(timezone.utc),
    User.subscription_type != "free"
).count()

# Revenue forecast (–º–µ—Å—è—Ü)
premium_count = db.query(User).filter(User.subscription_type == "premium").count()
basic_count = db.query(User).filter(User.subscription_type == "basic").count()

revenue = (premium_count * 1500) + (basic_count * 500)
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏—Å—Ç–µ—á–µ–Ω–∏–∏

**TODO (–±—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å):**

```python
# –ó–∞ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
if days_until_expiry == 3:
    await bot.send_message(
        user.telegram_id,
        "‚è∞ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ Premium –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑ 3 –¥–Ω—è!\n\n"
        "–î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
    )
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã
ADMIN_TELEGRAM_IDS=123456789,987654321

# –†–µ–∂–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
REGISTRATION_MODE=invite  # invite –∏–ª–∏ open

# –î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
DEFAULT_SUBSCRIPTION=free
DEFAULT_MAX_CHANNELS=3
TRIAL_DURATION_DAYS=7
```

### –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–≤

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `subscription_config.py`:

```python
SUBSCRIPTION_TIERS = {
    "premium": {
        "max_channels": 100,  # –ë—ã–ª–æ 50
        "price_rub": 2000,    # –ë—ã–ª–æ 1500
        # ...
    }
}
```

**–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
2. –ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –±—É–¥—É—Ç —Å –Ω–æ–≤—ã–º–∏ –ª–∏–º–∏—Ç–∞–º–∏
3. –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç —Å—Ç–∞—Ä—ã–µ –ª–∏–º–∏—Ç—ã –¥–æ renewal

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω–≤–∞–π—Ç–∞

```bash
# –ö–∞–∫ –∞–¥–º–∏–Ω
/admin_invite
  ‚Üí Trial (7 –¥–Ω–µ–π)
  ‚Üí 1 –¥–µ–Ω—å
  ‚Üí –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ TEST123ABC
```

### –¢–µ—Å—Ç–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```bash
# –ö–∞–∫ –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
/login TEST123ABC
  ‚Üí +79991234567
  ‚Üí 12345
  ‚Üí ‚úÖ –£—Å–ø–µ—à–Ω–æ
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤

```bash
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–∏—Ç—å 11 –∫–∞–Ω–∞–ª–æ–≤ —Å trial –ø–æ–¥–ø–∏—Å–∫–æ–π (–ª–∏–º–∏—Ç 10)
/add_channel @channel1
...
/add_channel @channel10  # ‚úÖ OK
/add_channel @channel11  # ‚ùå –õ–∏–º–∏—Ç
```

## üìö API Endpoints

### GET /users/{user_id}/subscription

–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ:

```json
{
  "subscription_type": "premium",
  "tier_name": "Premium",
  "is_active": true,
  "expires_at": "2025-11-01T00:00:00Z",
  "days_remaining": 25,
  "limits": {
    "max_channels": 50,
    "max_posts_per_day": 2000,
    "rag_queries_per_day": 200
  },
  "usage": {
    "channels_count": 15,
    "posts_today": 234
  }
}
```

### POST /admin/grant_subscription

–í—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤):

```json
{
  "user_id": 123456789,
  "subscription_type": "premium",
  "duration_days": 30
}
```

## üÜò Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª

**–ü—Ä–∏—á–∏–Ω–∞:** –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É: `/subscription`
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–Ω–∞–ª–æ–≤: `/my_channels`
3. –û–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –∞–¥–º–∏–Ω—É –¥–ª—è upgrade

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞

**–ü—Ä–∏—á–∏–Ω–∞:** `subscription_expires < now()`

**–†–µ—à–µ–Ω–∏–µ:**
1. –ê–¥–º–∏–Ω –≤—ã–¥–∞–µ—Ç –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É: `/admin_grant <id> premium 30`
2. –ò–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç (–±—É–¥—É—â–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

### –ü—Ä–æ–±–ª–µ–º–∞: –ò–Ω–≤–∞–π—Ç –∫–æ–¥ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –∏–ª–∏ –∏—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ê–¥–º–∏–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –≤ –ë–î
2. –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –∫–æ–¥: `/admin_invite`

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è](../quickstart/SIMPLE_LOGIN.md)
- [–ê–¥–º–∏–Ω –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](../../ADMIN_QUICKSTART.md)
- [Shared Credentials](SHARED_CREDENTIALS.md)
- [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](README_SECURE.md)

