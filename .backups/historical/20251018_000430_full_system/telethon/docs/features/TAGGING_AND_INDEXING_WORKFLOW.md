# üè∑Ô∏è Workflow –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ü–æ—Å—Ç–æ–≤

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 11 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π workflow –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ—Å—Ç–æ–≤ –æ—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.

---

## üîÑ –û–±—â–∏–π Workflow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –ü–∞—Ä—Å–µ—Ä        ‚îÇ
‚îÇ  (–∫–∞–∂–¥—ã–µ 30–º)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ù–æ–≤—ã–µ –ø–æ—Å—Ç—ã    ‚îÇ
‚îÇ  —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  (GigaChat/     ‚îÇ           ‚îÇ Retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
‚îÇ   OpenRouter)   ‚îÇ           ‚îÇ (max 5 –ø–æ–ø—ã—Ç–æ–∫)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ
         ‚îÇ                    ‚îÇ
         ‚ñº                    ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê           ‚îÇ
‚îÇ –¢–µ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  –≤ Post.tags    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HTTP –∑–∞–ø—Ä–æ—Å –∫   ‚îÇ
‚îÇ  RAG-—Å–µ—Ä–≤–∏—Å—É    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ /rag/index/batch‚îÇ           ‚îÇ Retry 3 –ø–æ–ø—ã—Ç–∫–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò           ‚îÇ (2/4/6 —Å–µ–∫)
         ‚îÇ                    ‚îÇ
         ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ –ï—Å–ª–∏ –≤—Å–µ retry –Ω–µ—É–¥–∞—á–Ω—ã
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –°—Ç–∞—Ç—É—Å: pending ‚îÇ
‚îÇ –≤ IndexingStatus‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RAG-—Å–µ—Ä–≤–∏—Å:     ‚îÇ
‚îÇ - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è     ‚îÇ
‚îÇ   embeddings    ‚îÇ
‚îÇ   (GigaChat)    ‚îÇ
‚îÇ - Chunking –¥–ª—è  ‚îÇ
‚îÇ   –¥–ª–∏–Ω–Ω—ã—Ö       ‚îÇ
‚îÇ - –ó–∞–ø–∏—Å—å –≤      ‚îÇ
‚îÇ   Qdrant        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è      ‚îÇ
‚îÇ –∑–∞–≤–µ—Ä—à–µ–Ω–∞       ‚îÇ
‚îÇ (success/failed)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –°–∏—Å—Ç–µ–º—ã

### 1. **ParserService** (`parser_service.py`)

**–ó–∞–¥–∞—á–∏:**
- –ü–∞—Ä—Å–∏–Ω–≥ –∫–∞–Ω–∞–ª–æ–≤ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ –ë–î
- –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ RAG-—Å–µ—Ä–≤–∏—Å–∞ –æ –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–∞—Ö

**–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:**
```python
async def parse_all_channels()
    # –ü–∞—Ä—Å–∏—Ç –∫–∞–Ω–∞–ª—ã –≤—Å–µ—Ö –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    # –°–æ–±–∏—Ä–∞–µ—Ç ID –Ω–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ self.new_post_ids

async def _tag_new_posts_background()
    # 1. –í—ã–∑—ã–≤–∞–µ—Ç TaggingService –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–≥–æ–≤
    # 2. –í—ã–∑—ã–≤–∞–µ—Ç _notify_rag_service –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏

async def _notify_rag_service(post_ids: List[int])
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP POST –Ω–∞ /rag/index/batch
    # Retry: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    # Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ IndexingStatus —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'pending'
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```env
PARSER_INTERVAL_MINUTES=30
RAG_SERVICE_URL=http://rag-service:8020
RAG_SERVICE_ENABLED=true
```

---

### 2. **TaggingService** (`tagging_service.py`)

**–ó–∞–¥–∞—á–∏:**
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ—Å—Ç–∞ —á–µ—Ä–µ–∑ AI
- –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä: GigaChat (GigaChat-Lite)
- Fallback –ø—Ä–æ–≤–∞–π–¥–µ—Ä: OpenRouter (–ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö GigaChat)
- Retry –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫

**Workflow —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**

```python
async def generate_tags_for_text(text: str) -> List[str]
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞ (–º–∏–Ω 10 —Å–∏–º–≤–æ–ª–æ–≤)
    # 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
    # 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ GigaChat API
    # 4. –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞ (—É–ª—É—á—à–µ–Ω–Ω—ã–π regex)
    # 5. –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ —Ç–µ–≥–æ–≤:
    #    - –£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
    #    - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã (2-50 —Å–∏–º–≤–æ–ª–æ–≤)
    #    - Lowercase –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
    # 6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –º–∞–∫—Å–∏–º—É–º 7 —Ç–µ–≥–æ–≤

async def update_post_tags(post_id: int) -> bool
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞ –ø–æ–ø—ã—Ç–æ–∫ (max 5)
    # 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤
    # 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Post.tags –≤ –ë–î
    # 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (success/failed/retrying)
```

**–°—Ç–∞—Ç—É—Å—ã —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**
- `pending` - –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `success` - —Ç–µ–≥–∏ —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã
- `failed` - –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã
- `retrying` - –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ retry

**–ü–æ–ª—è –≤ –º–æ–¥–µ–ª–∏ Post:**
```python
tags = Column(JSON, nullable=True)  # ["—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏", "AI", "–Ω–æ–≤–æ—Å—Ç–∏"]
tagging_status = Column(String, default="pending")
tagging_attempts = Column(Integer, default=0)
last_tagging_attempt = Column(DateTime, nullable=True)
tagging_error = Column(Text, nullable=True)
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```env
TAGGING_PROVIDER=gigachat  # gigachat –∏–ª–∏ openrouter
TAGGING_FALLBACK_OPENROUTER=true
GIGACHAT_PROXY_URL=http://gpt2giga-proxy:8090
GIGACHAT_MODEL=GigaChat-Lite
OPENROUTER_API_KEY=sk-...
OPENROUTER_MODEL=google/gemini-2.0-flash-exp:free
TAGGING_BATCH_SIZE=10
TAGGING_MAX_RETRIES=3
TAGGING_MAX_ATTEMPTS=5
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**

**‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ #1: –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON**
- **–ë—ã–ª–æ:** –ñ–∞–¥–Ω—ã–π regex `r'\[.*\]'` –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–ª –æ—Ç –ø–µ—Ä–≤–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π `]`
- **–°—Ç–∞–ª–æ:** –ù–µ–∂–∞–¥–Ω—ã–π regex `r'\[.*?\]'` –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å `repr()` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

**‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ #2: –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–µ–≥–æ–≤**
- **–î–æ–±–∞–≤–ª–µ–Ω–æ:** Set –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã —Ç–µ–≥–∞ (2-50 —Å–∏–º–≤–æ–ª–æ–≤)
- **–û—á–∏—Å—Ç–∫–∞:** Lowercase –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ trim

---

### 3. **RAG Service** (–í–µ–∫—Ç–æ—Ä–Ω–∞—è –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è)

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `indexer.py` - IndexerService –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏
- `embeddings.py` - EmbeddingsService –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–µ–∫—Ç–æ—Ä–æ–≤
- `vector_db.py` - QdrantClient –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Qdrant
- `main.py` - FastAPI endpoints

**Workflow –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:**

```python
async def index_post(post_id: int)
    # 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –∏–∑ –ë–î
    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–µ–∫—Å—Ç–∞
    # 3. Chunking –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω—ã–π (>1536 —Ç–æ–∫–µ–Ω–æ–≤)
    # 4. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è embeddings (GigaChat)
    # 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Qdrant —Å payload:
    #    - post_id, text, channel_id, tags
    #    - posted_at, url, views
    #    - chunk_index, embedding_provider
    # 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IndexingStatus
```

**–ú–æ–¥–µ–ª—å IndexingStatus:**
```python
user_id = Column(Integer, ForeignKey("users.id"))
post_id = Column(Integer, ForeignKey("posts.id"))
indexed_at = Column(DateTime)
vector_id = Column(String)  # UUID –≤ Qdrant
status = Column(String)  # success, failed, pending
error = Column(Text)
```

**API Endpoints:**

| Endpoint | –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-------|----------|
| `/rag/index/post/{post_id}` | POST | –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω –ø–æ—Å—Ç |
| `/rag/index/batch` | POST | Batch –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ |
| `/rag/index/user/{user_id}` | POST | –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `/rag/reindex/user/{user_id}` | POST | –ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (–≤–∫–ª—é—á–∞—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ) |
| **`/rag/retry/pending`** | POST | **Retry –¥–ª—è pending/failed –ø–æ—Å—Ç–æ–≤** ‚ú® |
| `/rag/stats/{user_id}` | GET | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ |
| `/rag/search` | GET | –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º |

**‚ú® –ù–æ–≤—ã–π endpoint: `/rag/retry/pending`**

```bash
# Retry –≤—Å–µ—Ö pending –ø–æ—Å—Ç–æ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl -X POST "http://localhost:8020/rag/retry/pending?user_id=6&limit=100"

# Retry –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
curl -X POST "http://localhost:8020/rag/retry/pending?limit=100"
```

**–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```env
QDRANT_URL=http://qdrant:6333
GIGACHAT_PROXY_URL=http://gpt2giga-proxy:8090
EMBEDDING_MAX_TOKENS_GIGACHAT=1536
EMBEDDING_OVERLAP_TOKENS_GIGACHAT=256
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

### **–ü—Ä–æ–±–ª–µ–º–∞ #3: –°–ª–∞–±–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ RAG-—Å–µ—Ä–≤–∏—Å–∞**

**–ë—ã–ª–æ:**
```python
except Exception as e:
    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–µ–¥–æ–º–∏—Ç—å RAG-—Å–µ—Ä–≤–∏—Å: {e}")
    # –ü–æ—Å—Ç—ã –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
```

**–°—Ç–∞–ª–æ:**
```python
# 1. Retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π (3 –ø–æ–ø—ã—Ç–∫–∏)
for attempt in range(max_retries):
    try:
        response = await client.post(...)
        if response.status_code == 200:
            return  # –£—Å–ø–µ—Ö
        elif response.status_code >= 500:
            # Server error - retry
            await asyncio.sleep(retry_delay * (attempt + 1))
            continue
    except (httpx.TimeoutException, httpx.ConnectError):
        # Retry –ø—Ä–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö
        ...

# 2. Fallback: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ IndexingStatus
for post_id in post_ids:
    status = IndexingStatus(
        user_id=post.user_id,
        post_id=post_id,
        status="pending",
        error="RAG service unavailable during parsing"
    )
    db.add(status)
db.commit()
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ü–æ—Å—Ç—ã –Ω–µ —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ RAG-—Å–µ—Ä–≤–∏—Å–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry —á–µ—Ä–µ–∑ endpoint `/rag/retry/pending`
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –û—Ç–ª–∞–¥–∫–∞

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**

```sql
-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
SELECT 
    tagging_status,
    COUNT(*) as count,
    AVG(tagging_attempts) as avg_attempts
FROM posts
WHERE user_id = 6
GROUP BY tagging_status;
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:**

```bash
# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl http://localhost:8020/rag/stats/6
```

```json
{
  "user_id": 6,
  "collection_name": "telegram_posts_6",
  "vectors_count": 150,
  "points_count": 150,
  "indexed_posts": 145,
  "pending_posts": 5,
  "failed_posts": 0
}
```

### **–õ–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:**

**–¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```bash
docker logs telethon 2>&1 | grep TaggingService | tail -50
```

**–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è:**
```bash
docker logs rag-service 2>&1 | grep indexer | tail -50
```

---

## üöÄ –†—É—á–Ω–∞—è –û–±—Ä–∞–±–æ—Ç–∫–∞

### **Retry –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ —Ç–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:**

```python
# –ß–µ—Ä–µ–∑ API
curl -X POST "http://localhost:8010/tags/retry_failed?user_id=6&limit=50"
```

### **Retry –Ω–µ—É–¥–∞—á–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏:**

```bash
# –í—Å–µ pending –ø–æ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl -X POST "http://localhost:8020/rag/retry/pending?user_id=6"

# –í—Å–µ pending –ø–æ—Å—Ç—ã –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
curl -X POST "http://localhost:8020/rag/retry/pending"
```

### **–ü–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤:**

```bash
curl -X POST "http://localhost:8020/rag/reindex/user/6"
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### **–î–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫:**

```env
# –£–≤–µ–ª–∏—á–∏—Ç—å batch size
TAGGING_BATCH_SIZE=20
EMBEDDING_BATCH_SIZE=50

# –£–º–µ–Ω—å—à–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–∞—Ä—Å–∏–Ω–≥–∞
PARSER_INTERVAL_MINUTES=15

# –£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
TAGGING_MAX_ATTEMPTS=10
```

### **–î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:**

```env
# –£–º–µ–Ω—å—à–∏—Ç—å batch size
TAGGING_BATCH_SIZE=5

# –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø–∞—Ä—Å–∏–Ω–≥–∞
PARSER_INTERVAL_MINUTES=60

# –û—Ç–∫–ª—é—á–∏—Ç—å RAG-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é (—Ç–æ–ª—å–∫–æ —Ç–µ–≥–∏)
RAG_SERVICE_ENABLED=false
```

---

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –†–µ—Å—É—Ä—Å—ã

- [API –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../README.md)
- [RAG System Guide](./rag/AI_DIGEST_GUIDE.md)
- [Tagging Service Changelog](../CHANGELOG_TAGGING.md)
- [Troubleshooting](../troubleshooting/GIGACHAT_PRO_FIX.md)

---

## ‚úÖ Checklist –¥–ª—è Production

- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–±–æ–∏—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ (GigaChat + OpenRouter)
- [ ] RAG-—Å–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω (`/health` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 200)
- [ ] Qdrant –¥–æ—Å—Ç—É–ø–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã
- [ ] –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ `/rag/retry/pending` (cron –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫)
- [ ] –ë—ç–∫–∞–ø—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (SQLite –∏–ª–∏ PostgreSQL)
- [ ] –ë—ç–∫–∞–ø—ã Qdrant –∫–æ–ª–ª–µ–∫—Ü–∏–π

---

**–ê–≤—Ç–æ—Ä:** Telegram Channel Parser Team  
**–û–±–Ω–æ–≤–ª–µ–Ω–æ:** 11 –æ–∫—Ç—è–±—Ä—è 2025

