# LangChain Migration Guide

## –û–±–∑–æ—Ä

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å n8n workflows –Ω–∞ –ø—Ä—è–º—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é LangChain –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤ Telegram –≥—Ä—É–ø–ø.

## –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –ú–∏–≥—Ä–∞—Ü–∏–∏

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ telethon/
pip install langchain>=0.1.0
pip install langchain-core>=0.1.0
pip install langchain-community>=0.0.38
```

### 2. Environment Variables

–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:

```bash
# LangChain Direct Integration
USE_LANGCHAIN_DIRECT=true

# Langfuse –¥–ª—è observability (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
LANGFUSE_PUBLIC_KEY=your_public_key
LANGFUSE_SECRET_KEY=your_secret_key
LANGFUSE_HOST=https://langfuse.produman.studio

# GigaChat –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö)
GIGACHAT_BASE_URL=http://gpt2giga-proxy:8000/v1
GIGACHAT_TIMEOUT=60.0
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å gpt2giga-proxy
curl http://gpt2giga-proxy:8000/v1/models

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Langfuse (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
curl -H "Authorization: Bearer $LANGFUSE_PUBLIC_KEY" $LANGFUSE_HOST/api/public/health
```

## –ü–æ—à–∞–≥–æ–≤–∞—è –ú–∏–≥—Ä–∞—Ü–∏—è

### –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (5 –º–∏–Ω—É—Ç)

1. **–°–æ–∑–¥–∞—Ç—å backup n8n workflows**:
   ```bash
   # –≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—É—â–∏—Ö workflows
   docker exec n8n n8n export:workflow --all --output=/tmp/n8n-backup.json
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤**:
   ```bash
   ls -la telethon/langchain_agents/
   # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –∞–≥–µ–Ω—Ç–æ–≤
   ```

### –≠—Ç–∞–ø 2: –¢–µ—Å—Ç–æ–≤—ã–π –ó–∞–ø—É—Å–∫ (10 –º–∏–Ω—É—Ç)

1. **–í–∫–ª—é—á–∏—Ç—å LangChain –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:
   ```bash
   export USE_LANGCHAIN_DIRECT=true
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç –≤ debug —Ä–µ–∂–∏–º–µ**:
   ```bash
   cd telethon/
   python bot.py
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏**:
   ```
   üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è LangChain Direct Integration
   ‚úÖ LangChain Orchestrator –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
   ‚úÖ –í—Å–µ –∞–≥–µ–Ω—Ç—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
   ```

### –≠—Ç–∞–ø 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ (15 –º–∏–Ω—É—Ç)

1. **–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –≥—Ä—É–ø–ø—É** —Å –Ω–µ–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π (5-10)

2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–∞–π–¥–∂–µ—Å—Ç–∞** –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
   - –£—Å–ø–µ—à–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö usernames
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Langfuse** (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω):
   - –¢—Ä–µ–π—Å—ã –≤—Å–µ—Ö –∞–≥–µ–Ω—Ç–æ–≤
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫

### –≠—Ç–∞–ø 4: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –í–Ω–µ–¥—Ä–µ–Ω–∏–µ (30 –º–∏–Ω—É—Ç)

1. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
   ```bash
   # –î–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   export USE_LANGCHAIN_DIRECT=true
   
   # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   export USE_LANGCHAIN_DIRECT=false
   ```

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫**:
   - –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–π–¥–∂–µ—Å—Ç–æ–≤
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫
   - –ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

3. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏**:
   - –ù–∞—á–∞—Ç—å —Å 10% –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
   - –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –¥–æ 50%, –∑–∞—Ç–µ–º 100%

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –í–∞–ª–∏–¥–∞—Ü–∏—è

### –ö–ª—é—á–µ–≤—ã–µ –ú–µ—Ç—Ä–∏–∫–∏

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:
   ```bash
   # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
   grep "–î–∞–π–¥–∂–µ—Å—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∑–∞" logs/telethon.log | \
   awk '{print $NF}' | sed 's/s//' | awk '{sum+=$1; count++} END {print sum/count "s"}'
   ```

2. **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å**:
   ```bash
   # –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
   grep -c "‚úÖ.*—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω" logs/telethon.log
   grep -c "‚ùå.*–û—à–∏–±–∫–∞" logs/telethon.log
   ```

3. **–ö–∞—á–µ—Å—Ç–≤–æ**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ HTML –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ usernames
   - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

### Langfuse Dashboard

1. **–û—Ç–∫—Ä—ã—Ç—å Langfuse**: `https://langfuse.produman.studio`

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–µ–π—Å—ã**:
   - Sessions —Å —Ç–µ–≥–æ–º `telegram_bot`
   - –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö 9 –∞–≥–µ–Ω—Ç–æ–≤
   - –í—Ä–µ–º–µ–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

3. **–ê–Ω–∞–ª–∏–∑ –æ—à–∏–±–æ–∫**:
   - Failed traces
   - Timeout issues
   - LLM errors

## Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

#### 1. Import Error: No module named 'langchain'

**–°–∏–º–ø—Ç–æ–º—ã**:
```
‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ LangChain: No module named 'langchain'
üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ n8n fallback
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
pip install langchain langchain-core langchain-community
```

#### 2. GigaChat Connection Error

**–°–∏–º–ø—Ç–æ–º—ã**:
```
‚ùå –û—à–∏–±–∫–∞ GigaChat: Connection refused
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å gpt2giga-proxy
docker ps | grep gpt2giga-proxy

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
docker-compose restart gpt2giga-proxy
```

#### 3. Timeout Issues

**–°–∏–º–ø—Ç–æ–º—ã**:
```
‚è∞ Timeout –∞–≥–µ–Ω—Ç–∞ TopicExtractor (25.0s)
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –£–≤–µ–ª–∏—á–∏—Ç—å timeout –≤ .env
GIGACHAT_TIMEOUT=90.0
AGENT_TIMEOUT=45.0
```

#### 4. Memory Issues

**–°–∏–º–ø—Ç–æ–º—ã**:
```
‚ùå –û—à–∏–±–∫–∞: Out of memory
```

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
export DIGEST_MAX_MESSAGES=100
```

#### 5. HTML Validation Errors

**–°–∏–º–ø—Ç–æ–º—ã**:
```
‚ùå Invalid HTML: <div> not allowed
```

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `supervisor.py` - —Ç–æ–ª—å–∫–æ `<b>`, `<i>`, `<code>`, `<a>` —Ç–µ–≥–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `_sanitize_html()` –º–µ—Ç–æ–¥

### –õ–æ–≥–∏ –¥–ª—è –û—Ç–ª–∞–¥–∫–∏

#### –í–∫–ª—é—á–∏—Ç—å Debug –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
export LOG_LEVEL=DEBUG
```

#### –ö–ª—é—á–µ–≤—ã–µ –õ–æ–≥–∏

```bash
# –£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
grep "LangChain Orchestrator –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω" logs/telethon.log

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤
grep "Phase.*:" logs/telethon.log

# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
grep "–∑–∞–≤–µ—Ä—à–µ–Ω –∑–∞" logs/telethon.log

# –û—à–∏–±–∫–∏
grep "‚ùå" logs/telethon.log
```

## Rollback Plan

### –ë—ã—Å—Ç—Ä—ã–π Rollback (1 –º–∏–Ω—É—Ç–∞)

```bash
# –û—Ç–∫–ª—é—á–∏—Ç—å LangChain
export USE_LANGCHAIN_DIRECT=false

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç
docker-compose restart telethon
```

### –ü–æ–ª–Ω—ã–π Rollback (5 –º–∏–Ω—É—Ç)

1. **–û—Ç–∫–ª—é—á–∏—Ç—å LangChain**:
   ```bash
   export USE_LANGCHAIN_DIRECT=false
   ```

2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å n8n workflows**:
   ```bash
   docker exec n8n n8n import:workflow --input=/tmp/n8n-backup.json
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É n8n**:
   ```bash
   curl http://n8n:5678/health
   ```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –î–∞–Ω–Ω—ã—Ö

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö**:
   ```bash
   # –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å—Ö–µ–º–µ –ë–î
   # –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis**:
   ```bash
   # –ö—ç—à –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º
   # –°–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
   ```

## Post-Migration

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Langfuse**:
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤ –Ω–∞ –æ—à–∏–±–∫–∏
   - –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤

2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤**:
   - CPU usage –∞–≥–µ–Ω—Ç–æ–≤
   - Memory consumption
   - LLM API costs

3. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤**:
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è temperature settings
   - –£–ª—É—á—à–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ Langfuse –¥–∞–Ω–Ω—ã—Ö

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

1. **–û–±–Ω–æ–≤–∏—Ç—å README**:
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ LangChain
   - –û–±–Ω–æ–≤–∏—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã

2. **–°–æ–∑–¥–∞—Ç—å runbooks**:
   - Troubleshooting guide
   - Performance tuning
   - Monitoring procedures

3. **–û–±—É—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã**:
   - LangChain best practices
   - Debugging techniques
   - Performance optimization

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: [—Å—Å—ã–ª–∫–∞ –Ω–∞ —Ç–∏–∫–µ—Ç-—Å–∏—Å—Ç–µ–º—É]
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: [—Å—Å—ã–ª–∫–∞ –Ω–∞ wiki]
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: [—Å—Å—ã–ª–∫–∞ –Ω–∞ dashboard]

### –†–µ—Å—É—Ä—Å—ã

- **LangChain Documentation**: https://python.langchain.com/
- **Langfuse Documentation**: https://langfuse.com/docs
- **GigaChat API**: https://developers.sber.ru/portal/products/gigachat

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **–õ–æ–≥–∏**: `logs/telethon.log`
- **Langfuse**: https://langfuse.produman.studio
- **Prometheus**: http://localhost:9090
- **Grafana**: http://localhost:3000
