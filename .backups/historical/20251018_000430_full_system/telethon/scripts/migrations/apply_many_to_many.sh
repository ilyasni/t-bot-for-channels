#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ Many-to-Many
# 
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   bash apply_many_to_many.sh          # –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
#   bash apply_many_to_many.sh --force  # –ë–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "================================================================"
echo "   –ú–ò–ì–†–ê–¶–ò–Ø –ö MANY-TO-MANY –°–¢–†–£–ö–¢–£–†–ï"
echo "================================================================"
echo ""
echo "–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è —É—Å—Ç—Ä–∞–Ω–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö."
echo ""
echo "üìã –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:"
echo "  1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
echo "  2. –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –ë–î"
echo "  3. –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
echo "  4. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
echo "  5. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è --force —Ñ–ª–∞–≥–∞
FORCE=0
if [ "$1" = "--force" ]; then
    FORCE=1
fi

if [ $FORCE -eq 0 ]; then
    read -p "‚ùì –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
        exit 1
    fi
fi

echo ""
echo "================================================================"
echo "–®–ê–ì 1: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤"
echo "================================================================"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Python —Å–µ—Ä–≤–∏—Å–æ–≤..."
pkill -f "python.*main.py" 2>/dev/null || echo "   main.py –Ω–µ –∑–∞–ø—É—â–µ–Ω"
pkill -f "python.*bot.py" 2>/dev/null || echo "   bot.py –Ω–µ –∑–∞–ø—É—â–µ–Ω"
pkill -f "python.*run_system.py" 2>/dev/null || echo "   run_system.py –Ω–µ –∑–∞–ø—É—â–µ–Ω"

# –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
sleep 2

echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

echo ""
echo "================================================================"
echo "–®–ê–ì 2: –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
echo "================================================================"

if [ -f "telegram.db" ]; then
    BACKUP_NAME="telegram.db.pre_migration_$(date +%Y%m%d_%H%M%S)"
    cp telegram.db "$BACKUP_NAME"
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $BACKUP_NAME"
else
    echo "‚ö†Ô∏è  telegram.db –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∞—è –ë–î)"
fi

echo ""
echo "================================================================"
echo "–®–ê–ì 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
echo "================================================================"

echo "üîÑ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏..."
python3 migrate_to_many_to_many.py

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå –û–®–ò–ë–ö–ê –ú–ò–ì–†–ê–¶–ò–ò!"
    echo ""
    echo "–î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –æ—Ç–∫–∞—Ç–∞:"
    echo "  1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î: cp $BACKUP_NAME telegram.db"
    echo "  2. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã: python3 run_system.py &"
    exit 1
fi

echo ""
echo "================================================================"
echo "–®–ê–ì 4: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
echo "================================================================"

if [ $FORCE -eq 0 ]; then
    read -p "‚ùì –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
        python3 test_many_to_many.py
        if [ $? -ne 0 ]; then
            echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–≤–∞–ª–µ–Ω—ã, –Ω–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ"
            echo "    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–≤–æ–¥ —Ç–µ—Å—Ç–æ–≤ –≤—ã—à–µ"
        fi
    else
        echo "‚è≠Ô∏è  –¢–µ—Å—Ç—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã"
    fi
else
    echo "‚è≠Ô∏è  –¢–µ—Å—Ç—ã –ø—Ä–æ–ø—É—â–µ–Ω—ã (--force —Ä–µ–∂–∏–º)"
fi

echo ""
echo "================================================================"
echo "–®–ê–ì 5: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤"
echo "================================================================"

if [ $FORCE -eq 0 ]; then
    read -p "‚ùì –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        START_SERVICES=1
    else
        START_SERVICES=0
    fi
else
    START_SERVICES=1
fi

if [ $START_SERVICES -eq 1 ]; then
    echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    
    if [ -f "run_system.py" ]; then
        nohup python3 run_system.py > logs/system.log 2>&1 &
        echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã —á–µ—Ä–µ–∑ run_system.py"
    else
        nohup python3 main.py > logs/main.log 2>&1 &
        sleep 2
        nohup python3 bot.py > logs/bot.log 2>&1 &
        echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã (main.py + bot.py)"
    fi
    
    sleep 3
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
    if pgrep -f "python.*main.py" > /dev/null || pgrep -f "python.*run_system.py" > /dev/null; then
        echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç"
    else
        echo "‚ö†Ô∏è  –°–µ—Ä–≤–∏—Å—ã –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏"
    fi
else
    echo "‚è≠Ô∏è  –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –ø—Ä–æ–ø—É—â–µ–Ω"
    echo ""
    echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "  python3 run_system.py &"
    echo "–∏–ª–∏:"
    echo "  python3 main.py & python3 bot.py &"
fi

echo ""
echo "================================================================"
echo "‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!"
echo "================================================================"
echo ""
echo "üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "  sqlite3 telegram.db 'SELECT COUNT(*) FROM channels;'"
echo "  sqlite3 telegram.db 'SELECT COUNT(*) FROM user_channel;'"
echo ""
echo "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
echo "  - MANY_TO_MANY_SUMMARY.md   - –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ"
echo "  - QUICK_MIGRATION.md        - –±—ã—Å—Ç—Ä–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"
echo "  - MIGRATION_MANY_TO_MANY.md - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
echo ""
echo "üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è:"
echo "  $BACKUP_NAME"
echo ""
echo "üîÑ –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ):"
echo "  cp $BACKUP_NAME telegram.db"
echo "  python3 run_system.py &"
echo ""
echo "================================================================"

